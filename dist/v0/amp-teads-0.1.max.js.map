{"version":3,"sources":["node_modules/browserify/node_modules/browser-pack/_prelude.js","ads/_prefetch.js","build/all/v0/amp-teads-0.1.max.js","node_modules/browserify/node_modules/process/browser.js","src/3p-frame.js","src/asserts.js","src/base-element.js","src/custom-element.js","src/document-info.js","src/document-state.js","src/dom.js","src/element-stub.js","src/error.js","src/event-helper.js","src/exponential-backoff.js","src/focus-history.js","src/input.js","src/intersection-observer.js","src/layout-rect.js","src/layout.js","src/loader.js","src/log.js","src/mode.js","src/observable.js","src/pass.js","src/platform.js","src/preconnect.js","src/resources.js","src/service.js","src/size-list.js","src/string.js","src/style.js","src/styles.js","src/timer.js","src/url.js","src/viewer.js","src/viewport.js","src/vsync.js"],"names":[],"mappings":"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","file":"amp-teads-0.1.max.js","sourceRoot":"/source/","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * URLs to prefetch for a given ad type.\n *\n * This MUST be kept in sync with actual implementation.\n *\n * @const {!Object<string, (string|!Array<string>)>}\n */\nexport const adPrefetch = {\n  doubleclick: 'https://www.googletagservices.com/tag/js/gpt.js',\n  a9: 'https://c.amazon-adsystem.com/aax2/assoc.js',\n  adsense: 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js',\n  teads: 'https://cdn.teads.tv/media/format/v3/teads-format.js',\n};\n\n/**\n * URLs to connect to for a given ad type.\n *\n * This MUST be kept in sync with actual implementation.\n *\n * @const {!Object<string, (string|!Array<string>)>}\n */\nexport const adPreconnect = {\n  adreactor: 'https://adserver.adreactor.com',\n  adsense: 'https://googleads.g.doubleclick.net',\n  teads: 'https://cdn.teads.tv',\n  doubleclick: [\n    'https://partner.googleadservices.com',\n    'https://securepubads.g.doubleclick.net',\n    'https://tpc.googlesyndication.com',\n  ],\n};\n","\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from '../../../src/base-element';\nimport {assert} from '../../../src/asserts';\nimport {getIntersectionChangeEntry} from '../../../src/intersection-observer';\nimport {isLayoutSizeDefined} from '../../../src/layout';\nimport {loadPromise} from '../../../src/event-helper';\nimport {registerElement} from '../../../src/custom-element';\nimport {getIframe, listen, listenOnce, postMessage, prefetchBootstrap} from\n    '../../../src/3p-frame';\nimport {adPrefetch, adPreconnect} from '../../../ads/_prefetch';\nimport {timer} from '../../../src/timer';\n\n\nclass AmpTeads extends BaseElement {\n\n  /** @override  */\n  renderOutsideViewport() {\n    return true;\n  }\n\n  prerenderAllowed() {\n    return true;\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return isLayoutSizeDefined(layout);\n  }\n\n  /**\n   * @return {boolean}\n   * @override\n   */\n  isReadyToBuild() {\n    // TODO(dvoytenko, #1014): Review and try a more immediate approach.\n    // Wait until DOMReady.\n    return false;\n  }\n\n  /** @override */\n  buildCallback() {\n    /** @private {?Element} */\n    this.iframe_ = null;\n\n    /** @private {?Element} */\n    this.placeholder_ = this.getPlaceholder();\n\n    /** @private {?Element} */\n    this.fallback_ = this.getFallback();\n\n    /** @private {boolean} */\n    this.isInFixedContainer_ = false;\n\n    /**\n     * The layout box of the ad iframe (as opposed to the amp-ad tag).\n     * In practice it often has padding to create a grey or similar box\n     * around ads.\n     * @private {!LayoutRect}\n     */\n    this.iframeLayoutBox_ = null;\n\n    /**\n     * Call to stop listening to viewport changes.\n     * @private {?function()}\n     */\n    this.unlistenViewportChanges_ = null;\n\n    /** @private {boolean} */\n    this.shouldSendIntersectionChanges_ = false;\n  }\n\n  /**\n   * Prefetches and preconnects URLs related to the ad.\n   * @override\n   */\n  preconnectCallback(onLayout) {\n    // We always need the bootstrap.\n    prefetchBootstrap(this.getWin());\n    const type = this.element.getAttribute('type');\n    const prefetch = adPrefetch[type];\n    const preconnect = adPreconnect[type];\n    if (typeof prefetch == 'string') {\n      this.preconnect.prefetch(prefetch);\n    } else if (prefetch) {\n      prefetch.forEach(p => {\n        this.preconnect.prefetch(p);\n      });\n    }\n    if (typeof preconnect == 'string') {\n      this.preconnect.url(preconnect, onLayout);\n    } else if (preconnect) {\n      preconnect.forEach(p => {\n        this.preconnect.url(p, onLayout);\n      });\n    }\n    // If fully qualified src for ad script is specified we preconnect to it.\n    const src = this.element.getAttribute('src');\n    if (src) {\n      // We only preconnect to the src because we cannot know whether the URL\n      // will have caching headers set.\n      this.preconnect.url(src);\n    }\n  }\n\n  /**\n   * @override\n   */\n  onLayoutMeasure() {\n    this.isInFixedContainer_ = this.isPositionFixed();\n    // We remeasured this tag, lets also remeasure the iframe. Should be\n    // free now and it might have changed.\n    this.measureIframeLayoutBox_();\n  }\n\n  /**\n   * Measure the layout box of the iframe if we rendered it already.\n   * @private\n   */\n  measureIframeLayoutBox_() {\n    if (this.iframe_) {\n      this.iframeLayoutBox_ =\n          this.getViewport().getLayoutRect(this.iframe_);\n    }\n  }\n\n  /**\n   * @return {boolean} whether this element or its ancestors have position\n   * fixed (unless they are POSITION_FIXED_TAG_WHITELIST).\n   * This should only be called when a layout on the page was just forced\n   * anyway.\n   */\n  isPositionFixed() {\n    let el = this.element;\n    const body = el.ownerDocument.body;\n    do {\n      if (this.getWin()/*because only called from onLayoutMeasure */\n          ./*OK*/getComputedStyle(el).position == 'fixed') {\n        return true;\n      }\n      el = el.parentNode;\n    } while (el.getAttribute && el != body);\n    return false;\n  }\n\n\n  /** @override */\n  layoutCallback() {\n    assert(!this.isInFixedContainer_,\n        '<amp-ad> is not allowed to be placed in elements with ' +\n        'position:fixed: %s', this.element);\n    if (!this.iframe_) {\n      this.iframe_ = getIframe(this.element.ownerDocument.defaultView,\n          this.element);\n      this.applyFillContent(this.iframe_);\n      this.element.appendChild(this.iframe_);\n\n      // Triggered by context.noContentAvailable() inside the ad iframe.\n      listenOnce(this.iframe_, 'no-content', () => {\n        this.deferMutate(this.noContentHandler_.bind(this));\n      });\n      // Triggered by context.observeIntersection() inside the ad iframe.\n      // We use listen instead of listenOnce, because a single ad might\n      // have multiple parties wanting to receive viewability data.\n      // The second time this is called, it doesn't do much but it\n      // guarantees that the receiver gets an initial intersection change\n      // record.\n      listen(this.iframe_, 'send-intersections', () => {\n        this.startSendingIntersectionChanges_();\n      });\n    }\n    return loadPromise(this.iframe_);\n  }\n\n  /** @override  */\n  viewportCallback(inViewport) {\n    // Lets the ad know that it became visible or no longer is.\n    this.sendAdIntersection_();\n    // And update the ad about its position in the viewport while\n    // it is visible.\n    if (inViewport) {\n      this.unlistenViewportChanges_ =\n          this.getViewport().onScroll(this.sendAdIntersection_.bind(this));\n    } else if (this.unlistenViewportChanges_) {\n      this.unlistenViewportChanges_();\n      this.unlistenViewportChanges_ = null;\n    }\n  }\n\n  /**\n   * Called via postMessage from the child iframe when the ad starts\n   * observing its position in the viewport.\n   * Sets a flag, measures the iframe position if necessary and sends\n   * one change record to the iframe.\n   * Note that this method may be called more than once if a single ad\n   * has multiple parties interested in viewability data.\n   * @private\n   */\n  startSendingIntersectionChanges_() {\n    this.shouldSendIntersectionChanges_ = true;\n    this.getVsync().measure(() => {\n      if (!this.iframeLayoutBox_) {\n        this.measureIframeLayoutBox_();\n      }\n      this.sendAdIntersection_();\n    });\n  }\n\n  /**\n   * Sends 'intersection' message to ad with intersection change records\n   * if this has been activated and we measured the layout box of the iframe\n   * at least once.\n   * @private\n   */\n  sendAdIntersection_() {\n    if (!this.shouldSendIntersectionChanges_ ||\n        !this.iframeLayoutBox_) {\n      return;\n    }\n    const rootBounds = this.getViewport().getRect();\n    const change = getIntersectionChangeEntry(\n        timer.now(),\n        rootBounds,\n        this.iframeLayoutBox_);\n    postMessage(this.iframe_, 'intersection', {changes: [change]});\n  }\n\n  /**\n   * Activates the fallback if the ad reports that the ad slot cannot\n   * be filled.\n   * @private\n   */\n  noContentHandler_() {\n    this.element.removeChild(this.iframe_);\n    this.toggleFallback(true);\n  }\n}\n\nAMP.registerElement('amp-teads', AmpTeads);\n","// shim for using process in browser\n\nvar process = module.exports = {};\nvar queue = [];\nvar draining = false;\nvar currentQueue;\nvar queueIndex = -1;\n\nfunction cleanUpNextTick() {\n    draining = false;\n    if (currentQueue.length) {\n        queue = currentQueue.concat(queue);\n    } else {\n        queueIndex = -1;\n    }\n    if (queue.length) {\n        drainQueue();\n    }\n}\n\nfunction drainQueue() {\n    if (draining) {\n        return;\n    }\n    var timeout = setTimeout(cleanUpNextTick);\n    draining = true;\n\n    var len = queue.length;\n    while(len) {\n        currentQueue = queue;\n        queue = [];\n        while (++queueIndex < len) {\n            if (currentQueue) {\n                currentQueue[queueIndex].run();\n            }\n        }\n        queueIndex = -1;\n        len = queue.length;\n    }\n    currentQueue = null;\n    draining = false;\n    clearTimeout(timeout);\n}\n\nprocess.nextTick = function (fun) {\n    var args = new Array(arguments.length - 1);\n    if (arguments.length > 1) {\n        for (var i = 1; i < arguments.length; i++) {\n            args[i - 1] = arguments[i];\n        }\n    }\n    queue.push(new Item(fun, args));\n    if (queue.length === 1 && !draining) {\n        setTimeout(drainQueue, 0);\n    }\n};\n\n// v8 likes predictible objects\nfunction Item(fun, array) {\n    this.fun = fun;\n    this.array = array;\n}\nItem.prototype.run = function () {\n    this.fun.apply(null, this.array);\n};\nprocess.title = 'browser';\nprocess.browser = true;\nprocess.env = {};\nprocess.argv = [];\nprocess.version = ''; // empty string to avoid regexp issues\nprocess.versions = {};\n\nfunction noop() {}\n\nprocess.on = noop;\nprocess.addListener = noop;\nprocess.once = noop;\nprocess.off = noop;\nprocess.removeListener = noop;\nprocess.removeAllListeners = noop;\nprocess.emit = noop;\n\nprocess.binding = function (name) {\n    throw new Error('process.binding is not supported');\n};\n\nprocess.cwd = function () { return '/' };\nprocess.chdir = function (dir) {\n    throw new Error('process.chdir is not supported');\n};\nprocess.umask = function() { return 0; };\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\nimport {assert} from './asserts';\nimport {getLengthNumeral} from '../src/layout';\nimport {getService} from './service';\nimport {documentInfoFor} from './document-info';\nimport {getMode} from './mode';\nimport {preconnectFor} from './preconnect';\nimport {dashToCamelCase} from './string';\nimport {parseUrl, assertHttpsUrl} from './url';\n\n\n/** @type {!Object<string,number>} Number of 3p frames on the for that type. */\nconst count = {};\n\n\n/**\n * Produces the attributes for the ad template.\n * @param {!Window} parentWindow\n * @param {!Element} element\n * @param {string=} opt_type\n * @return {!Object} Contains\n *     - type, width, height, src attributes of <amp-ad> tag. These have\n *       precedence over the data- attributes.\n *     - data-* attributes of the <amp-ad> tag with the \"data-\" removed.\n *     - A _context object for internal use.\n */\nfunction getFrameAttributes(parentWindow, element, opt_type) {\n  const width = element.getAttribute('width');\n  const height = element.getAttribute('height');\n  const type = opt_type || element.getAttribute('type');\n  assert(type, 'Attribute type required for <amp-ad>: %s', element);\n  const attributes = {};\n  // Do these first, as the other attributes have precedence.\n  addDataAndJsonAttributes_(element, attributes);\n  attributes.width = getLengthNumeral(width);\n  attributes.height = getLengthNumeral(height);\n  const box = element.getLayoutBox();\n  attributes.initialWindowWidth = box.width;\n  attributes.initialWindowHeight = box.height;\n  attributes.type = type;\n  const docInfo = documentInfoFor(parentWindow);\n  attributes._context = {\n    referrer: parentWindow.document.referrer,\n    canonicalUrl: docInfo.canonicalUrl,\n    pageViewId: docInfo.pageViewId,\n    location: {\n      href: parentWindow.location.href\n    },\n    mode: getMode()\n  };\n  const adSrc = element.getAttribute('src');\n  if (adSrc) {\n    attributes.src = adSrc;\n  }\n  return attributes;\n}\n\n/**\n * Creates the iframe for the embed. Applies correct size and passes the embed\n * attributes to the frame via JSON inside the fragment.\n * @param {!Window} parentWindow\n * @param {!Element} element\n * @param {string=} opt_type\n * @return {!Element} The iframe.\n */\nexport function getIframe(parentWindow, element, opt_type) {\n  const attributes = getFrameAttributes(parentWindow, element, opt_type);\n  const iframe = document.createElement('iframe');\n  if (!count[attributes.type]) {\n    count[attributes.type] = 0;\n  }\n  iframe.name = 'frame_' + attributes.type + '_' + count[attributes.type]++;\n\n  // Pass ad attributes to iframe via the fragment.\n  const src = getBootstrapBaseUrl(parentWindow) + '#' +\n      JSON.stringify(attributes);\n\n  iframe.src = src;\n  iframe.ampLocation = parseUrl(src);\n  iframe.width = attributes.width;\n  iframe.height = attributes.height;\n  iframe.style.border = 'none';\n  iframe.setAttribute('scrolling', 'no');\n  iframe.onload = function() {\n    // Chrome does not reflect the iframe readystate.\n    this.readyState = 'complete';\n  };\n  return iframe;\n}\n\n/**\n * Allows listening for message from the iframe. Returns an unlisten\n * function to remove the listener.\n *\n * @param {!Element} iframe\n * @param {string} typeOfMessage\n * @param {function(!Object)} callback Called when a message of this type\n *     arrives for this iframe.\n * @return {!UnlistenDef}\n */\nexport function listen(iframe, typeOfMessage, callback) {\n  const win = iframe.ownerDocument.defaultView;\n  const origin = iframe.ampLocation.origin;\n  const listener = function(event) {\n    if (event.origin != origin) {\n      return;\n    }\n    if (event.source != iframe.contentWindow) {\n      return;\n    }\n    if (!event.data || event.data.sentinel != 'amp-3p') {\n      return;\n    }\n    if (event.data.type != typeOfMessage) {\n      return;\n    }\n    callback(event.data);\n  };\n\n  win.addEventListener('message', listener);\n\n  return function() {\n    win.removeEventListener('message', listener);\n  };\n}\n\n/**\n * Allows listening for a message from the iframe and then removes the listener\n *\n * @param {!Element} iframe\n * @param {string} typeOfMessage\n * @param {function(!Object)} callback Called when a message of this type\n *     arrives for this iframe.\n * @return {!UnlistenDef}\n */\nexport function listenOnce(iframe, typeOfMessage, callback) {\n  const unlisten = listen(iframe, typeOfMessage, data => {\n    unlisten();\n    return callback(data);\n  });\n  return unlisten;\n}\n\n/**\n * Posts a message to the iframe;\n * @param {!Element} element The 3p iframe.\n * @param {string} type Type of the message.\n * @param {!Object} object Message payload.\n */\nexport function postMessage(iframe, type, object) {\n  object.type = type;\n  object.sentinel = 'amp-3p';\n  iframe.contentWindow./*OK*/postMessage(object, iframe.ampLocation.origin);\n}\n\n/**\n * Copies data- attributes from the element into the attributes object.\n * Removes the data- from the name and capitalizes after -. If there\n * is an attribute called json, parses the JSON and adds it to the\n * attributes.\n * @param {!Element} element\n * @param {!Object} attributes The destination.\n * visibleForTesting\n */\nexport function addDataAndJsonAttributes_(element, attributes) {\n  for (let i = 0; i < element.attributes.length; i++) {\n    const attr = element.attributes[i];\n    if (attr.name.indexOf('data-') != 0) {\n      continue;\n    }\n    attributes[dashToCamelCase(attr.name.substr(5))] = attr.value;\n  }\n  const json = element.getAttribute('json');\n  if (json) {\n    let obj;\n    try {\n      obj = JSON.parse(json);\n    } catch (e) {\n      assert(false, 'Error parsing JSON in json attribute in element %s',\n          element);\n    }\n    for (const key in obj) {\n      attributes[key] = obj[key];\n    }\n  }\n}\n\n/**\n * Prefetches URLs related to the bootstrap iframe.\n * @param {!Window} parentWindow\n * @return {string}\n */\nexport function prefetchBootstrap(window) {\n  const url = getBootstrapBaseUrl(window);\n  const preconnect = preconnectFor(window);\n  preconnect.prefetch(url);\n  // While the URL may point to a custom domain, this URL will always be\n  // fetched by it.\n  preconnect.prefetch(\n      'https://3p.ampproject.net/$internalRuntimeVersion$/f.js');\n}\n\n/**\n * Returns the base URL for 3p bootstrap iframes.\n * @param {!Window} parentWindow\n * @return {string}\n * @visibleForTesting\n */\nexport function getBootstrapBaseUrl(parentWindow) {\n  return getService(window, 'bootstrapBaseUrl', () => {\n    return getCustomBootstrapBaseUrl(parentWindow) ||\n      getDefaultBootstrapBaseUrl(parentWindow);\n  });\n}\n\n/**\n * Returns the default base URL for 3p bootstrap iframes.\n * @param {!Window} parentWindow\n * @return {string}\n */\nfunction getDefaultBootstrapBaseUrl(parentWindow) {\n  let url =\n      'https://3p.ampproject.net/$internalRuntimeVersion$/frame.html';\n  if (getMode().localDev) {\n    url = 'http://ads.localhost:' + parentWindow.location.port +\n        '/dist.3p/current' +\n        (getMode().minified ? '-min/frame' : '/frame.max') +\n        '.html';\n  }\n  return url;\n}\n\n/**\n * Returns the custom base URL for 3p bootstrap iframes if it exists.\n * Otherwise null.\n * @param {!Window} parentWindow\n * @return {?string}\n */\nfunction getCustomBootstrapBaseUrl(parentWindow) {\n  const meta = parentWindow.document\n      .querySelector('meta[name=\"amp-3p-iframe-src\"]');\n  if (!meta) {\n    return null;\n  }\n  const url = assertHttpsUrl(meta.getAttribute('content'), meta);\n  assert(url.indexOf('?') == -1,\n      '3p iframe url must not include query string %s in element %s.',\n      url, meta);\n  // This is not a security primitive, we just don't want this to happen in\n  // practice. People could still redirect to the same origin, but they cannot\n  // redirect to the proxy origin which is the important one.\n  assert(parseUrl(url).origin != parseUrl(parentWindow.location.href).origin,\n      '3p iframe url must not be on the same origin as the current document ' +\n      '%s in element %s.', url, meta);\n  return url + '?$internalRuntimeVersion$';\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {string} message The assertion message\n * @param {...*} var_args Arguments substituted into %s in the message.\n * @return {T} The value of shouldBeTrueish.\n * @template T\n */\n/*eslint \"google-camelcase/google-camelcase\": 0*/\nexport function assert(shouldBeTrueish, message, var_args) {\n  let firstElement;\n  if (!shouldBeTrueish) {\n    message = message || 'Assertion failed';\n    const splitMessage = message.split('%s');\n    const first = splitMessage.shift();\n    let formatted = first;\n    const messageArray = [];\n    pushIfNonEmpty(messageArray, first);\n    for (let i = 2; i < arguments.length; i++) {\n      const val = arguments[i];\n      if (val && val.tagName) {\n        firstElement = val;\n      }\n      const nextConstant = splitMessage.shift();\n      messageArray.push(val);\n      pushIfNonEmpty(messageArray, nextConstant.trim());\n      formatted += toString(val) + nextConstant;\n    }\n    const e = new Error(formatted);\n    e.fromAssert = true;\n    e.associatedElement = firstElement;\n    e.messageArray = messageArray;\n    throw e;\n  }\n  return shouldBeTrueish;\n}\n/*eslint \"google-camelcase/google-camelcase\": 2*/\n\n/**\n * @param {*} val\n * @return {string}\n */\nfunction toString(val) {\n  if (val instanceof Element) {\n    return val.tagName.toLowerCase() + (val.id ? '#' + val.id : '');\n  }\n  return val;\n}\n\n/**\n * @param {!Array} array\n * @param {*} val\n */\nfunction pushIfNonEmpty(array, val) {\n  if (val != '') {\n    array.push(val);\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Layout} from './layout';\nimport {preconnectFor} from './preconnect';\nimport {resourcesFor} from './resources';\nimport {viewerFor} from './viewer';\nimport {viewportFor} from './viewport';\nimport {vsyncFor} from './vsync';\n\n\n/**\n * Base class for all custom element implementations. Instead of inheriting\n * from Element this class has an Element. Among other things this allows\n * switching the element implementation when going from a stub to the full\n * implementation.\n *\n * The base class implements a set of lifecycle methods that are called by\n * the runtime as appropriate. These are mostly based on the custom element\n * lifecycle (See\n * http://www.html5rocks.com/en/tutorials/webcomponents/customelements/)\n * and adding AMP style late loading to the mix.\n *\n * The complete lifecycle of custom DOM element is:\n *\n *           ||\n *           || createdCallback\n *           ||\n *           \\/\n *    State: <NOT BUILT> <NOT UPGRADED> <NOT ATTACHED>\n *           ||\n *           || upgrade\n *           ||\n *           \\/\n *    State: <NOT BUILT> <NOT ATTACHED>\n *           ||\n *           || firstAttachedCallback\n *           ||\n *           \\/\n *    State: <NOT BUILT>             <=\n *           ||                       ||\n *           || isReadyToBuild?  ======\n *           ||\n *           \\/\n *    State: <NOT BUILT>\n *           ||\n *           || buildCallback\n *           || preconnectCallback may be called N times after this.\n *           ||\n *           \\/\n *    State: <BUILT>\n *           ||\n *           || layoutCallback        <==\n             || (firstLayoutCompleted)  ||\n *           ||                         ||\n *           \\/                         || isRelayoutNeeded?\n *    State: <LAID OUT>                 ||\n *           ||                         ||\n *           ||                 =========\n *           ||\n *           || viewportCallback\n *           ||\n *           \\/\n *    State: <IN VIEWPORT>\n *\n * The preconnectCallback is called when the systems thinks it is good\n * to preconnect to hosts needed by an element. It will never be called\n * before buildCallback and it might be called multiple times including\n * after layoutCallback.\n *\n * Additionally whenever the dimensions of an element might have changed\n * AMP remeasures its dimensions and calls `onLayoutMeasure` on the\n * element instance. This can be used to do additional style calculations\n * without triggering style recalculations.\n *\n * For more details, see {@link custom-element.js}.\n *\n * Each method is called exactly once and overriding them in subclasses\n * is optional.\n */\nexport class BaseElement {\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    /** @public @const */\n    this.element = element;\n\n    /** @package {!Layout} */\n    this.layout_ = Layout.NODISPLAY;\n\n    /** @package {number} */\n    this.layoutWidth_ = -1;\n\n    /** @package {boolean} */\n    this.inViewport_ = false;\n\n    /** @private {!Object<string, function(!ActionInvocation)>} */\n    this.actionMap_ = this.getWin().Object.create(null);\n\n    /** @protected {!Preconnect} */\n    this.preconnect = preconnectFor(this.getWin());\n\n    /** @private {!Resources}  */\n    this.resources_ = resourcesFor(this.getWin());\n  }\n\n  /** @return {!Layout} */\n  getLayout() {\n    return this.layout_;\n  }\n\n  /** @protected @return {!Window} */\n  getWin() {\n    return this.element.ownerDocument.defaultView;\n  }\n\n  /** @protected @return {!Vsync} */\n  getVsync() {\n    return vsyncFor(this.getWin());\n  }\n\n  /**\n   * Returns the layout width for this element. A `-1` value indicates that the\n   * layout is not yet known. A `0` value indicates that the element is not\n   * visible.\n   * @return {number}\n   * @protected\n   */\n  getLayoutWidth() {\n    return this.layoutWidth_;\n  }\n\n  /**\n   * Intended to be implemented by subclasses. Tests whether the element\n   * supports the specified layout. By default only Layout.NODISPLAY is\n   * supported.\n   * @param {!Layout} layout\n   * @return {boolean}\n   * @protected\n   */\n  isLayoutSupported(layout) {\n    return layout == Layout.NODISPLAY;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isInViewport() {\n    return this.inViewport_;\n  }\n\n  /**\n   * Called when the element is first created. Note that for element created\n   * using createElement this may be before any children are added.\n   */\n  createdCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Override in subclass to adjust the element when it is being added to the\n   * DOM. Could e.g. be used to insert a fallback. Should not typically start\n   * loading a resource.\n   */\n  firstAttachedCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Override in subclass to indicate if the element is ready to rebuild its\n   * DOM subtree.  If the element can proceed with building the content return\n   * \"true\" and return \"false\" otherwise. The element may not be ready to build\n   * e.g. because its children are not available yet.\n   *\n   * See {@link buildCallback} for more details.\n   *\n   * @return {boolean}\n   */\n  isReadyToBuild() {\n    // Subclasses may override.\n    return true;\n  }\n\n  /**\n   * Override in subclass if the element needs to rebuilt its DOM content.\n   * Until the element has been rebuilt its content are not shown with an only\n   * exception of [placeholder] elements. From the moment the element is created\n   * and until the building phase is complete it will have \"amp-notbuilt\" CSS\n   * class set on it.\n   *\n   * This callback is executed early after the element has been attached to DOM\n   * if \"isReadyToBuild\" callback returns \"true\" or its called later upon the\n   * determination of Resources manager but definitely before first\n   * \"layoutCallback\" is called. Notice that \"isReadyToBuild\" call is not\n   * consulted in the later case.\n   */\n  buildCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Called by the framework to give the element a chance to preconnect to\n   * hosts and prefetch resources it is likely to need. May be called\n   * multiple times because connections can time out.\n   */\n  preconnectCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Sets this element as the owner of the specified element. By setting itself\n   * as an owner, the element declares that it will manage the lifecycle of\n   * the owned element itself. This element, as an owner, will have to call\n   * {@link scheduleLayout}, {@link schedulePreload}, {@link updateInViewport}\n   * and similar methods.\n   * @param {!Element} element\n   */\n  setAsOwner(element) {\n    this.resources_.setOwner(element, this.element);\n  }\n\n  /**\n   * Subclasses can override this method to opt-in into being called to\n   * prerender when document itself is not yet visible (pre-render mode).\n   * @return {boolean}\n   */\n  prerenderAllowed() {\n    return false;\n  }\n\n  /**\n   * Subclasses can override this method to opt-out of rendering the element\n   * when it is not currently visible.\n   * @return {boolean}\n   */\n  renderOutsideViewport() {\n    return true;\n  }\n\n  /**\n   * Subclasses can override this method to opt-in into receiving additional\n   * {@link layoutCallback} calls. Note that this method is not consulted for\n   * the first layout given that each element must be laid out at least once.\n   * @return {boolean}\n   */\n  isRelayoutNeeded() {\n    return false;\n  }\n\n  /**\n   * Called when the element should perform layout. At this point the element\n   * should load/reload resources associated with it. This method is called\n   * by the runtime and cannot be called manually. Returns promise that will\n   * complete when loading is considered to be complete.\n   *\n   * The first layout call is always called. If the subclass is interested in\n   * receiving additional callbacks, it has to opt in to do so using\n   * {@link isRelayoutNeeded} method.\n   *\n   * @return {!Promise}\n   */\n  layoutCallback() {\n    return Promise.resolve();\n  }\n\n  /**\n   * Called to notify the element that the first layout has been successfully\n   * completed.\n   *\n   * The default behavior of this method is to hide the placeholder. However,\n   * a subclass may choose to hide placeholder earlier or not hide it at all.\n   *\n   * @protected\n   */\n  firstLayoutCompleted() {\n    this.togglePlaceholder(false);\n  }\n\n  /**\n   * Instructs the resource that it has either entered or exited the visible\n   * viewport. Intended to be implemented by actual components.\n   * @param {boolean} unusedInViewport\n   */\n  viewportCallback(unusedInViewport) {\n  }\n\n  /**\n   * Requests the resource to stop its activity when the document goes into\n   * inactive state. The scope is up to the actual component. Among other\n   * things the active playback of video or audio content must be stopped.\n   * The component must return `true` if it'd like to later receive\n   * {@link layoutCallback} in case document becomes active again.\n   * @return {boolean}\n   */\n  documentInactiveCallback() {\n    return false;\n  }\n\n  /**\n   * Instructs the element that its activation is requested based on some\n   * user event. Intended to be implemented by actual components.\n   * @param {!ActionInvocation} unusedInvocation\n   */\n  activate(unusedInvocation) {\n  }\n\n  /**\n   * Registers the action handler for the method with the specified name.\n   * @param {string} method\n   * @param {function(!ActionInvocation)} handler\n   * @protected\n   */\n  registerAction(method, handler) {\n    this.actionMap_[method] = handler;\n  }\n\n  /**\n   * Requests the element to execute the specified method. If method must have\n   * been previously registered using {@link registerAction}, otherwise an\n   * error is thrown.\n   * @param {!ActionInvocation} invocation The invocation data.\n   * @param {boolean} unusedDeferred Whether the invocation has had to wait any time\n   *   for the element to be resolved, upgraded and built.\n   * @final\n   * @package\n   */\n  executeAction(invocation, unusedDeferred) {\n    if (invocation.method == 'activate') {\n      this.activate(invocation);\n    } else {\n      const handler = this.actionMap_[invocation.method];\n      if (!handler) {\n        throw new Error(`Method not found: ${invocation.method}`);\n      }\n      handler(invocation);\n    }\n  }\n\n  /**\n   * Returns the maximum DPR available on this device.\n   * @return {number}\n   */\n  getMaxDpr() {\n    return this.resources_.getMaxDpr();\n  }\n\n  /**\n   * Returns the most optimal DPR currently recommended.\n   * @return {number}\n   */\n  getDpr() {\n    return this.resources_.getDpr();\n  }\n\n  /**\n   * Utility method that propagates attributes from this element\n   * to the given element.\n   * @param  {!Array<string>} attributes\n   * @param  {!Element} element\n   * @protected @final\n   */\n  propagateAttributes(attributes, element) {\n    for (let i = 0; i < attributes.length; i++) {\n      const attr = attributes[i];\n      if (!this.element.hasAttribute(attr)) {\n        continue;\n      }\n      element.setAttribute(attr, this.element.getAttribute(attr));\n    }\n  }\n\n  /**\n   * Returns an optional placeholder element for this custom element.\n   * @return {?Element}\n   * @protected @final\n   */\n  getPlaceholder() {\n    return this.element.getPlaceholder();\n  }\n\n  /**\n   * Hides or shows the placeholder, if available.\n   * @param {boolean} state\n   * @protected @final\n   */\n  togglePlaceholder(state) {\n    this.element.togglePlaceholder(state);\n  }\n\n  /**\n   * Returns an optional fallback element for this custom element.\n   * @return {?Element}\n   * @protected @final\n   */\n  getFallback() {\n    return this.element.getFallback();\n  }\n\n  /**\n   * Hides or shows the fallback, if available. This function must only\n   * be called inside a mutate context.\n   * @param {boolean} state\n   * @protected @final\n   */\n  toggleFallback(state) {\n    this.element.toggleFallback(state);\n  }\n\n  /**\n   * Returns an optional overflow element for this custom element.\n   * @return {?Element}\n   * @protected @final\n   */\n  getOverflowElement() {\n    return this.element.getOverflowElement();\n  }\n\n  /**\n   * Returns the original nodes of the custom element without any service nodes\n   * that could have been added for markup. These nodes can include Text,\n   * Comment and other child nodes.\n   * @return {!Array<!Node>}\n   * @protected @final\n   */\n  getRealChildNodes() {\n    return this.element.getRealChildNodes();\n  }\n\n  /**\n   * Returns the original children of the custom element without any service\n   * nodes that could have been added for markup.\n   * @return {!Array<!Element>}\n   * @protected @final\n   */\n  getRealChildren() {\n    return this.element.getRealChildren();\n  }\n\n  /**\n   * Configures the supplied element to have a \"fill content\" layout. The\n   * exact interpretation of \"fill content\" depends on the element's layout.\n   *\n   * If `opt_replacedContent` is specified, it indicates whether the \"replaced\n   * content\" styling should be applied. Replaced content is not allowed to\n   * have its own paddings or border.\n   *\n   * @param {!Element} element\n   * @param {boolean=} opt_replacedContent\n   * @protected @final\n   */\n  applyFillContent(element, opt_replacedContent) {\n    element.classList.add('-amp-fill-content');\n    if (opt_replacedContent) {\n      element.classList.add('-amp-replaced-content');\n    }\n  }\n\n  /**\n   * Returns the viewport within which the element operates.\n   * @return {!Viewport}\n   */\n  getViewport() {\n    return viewportFor(this.getWin());\n  }\n\n  /**\n   * Schedule the layout request for the children element or elements\n   * specified. Resource manager will perform the actual layout based on the\n   * priority of this element and its children.\n   * @param {!Element|!Array<!Element>} elements\n   * @param {boolean} inLocalViewport\n   * @protected\n   */\n  scheduleLayout(elements) {\n    this.resources_.scheduleLayout(this.element, elements);\n  }\n\n  /**\n   * Schedule the preload request for the children element or elements\n   * specified. Resource manager will perform the actual preload based on the\n   * priority of this element and its children.\n   * @param {!Element|!Array<!Element>} elements\n   * @param {boolean} inLocalViewport\n   * @protected\n   */\n  schedulePreload(elements) {\n    this.resources_.schedulePreload(this.element, elements);\n  }\n\n  /**\n   * Update inViewport state of the specified children element or elements.\n   * Resource manager will perform the actual changes to the inViewport state\n   * based on the state of these elements and their parent subtree.\n   * @param {!Element|!Array<!Element>} elements\n   * @param {boolean} inLocalViewport\n   * @protected\n   */\n  updateInViewport(elements, inLocalViewport) {\n    this.resources_.updateInViewport(this.element, elements, inLocalViewport);\n  }\n\n  /**\n   * Requests the runtime to update the height of this element to the specified\n   * value. The runtime will schedule this request and attempt to process it\n   * as soon as possible.\n   * @param {number} newHeight\n   * @protected\n   */\n  changeHeight(newHeight) {\n    this.resources_./*OK*/changeHeight(this.element, newHeight);\n  }\n\n  /**\n   * Requests the runtime to update the height of this element to the specified\n   * value. The runtime will schedule this request and attempt to process it\n   * as soon as possible. However, unlike in {@link changeHeight}, the runtime\n   * may refuse to make a change in which case it will show the element's\n   * overflow element if provided, which is supposed to provide the reader with\n   * the necessary user action.\n   * @param {number} newHeight\n   * @protected\n   */\n  requestChangeHeight(newHeight) {\n    this.resources_.requestChangeHeight(this.element, newHeight);\n  }\n\n  /**\n   * Schedules callback to be complete within the next batch. This call is\n   * intended for heavy DOM mutations that typically cause re-layouts.\n   * @param {!Function} callback\n   */\n  deferMutate(callback) {\n    this.resources_.deferMutate(this.element, callback);\n  }\n\n  /**\n   * Requests full overlay mode from the viewer.\n   * @protected\n   */\n  requestFullOverlay() {\n    viewerFor(this.getWin()).requestFullOverlay();\n  }\n\n  /**\n   * Requests to cancel full overlay mode from the viewer.\n   * @protected\n   */\n  cancelFullOverlay() {\n    viewerFor(this.getWin()).cancelFullOverlay();\n  }\n\n  /**\n   * Called when we just measured the layout rect of this element. Doing\n   * more expensive style reads should now be cheap.\n   * This may currently not work with extended elements. Please file\n   * an issue if that is required.\n   * @protected\n   */\n  onLayoutMeasure() {}\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Layout, assertLength, getLayoutClass, getLengthNumeral, getLengthUnits,\n          isInternalElement, isLayoutSizeDefined, isLoadingAllowed,\n          parseLayout, parseLength, getNaturalDimensions,\n          hasNaturalDimensions} from './layout';\nimport {ElementStub, stubbedElements} from './element-stub';\nimport {assert} from './asserts';\nimport {createLoaderElement} from '../src/loader';\nimport {log} from './log';\nimport {parseSizeList} from './size-list';\nimport {reportError} from './error';\nimport {resourcesFor} from './resources';\nimport {timer} from './timer';\nimport {vsyncFor} from './vsync';\nimport * as dom from './dom';\n\n\nconst TAG_ = 'CustomElement';\n\n/**\n * This is the minimum width of the element needed to trigger `loading`\n * animation. This value is justified as about 1/3 of a smallish mobile\n * device viewport. Trying to put a loading indicator into a small element\n * is meaningless.\n * @private @const {number}\n */\nconst MIN_WIDTH_FOR_LOADING_ = 100;\n\n\n/**\n * The elements positioned ahead of this threshold may have their loading\n * indicator initialized faster. This is benefitial to avoid relayout during\n * render phase or scrolling.\n * @private @const {number}\n */\nconst PREPARE_LOADING_THRESHOLD_ = 1000;\n\n\n/**\n * Map from element name to implementation class.\n * @const {Object}\n */\nconst knownElements = {};\n\n\n/**\n * Whether this platform supports template tags.\n * @const {boolean}\n */\nconst TEMPLATE_TAG_SUPPORTED = 'content' in document.createElement('template');\n\n\n/**\n * Registers an element. Upgrades it if has previously been stubbed.\n * @param {!Window} win\n * @param {string}\n * @param {function(!Function)} toClass\n */\nexport function upgradeOrRegisterElement(win, name, toClass) {\n  if (!knownElements[name]) {\n    registerElement(win, name, toClass);\n    return;\n  }\n  assert(knownElements[name] == ElementStub,\n      'Expected ' + name + ' to be an ElementStub.');\n  for (let i = 0; i < stubbedElements.length; i++) {\n    const stub = stubbedElements[i];\n    // There are 3 possible states here:\n    // 1. We never made the stub because the extended impl. loaded first.\n    //    In that case the element won't be in the array.\n    // 2. We made a stub but the browser didn't attach it yet. In\n    //    that case we don't need to upgrade but simply switch to the new\n    //    implementation.\n    // 3. A stub was attached. We upgrade which means we replay the\n    //    implementation.\n    const element = stub.element;\n    if (element.tagName.toLowerCase() == name) {\n      try {\n        element.upgrade(toClass);\n      } catch (e) {\n        reportError(e, this);\n      }\n    }\n  }\n}\n\n\n/**\n * Stub extended elements missing an implementation.\n * @param {!Window} win\n */\nexport function stubElements(win) {\n  win.ampExtendedElements = {};\n  const list = win.document.querySelectorAll('[custom-element]');\n  for (let i = 0; i < list.length; i++) {\n    const name = list[i].getAttribute('custom-element');\n    win.ampExtendedElements[name] = true;\n    if (knownElements[name]) {\n      continue;\n    }\n    registerElement(win, name, ElementStub);\n  }\n}\n\n\n/**\n * Applies layout to the element. Visible for testing only.\n * @param {!AmpElement} element\n */\nexport function applyLayout_(element) {\n  const layoutAttr = element.getAttribute('layout');\n  const widthAttr = element.getAttribute('width');\n  const heightAttr = element.getAttribute('height');\n  const sizesAttr = element.getAttribute('sizes');\n\n  // Input layout attributes.\n  const inputLayout = layoutAttr ? parseLayout(layoutAttr) : null;\n  assert(inputLayout !== undefined, 'Unknown layout: %s', layoutAttr);\n  const inputWidth = (widthAttr && widthAttr != 'auto') ?\n      parseLength(widthAttr) : widthAttr;\n  assert(inputWidth !== undefined, 'Invalid width value: %s', widthAttr);\n  const inputHeight = heightAttr ? parseLength(heightAttr) : null;\n  assert(inputHeight !== undefined, 'Invalid height value: %s', heightAttr);\n\n  // Effective layout attributes. These are effectively constants.\n  let width;\n  let height;\n  let layout;\n\n  // Calculate effective width and height.\n  if ((!inputLayout || inputLayout == Layout.FIXED ||\n          inputLayout == Layout.FIXED_HEIGHT) &&\n      (!inputWidth || !inputHeight) && hasNaturalDimensions(element.tagName)) {\n    // Default width and height: handle elements that do not specify a\n    // width/height and are defined to have natural browser dimensions.\n    const dimensions = getNaturalDimensions(element.tagName);\n    width = (inputWidth || inputLayout == Layout.FIXED_HEIGHT) ? inputWidth :\n        dimensions.width;\n    height = inputHeight || dimensions.height;\n  } else {\n    width = inputWidth;\n    height = inputHeight;\n  }\n\n  // Calculate effective layout.\n  if (inputLayout) {\n    layout = inputLayout;\n  } else if (!width && !height) {\n    layout = Layout.CONTAINER;\n  } else if (height && (!width || width == 'auto')) {\n    layout = Layout.FIXED_HEIGHT;\n  } else if (height && width && sizesAttr) {\n    layout = Layout.RESPONSIVE;\n  } else {\n    layout = Layout.FIXED;\n  }\n\n  // Verify layout attributes.\n  if (layout == Layout.FIXED || layout == Layout.FIXED_HEIGHT ||\n          layout == Layout.RESPONSIVE) {\n    assert(height, 'Expected height to be available: %s', heightAttr);\n  }\n  if (layout == Layout.FIXED_HEIGHT) {\n    assert(!width || width == 'auto',\n        'Expected width to be either absent or equal \"auto\" ' +\n        'for fixed-height layout: %s', widthAttr);\n  }\n  if (layout == Layout.FIXED || layout == Layout.RESPONSIVE) {\n    assert(width && width != 'auto',\n          'Expected width to be available and not equal to \"auto\": %s',\n          widthAttr);\n  }\n  if (layout == Layout.RESPONSIVE) {\n    assert(getLengthUnits(width) == getLengthUnits(height),\n        'Length units should be the same for width and height: %s, %s',\n        widthAttr, heightAttr);\n  }\n\n  // Apply UI.\n  element.classList.add(getLayoutClass(layout));\n  if (isLayoutSizeDefined(layout)) {\n    element.classList.add('-amp-layout-size-defined');\n  }\n  if (layout == Layout.NODISPLAY) {\n    element.style.display = 'none';\n  } else if (layout == Layout.FIXED) {\n    element.style.width = width;\n    element.style.height = height;\n  } else if (layout == Layout.FIXED_HEIGHT) {\n    element.style.height = height;\n  } else if (layout == Layout.RESPONSIVE) {\n    const sizer = element.ownerDocument.createElement('i-amp-sizer');\n    sizer.style.display = 'block';\n    sizer.style.paddingTop =\n        ((getLengthNumeral(height) / getLengthNumeral(width)) * 100) + '%';\n    element.insertBefore(sizer, element.firstChild);\n    element.sizerElement_ = sizer;\n  } else if (layout == Layout.FILL) {\n    // Do nothing.\n  } else if (layout == Layout.CONTAINER) {\n    // Do nothing. Elements themselves will check whether the supplied\n    // layout value is acceptable. In particular container is only OK\n    // sometimes.\n  }\n  return layout;\n}\n\n\n/**\n * Returns \"true\" for internal AMP nodes or for placeholder elements.\n * @param {!Node} node\n * @return {boolean}\n */\nfunction isInternalOrServiceNode(node) {\n  if (isInternalElement(node)) {\n    return true;\n  }\n  if (node.tagName && (node.hasAttribute('placeholder') ||\n          node.hasAttribute('fallback') ||\n          node.hasAttribute('overflow'))) {\n    return true;\n  }\n  return false;\n}\n\n\n/**\n * The interface that is implemented by all custom elements in the AMP\n * namespace.\n * @interface\n */\nclass AmpElement {\n  // TODO(dvoytenko): Add all exposed methods.\n}\n\n\n/**\n * Creates a new custom element class prototype.\n *\n * Visible for testing only.\n *\n * @param {!Window} win The window in which to register the elements.\n * @param {string} name Name of the custom element\n * @param {function(new:BaseElement, !Element)} implementationClass\n * @return {!AmpElement.prototype}\n */\nexport function createAmpElementProto(win, name, implementationClass) {\n  /**\n   * @lends {AmpElement.prototype}\n   */\n  const ElementProto = win.Object.create(win.HTMLElement.prototype);\n\n  /**\n   * Called when elements is created. Sets instance vars since there is no\n   * constructor.\n   * @final\n   */\n  ElementProto.createdCallback = function() {\n    this.classList.add('-amp-element');\n\n    // Flag \"notbuilt\" is removed by Resource manager when the resource is\n    // considered to be built. See \"setBuilt\" method.\n    /** @private {boolean} */\n    this.built_ = false;\n    this.classList.add('-amp-notbuilt');\n    this.classList.add('amp-notbuilt');\n\n    this.readyState = 'loading';\n    this.everAttached = false;\n\n    /** @private @const {!Resources}  */\n    this.resources_ = resourcesFor(win);\n\n    /** @private {!Layout} */\n    this.layout_ = Layout.NODISPLAY;\n\n    /** @private {number} */\n    this.layoutWidth_ = -1;\n\n    /** @private {number} */\n    this.layoutCount_ = 0;\n\n    /** @private {boolean} */\n    this.isInViewport_ = false;\n\n    /** @private {string|null|undefined} */\n    this.mediaQuery_;\n\n    /** @private {!SizeList|null|undefined} */\n    this.sizeList_;\n\n    /**\n     * This element can be assigned by the {@link applyLayout_} to a child\n     * element that will be used to size this element.\n     * @private {?Element}\n     */\n    this.sizerElement_ = null;\n\n    /** @private {boolean|undefined} */\n    this.loadingDisabled_;\n\n    /** @private {boolean|undefined} */\n    this.loadingState_;\n\n    /** @private {?Element} */\n    this.loadingContainer_ = null;\n\n    /** @private {?Element} */\n    this.loadingElement_ = null;\n\n    /** @private {?Element|undefined} */\n    this.overflowElement_;\n\n    /** @private {!BaseElement} */\n    this.implementation_ = new implementationClass(this);\n    this.implementation_.createdCallback();\n\n    /**\n     * Action queue is initially created and kept around until the element\n     * is ready to send actions directly to the implementation.\n     * @private {?Array<!ActionInvocation>}\n     */\n    this.actionQueue_ = [];\n\n    /**\n     * Whether the element is in the template.\n     * @private {boolean|undefined}\n     */\n    this.isInTemplate_;\n  };\n\n  /** @private */\n  ElementProto.assertNotTemplate_ = function() {\n    assert(!this.isInTemplate_, 'Must never be called in template');\n  };\n\n  /**\n   * Whether the element has been upgraded yet.\n   * @return {boolean}\n   * @final\n   */\n  ElementProto.isUpgraded = function() {\n    return !(this.implementation_ instanceof ElementStub);\n  };\n\n  /**\n   * Upgrades the element to the provided new implementation. If element\n   * has already been attached, it's layout validation and attachment flows\n   * are repeated for the new implementation.\n   * @param {function(new:BaseElement, !Element)} newImplClass\n   * @final @package\n   */\n  ElementProto.upgrade = function(newImplClass) {\n    if (this.isInTemplate_) {\n      return;\n    }\n    this.implementation_ = new newImplClass(this);\n    this.classList.remove('amp-unresolved');\n    this.classList.remove('-amp-unresolved');\n    this.implementation_.createdCallback();\n    if (this.layout_ != Layout.NODISPLAY &&\n          !this.implementation_.isLayoutSupported(this.layout_)) {\n      throw new Error('Layout not supported: ' + this.layout_);\n    }\n    this.implementation_.layout_ = this.layout_;\n    this.implementation_.layoutWidth_ = this.layoutWidth_;\n    if (this.everAttached) {\n      this.implementation_.firstAttachedCallback();\n      this.dispatchCustomEvent('amp:attached');\n    }\n    this.resources_.upgraded(this);\n  };\n\n  /**\n   * Whether the element has been built. A built element had its\n   * {@link buildCallback} method successfully invoked.\n   * @return {boolean}\n   * @final\n   */\n  ElementProto.isBuilt = function() {\n    return this.built_;\n  };\n\n  /**\n   * Requests or requires the element to be built. The build is done by\n   * invoking {@link BaseElement.buildCallback} method.\n   *\n   * If the \"force\" argument is \"false\", the element will first check if\n   * implementation is ready to build by calling\n   * {@link BaseElement.isReadyToBuild} method. If this method returns \"true\"\n   * the build proceeds, otherwise no build is done.\n   *\n   * If the \"force\" argument is \"true\", the element performs build regardless\n   * of what {@link BaseElement.isReadyToBuild} would return.\n   *\n   * Returned value indicates whether or not build has been performed.\n   *\n   * This method can only be called on a upgraded element.\n   *\n   * @param {boolean} force Whether or not force the build.\n   * @return {boolean}\n   * @final\n   */\n  ElementProto.build = function(force) {\n    this.assertNotTemplate_();\n    if (this.isBuilt()) {\n      return true;\n    }\n    assert(this.isUpgraded(), 'Cannot build unupgraded element');\n    if (!force && !this.implementation_.isReadyToBuild()) {\n      return false;\n    }\n    try {\n      this.implementation_.buildCallback();\n      this.preconnect(/* onLayout */ false);\n      this.built_ = true;\n      this.classList.remove('-amp-notbuilt');\n      this.classList.remove('amp-notbuilt');\n    } catch (e) {\n      reportError(e, this);\n      throw e;\n    }\n    if (this.built_ && this.isInViewport_) {\n      this.updateInViewport_(true);\n    }\n    if (this.actionQueue_) {\n      if (this.actionQueue_.length > 0) {\n        // Only schedule when the queue is not empty, which should be\n        // the case 99% of the time.\n        timer.delay(this.dequeueActions_.bind(this), 1);\n      } else {\n        this.actionQueue_ = null;\n      }\n    }\n    return true;\n  };\n\n  /**\n   * Called to instruct the element to preconnect to hosts it uses during\n   * layout.\n   * @param {boolean} onLayout Whether this was called after a layout.\n   */\n  ElementProto.preconnect = function(onLayout) {\n    this.implementation_.preconnectCallback(onLayout);\n  };\n\n  /**\n   * @return {!Vsync}\n   * @private\n   */\n  ElementProto.getVsync_ = function() {\n    return vsyncFor(this.ownerDocument.defaultView);\n  };\n\n  /**\n   * Updates the layout box of the element.\n   * See {@link BaseElement.getLayoutWidth} for details.\n   * @param {!LayoutRect} layoutBox\n   */\n  ElementProto.updateLayoutBox = function(layoutBox) {\n    this.layoutWidth_ = layoutBox.width;\n    if (this.isUpgraded()) {\n      this.implementation_.layoutWidth_ = this.layoutWidth_;\n    }\n    // TODO(malteubl): Forward for stubbed elements.\n    this.implementation_.onLayoutMeasure();\n\n    if (this.isLoadingEnabled_()) {\n      if (this.isInViewport_) {\n        // Already in viewport - start showing loading.\n        this.toggleLoading_(true);\n      } else if (layoutBox.top < PREPARE_LOADING_THRESHOLD_ &&\n            layoutBox.top >= 0) {\n        // Few top elements will also be pre-initialized with a loading\n        // element.\n        this.getVsync_().mutate(() => {\n          this.prepareLoading_();\n        });\n      }\n    }\n  };\n\n  /**\n   * If the element has a media attribute, evaluates the value as a media\n   * query and based on the result adds or removes the class\n   * `-amp-hidden-by-media-query`. The class adds display:none to the element\n   * which in turn prevents any of the resource loading to happen for the\n   * element.\n   *\n   * This method is called by Resources and shouldn't be called by anyone else.\n   *\n   * @final\n   * @package\n   */\n  ElementProto.applySizesAndMediaQuery = function() {\n    this.assertNotTemplate_();\n\n    // Media query.\n    if (this.mediaQuery_ === undefined) {\n      this.mediaQuery_ = this.getAttribute('media') || null;\n    }\n    if (this.mediaQuery_) {\n      this.classList.toggle('-amp-hidden-by-media-query',\n          !this.ownerDocument.defaultView.matchMedia(this.mediaQuery_).matches);\n    }\n\n    // Sizes.\n    if (this.sizeList_ === undefined) {\n      const sizesAttr = this.getAttribute('sizes');\n      this.sizeList_ = sizesAttr ? parseSizeList(sizesAttr) : null;\n    }\n    if (this.sizeList_) {\n      this.style.width = assertLength(this.sizeList_.select(\n          this.ownerDocument.defaultView));\n    }\n  };\n\n  /**\n   * Changes the height of the element.\n   *\n   * This method is called by Resources and shouldn't be called by anyone else.\n   * This method must always be called in the mutation context.\n   *\n   * @param {number} newHeight\n   * @final\n   * @package\n   */\n  ElementProto./*OK*/changeHeight = function(newHeight) {\n    if (this.sizerElement_) {\n      // From the moment height is changed the element becomes fully\n      // responsible for managing its height. Aspect ratio is no longer\n      // preserved.\n      this.sizerElement_.style.paddingTop = '0';\n    }\n    this.style.height = newHeight + 'px';\n  };\n\n  /**\n   * Called when the element is first attached to the DOM. Calls\n   * {@link firstAttachedCallback} if this is the first attachment.\n   * @final\n   */\n  ElementProto.attachedCallback = function() {\n    if (!TEMPLATE_TAG_SUPPORTED) {\n      this.isInTemplate_ = !!dom.closestByTag(this, 'template');\n    }\n    if (this.isInTemplate_) {\n      return;\n    }\n    if (!this.everAttached) {\n      this.everAttached = true;\n      try {\n        this.firstAttachedCallback_();\n      } catch (e) {\n        reportError(e, this);\n      }\n    }\n    this.resources_.add(this);\n  };\n\n  /**\n   * Called when the element is detached from the DOM.\n   * @final\n   */\n  ElementProto.detachedCallback = function() {\n    if (this.isInTemplate_) {\n      return;\n    }\n    this.resources_.remove(this);\n  };\n\n  /**\n   * Called when the element is attached to the DOM for the first time.\n   * @private @final\n   */\n  ElementProto.firstAttachedCallback_ = function() {\n    if (!this.isUpgraded()) {\n      this.classList.add('amp-unresolved');\n      this.classList.add('-amp-unresolved');\n    }\n    try {\n      this.layout_ = applyLayout_(this);\n      if (this.layout_ != Layout.NODISPLAY &&\n            !this.implementation_.isLayoutSupported(this.layout_)) {\n        throw new Error('Layout not supported for: ' + this.layout_);\n      }\n      this.implementation_.layout_ = this.layout_;\n      this.implementation_.firstAttachedCallback();\n    } catch (e) {\n      reportError(e, this);\n      throw e;\n    }\n    if (!this.isUpgraded()) {\n      // amp:attached is dispatched from the ElementStub class when it replayed\n      // the firstAttachedCallback call.\n      this.dispatchCustomEvent('amp:stubbed');\n    } else {\n      this.dispatchCustomEvent('amp:attached');\n    }\n  };\n\n  /**\n   * @param {string} name\n   * @param {!Object=} opt_data Event data.\n   * @final\n   */\n  ElementProto.dispatchCustomEvent = function(name, opt_data) {\n    const data = opt_data || {};\n    // Constructors of events need to come from the correct window. Sigh.\n    const win = this.ownerDocument.defaultView;\n    const event = win.document.createEvent('Event');\n    event.data = data;\n    event.initEvent(name, true, true);\n    this.dispatchEvent(event);\n  };\n\n  /**\n   * Whether the element can pre-render.\n   * @return {boolean}\n   * @final\n   */\n  ElementProto.prerenderAllowed = function() {\n    return this.implementation_.prerenderAllowed();\n  };\n\n  /**\n   * Whether the element should ever render when it is not in viewport.\n   * @return {boolean}\n   * @final\n   */\n  ElementProto.renderOutsideViewport = function() {\n    return this.implementation_.renderOutsideViewport();\n  };\n\n  /**\n   * @return {!LayoutRect}\n   * @final\n   */\n  ElementProto.getLayoutBox = function() {\n    return this.resources_.getResourceForElement(this).getLayoutBox();\n  };\n\n  /**\n   * The runtime calls this method to determine if {@link layoutCallback}\n   * should be called again when layout changes.\n   * @return {boolean}\n   * @package @final\n   */\n  ElementProto.isRelayoutNeeded = function() {\n    return this.implementation_.isRelayoutNeeded();\n  };\n\n  /**\n   * Instructs the element to layout its content and load its resources if\n   * necessary by calling the {@link BaseElement.layoutCallback} method that\n   * should be implemented by BaseElement subclasses. Must return a promise\n   * that will yield when the layout and associated loadings are complete.\n   *\n   * This method is always called for the first layout, but for subsequent\n   * layouts the runtime consults {@link isRelayoutNeeded} method.\n   *\n   * Can only be called on a upgraded and built element.\n   *\n   * @return {!Promise}\n   * @package @final\n   */\n  ElementProto.layoutCallback = function() {\n    this.assertNotTemplate_();\n    assert(this.isUpgraded() && this.isBuilt(),\n        'Must be upgraded and built to receive viewport events');\n    this.dispatchCustomEvent('amp:load:start');\n    const promise = this.implementation_.layoutCallback();\n    this.preconnect(/* onLayout */ true);\n    this.classList.add('-amp-layout');\n    return promise.then(() => {\n      this.readyState = 'complete';\n      this.layoutCount_++;\n      this.toggleLoading_(false, /* cleanup */ true);\n      if (this.layoutCount_ == 1) {\n        this.implementation_.firstLayoutCompleted();\n      }\n    }, reason => {\n      this.toggleLoading_(false, /* cleanup */ true);\n      return Promise.reject(reason);\n    });\n  };\n\n  /**\n   * Instructs the resource that it entered or exited the visible viewport.\n   *\n   * Can only be called on a upgraded and built element.\n   *\n   * @param {boolean} inViewport Whether the element has entered or exited\n   *   the visible viewport.\n   * @final @package\n   */\n  ElementProto.viewportCallback = function(inViewport) {\n    this.assertNotTemplate_();\n    this.isInViewport_ = inViewport;\n    if (this.layoutCount_ == 0) {\n      if (!inViewport) {\n        this.toggleLoading_(false);\n      } else {\n        // Set a minimum delay in case the element loads very fast or if it\n        // leaves the viewport.\n        timer.delay(() => {\n          if (this.layoutCount_ == 0 && this.isInViewport_) {\n            this.toggleLoading_(true);\n          }\n        }, 100);\n      }\n    }\n    if (this.isUpgraded() && this.isBuilt()) {\n      this.updateInViewport_(inViewport);\n    }\n  };\n\n  /**\n   * @param {boolean} inViewport\n   * @private\n   */\n  ElementProto.updateInViewport_ = function(inViewport) {\n    this.implementation_.inViewport_ = inViewport;\n    this.implementation_.viewportCallback(inViewport);\n  };\n\n  /**\n   * Requests the resource to stop its activity when the document goes into\n   * inactive state. The scope is up to the actual component. Among other\n   * things the active playback of video or audio content must be stopped.\n   * The component must return `true` if it'd like to later receive\n   * {@link layoutCallback} in case document becomes active again.\n   *\n   * Calling this method on unbuilt ot unupgraded element has no effect.\n   *\n   * @return {!Promise}\n   * @package @final\n   */\n  ElementProto.documentInactiveCallback = function() {\n    this.assertNotTemplate_();\n    if (!this.isBuilt() || !this.isUpgraded()) {\n      return false;\n    }\n    return this.implementation_.documentInactiveCallback();\n  };\n\n  /**\n   * Enqueues the action with the element. If element has been upgraded and\n   * built, the action is dispatched to the implementation right away.\n   * Otherwise the invocation is enqueued until the implementation is ready\n   * to receive actions.\n   * @param {!ActionInvocation} invocation\n   * @final\n   */\n  ElementProto.enqueAction = function(invocation) {\n    this.assertNotTemplate_();\n    if (!this.isBuilt()) {\n      assert(this.actionQueue_).push(invocation);\n    } else {\n      this.executionAction_(invocation, false);\n    }\n  };\n\n  /**\n   * Dequeues events from the queue and dispatches them to the implementation\n   * with \"deferred\" flag.\n   * @private\n   */\n  ElementProto.dequeueActions_ = function() {\n    if (!this.actionQueue_) {\n      return;\n    }\n\n    const actionQueue = assert(this.actionQueue_);\n    this.actionQueue_ = null;\n\n    // TODO(dvoytenko, #1260): dedupe actions.\n    actionQueue.forEach(invocation => {\n      this.executionAction_(invocation, true);\n    });\n  };\n\n  /**\n   * Executes the action immediately. All errors are consumed and reported.\n   * @param {!ActionInvocation} invocation\n   * @param {boolean} deferred\n   * @final\n   * @private\n   */\n  ElementProto.executionAction_ = function(invocation, deferred) {\n    try {\n      this.implementation_.executeAction(invocation, deferred);\n    } catch (e) {\n      log.error(TAG_, 'Action execution failed:', invocation, e);\n    }\n  };\n\n\n  /**\n   * Returns the original nodes of the custom element without any service nodes\n   * that could have been added for markup. These nodes can include Text,\n   * Comment and other child nodes.\n   * @return {!Array<!Node>}\n   * @package @final\n   */\n  ElementProto.getRealChildNodes = function() {\n    const nodes = [];\n    for (let n = this.firstChild; n; n = n.nextSibling) {\n      if (!isInternalOrServiceNode(n)) {\n        nodes.push(n);\n      }\n    }\n    return nodes;\n  };\n\n  /**\n   * Returns the original children of the custom element without any service\n   * nodes that could have been added for markup.\n   * @return {!Array<!Element>}\n   * @package @final\n   */\n  ElementProto.getRealChildren = function() {\n    const elements = [];\n    for (let i = 0; i < this.children.length; i++) {\n      const child = this.children[i];\n      if (!isInternalOrServiceNode(child)) {\n        elements.push(child);\n      }\n    }\n    return elements;\n  };\n\n  /**\n   * Returns an optional placeholder element for this custom element.\n   * @return {?Element}\n   * @package @final\n   */\n  ElementProto.getPlaceholder = function() {\n    return dom.childElementByAttr(this, 'placeholder');\n  };\n\n  /**\n   * Hides or shows the placeholder, if available.\n   * @param {boolean} state\n   * @package @final\n   */\n  ElementProto.togglePlaceholder = function(state) {\n    this.assertNotTemplate_();\n    const placeholder = this.getPlaceholder();\n    if (placeholder) {\n      placeholder.classList.toggle('amp-hidden', !state);\n    }\n  };\n\n  /**\n   * Returns an optional fallback element for this custom element.\n   * @return {?Element}\n   * @package @final\n   */\n  ElementProto.getFallback = function() {\n    return dom.childElementByAttr(this, 'fallback');\n  };\n\n  /**\n   * Hides or shows the fallback, if available. This function must only\n   * be called inside a mutate context.\n   * @param {boolean} state\n   * @package @final\n   */\n  ElementProto.toggleFallback = function(state) {\n    this.assertNotTemplate_();\n    // This implementation is notably less efficient then placeholder toggling.\n    // The reasons for this are: (a) \"not supported\" is the state of the whole\n    // element, (b) some realyout is expected and (c) fallback condition would\n    // be rare.\n    this.classList.toggle('amp-notsupported', state);\n  };\n\n  /**\n   * Whether the loading can be shown for this element.\n   * @return {boolean}\n   * @private\n   */\n  ElementProto.isLoadingEnabled_ = function() {\n    // No loading indicator will be shown if either one of these\n    // conditions true:\n    // 1. `noloading` attribute is specified;\n    // 2. The element has not been whitelisted;\n    // 3. The element is too small or has not yet been measured;\n    // 4. The element has already been laid out;\n    // 5. The element is a `placeholder` or a `fallback`;\n    // 6. The element's layout is not a size-defining layout.\n    if (this.loadingDisabled_ === undefined) {\n      this.loadingDisabled_ = this.hasAttribute('noloading');\n    }\n    if (this.loadingDisabled_ ||\n            !isLoadingAllowed(this.tagName) ||\n            this.layoutWidth_ < MIN_WIDTH_FOR_LOADING_ ||\n            this.layoutCount_ > 0 ||\n            isInternalOrServiceNode(this) ||\n            !isLayoutSizeDefined(this.layout_)) {\n      return false;\n    }\n    return true;\n  };\n\n  /**\n   * Creates a loading object. The caller must ensure that loading can\n   * actually be shown. This method must also be called in the mutate\n   * context.\n   * @private\n   */\n  ElementProto.prepareLoading_ = function() {\n    if (!this.loadingContainer_) {\n      const container = document.createElement('div');\n      container.classList.add('-amp-loading-container');\n      container.classList.add('-amp-fill-content');\n      container.classList.add('amp-hidden');\n\n      const element = createLoaderElement();\n      container.appendChild(element);\n\n      this.appendChild(container);\n      this.loadingContainer_ = container;\n      this.loadingElement_ = element;\n    }\n  };\n\n  /**\n   * Turns the loading indicator on or off.\n   * @param {boolean} state\n   * @param {boolean=} opt_cleanup\n   * @private @final\n   */\n  ElementProto.toggleLoading_ = function(state, opt_cleanup) {\n    this.assertNotTemplate_();\n    this.loadingState_ = state;\n    if (!state && !this.loadingContainer_) {\n      return;\n    }\n\n    // Check if loading should be shown.\n    if (state && !this.isLoadingEnabled_()) {\n      this.loadingState_ = false;\n      return;\n    }\n\n    this.getVsync_().mutate(() => {\n      let state = this.loadingState_;\n      // Repeat \"loading enabled\" check because it could have changed while\n      // waiting for vsync.\n      if (state && !this.isLoadingEnabled_()) {\n        state = false;\n      }\n      if (state) {\n        this.prepareLoading_();\n      }\n      if (!this.loadingContainer_) {\n        return;\n      }\n\n      this.loadingContainer_.classList.toggle('amp-hidden', !state);\n      this.loadingElement_.classList.toggle('amp-active', state);\n\n      if (!state && opt_cleanup) {\n        const loadingContainer = this.loadingContainer_;\n        this.loadingContainer_ = null;\n        this.loadingElement_ = null;\n        this.resources_.deferMutate(this, () => {\n          dom.removeElement(loadingContainer);\n        });\n      }\n    });\n  };\n\n  /**\n   * Returns an optional overflow element for this custom element.\n   * @return {?Element}\n   * @private\n   */\n  ElementProto.getOverflowElement = function() {\n    if (this.overflowElement_ === undefined) {\n      this.overflowElement_ = dom.childElementByAttr(this, 'overflow');\n      if (this.overflowElement_) {\n        if (!this.overflowElement_.hasAttribute('tabindex')) {\n          this.overflowElement_.setAttribute('tabindex', '0');\n        }\n        if (!this.overflowElement_.hasAttribute('role')) {\n          this.overflowElement_.setAttribute('role', 'button');\n        }\n      }\n    }\n    return this.overflowElement_;\n  };\n\n  /**\n   * Hides or shows the overflow, if available. This function must only\n   * be called inside a mutate context.\n   * @param {boolean} overflown\n   * @param {number} requestedHeight\n   * @package @final\n   */\n  ElementProto.overflowCallback = function(overflown, requestedHeight) {\n    if (!overflown && !this.overflowElement_) {\n      // Overflow has never been initialized and not wanted.\n      return;\n    }\n\n    const overflowElement = this.getOverflowElement();\n    if (!overflowElement) {\n      if (overflown) {\n        log.warn(TAG_,\n            'Cannot resize element and overlfow is not available', this);\n      }\n      return;\n    }\n\n    overflowElement.classList.toggle('amp-visible', overflown);\n\n    if (overflown) {\n      this.overflowElement_.onclick = () => {\n        this.resources_./*OK*/changeHeight(this, requestedHeight);\n        this.getVsync_().mutate(() => {\n          this.overflowCallback(/* overflown */ false, requestedHeight);\n        });\n      };\n    } else {\n      this.overflowElement_.onclick = null;\n    }\n  };\n\n  return ElementProto;\n}\n\n\n/**\n * Registers a new custom element with its implementation class.\n * @param {!Window} win The window in which to register the elements.\n * @param {string} name Name of the custom element\n * @param {function(new:BaseElement, !Element)} implementationClass\n */\nexport function registerElement(win, name, implementationClass) {\n  knownElements[name] = implementationClass;\n\n  win.document.registerElement(name, {\n    prototype: createAmpElementProto(win, name, implementationClass)\n  });\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getService} from './service';\nimport {assert} from './asserts';\nimport {parseUrl} from './url';\n\n/**\n * @param {!Window} win\n * @return {{canonicalUrl: string, pageViewId: string}} Info about the doc\n *     - canonicalUrl: The doc's canonical.\n *     - pageViewId: Id for this page view. Low entropy but should be unique\n *       for concurrent page views of a user.\n */\nexport function documentInfoFor(win) {\n  return getService(win, 'documentInfo', () => {\n    return {\n      canonicalUrl: parseUrl(assert(\n          win.document.querySelector('link[rel=canonical]'),\n              'AMP files are required to have a <link rel=canonical> tag.')\n              .href).href,\n      pageViewId: getPageViewId(win),\n    };\n  });\n}\n\n/**\n * Returns a relatively low entropy random string.\n * This should be called once per window and then cached for subsequent\n * access to the same value to be persistent per page.\n * @param {!Window} win\n * @return {string}\n */\nfunction getPageViewId(win) {\n  return String(Math.floor(win.Math.random() * 10000));\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from './observable';\nimport {getService} from './service';\nimport {getVendorJsPropertyName} from './style';\n\n\n/**\n * Whether the document is ready.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isDocumentReady(doc) {\n  return doc.readyState != 'loading';\n}\n\n\n/**\n * Calls the callback when document is ready.\n * @param {!Document} doc\n * @param {!Function} callback\n */\nexport function onDocumentReady(doc, callback) {\n  let ready = isDocumentReady(doc);\n  if (ready) {\n    callback();\n  } else {\n    const readyListener = () => {\n      if (doc.readyState != 'loading') {\n        if (!ready) {\n          ready = true;\n          callback();\n        }\n        doc.removeEventListener('readystatechange', readyListener);\n      }\n    };\n    doc.addEventListener('readystatechange', readyListener);\n  }\n}\n\n/**\n * Returns a promise that is resolved when document is ready.\n * @param {!Document} doc\n * @return {!Promise}\n */\nexport function whenDocumentReady(doc) {\n  return new Promise(resolve => {\n    onDocumentReady(doc, resolve);\n  });\n}\n\n\n/**\n */\nexport class DocumentState {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!Document} */\n    this.document_ = win.document;\n\n    /** @private @const {string|null} */\n    this.hiddenProp_ = getVendorJsPropertyName(this.document_, 'hidden', true);\n    if (this.document_[this.hiddenProp_] === undefined) {\n      this.hiddenProp_ = null;\n    }\n\n    /** @private @const {string|null} */\n    this.visibilityStateProp_ = getVendorJsPropertyName(this.document_,\n        'visibilityState', true);\n    if (this.document_[this.visibilityStateProp_] === undefined) {\n      this.visibilityStateProp_ = null;\n    }\n\n    /** @private @const */\n    this.visibilityObservable_ = new Observable();\n\n    /** @private @const {string|null} */\n    this.visibilityChangeEvent_ = null;\n    if (this.hiddenProp_) {\n      this.visibilityChangeEvent_ = 'visibilitychange';\n      const vendorStop = this.hiddenProp_.indexOf('Hidden');\n      if (vendorStop != -1) {\n        this.visibilityChangeEvent_ =\n            this.hiddenProp_.substring(0, vendorStop) + 'Visibilitychange';\n      }\n    }\n\n    /** @private @const {!Function} */\n    this.boundOnVisibilityChanged_ = this.onVisibilityChanged_.bind(this);\n    if (this.visibilityChangeEvent_) {\n      this.document_.addEventListener(this.visibilityChangeEvent_,\n          this.boundOnVisibilityChanged_);\n    }\n  }\n\n  /** @private */\n  cleanup_() {\n    if (this.visibilityChangeEvent_) {\n      this.document_.removeEventListener(this.visibilityChangeEvent_,\n          this.boundOnVisibilityChanged_);\n    }\n  }\n\n  /**\n   * Whether the document is ready.\n   * @return {boolean}\n   */\n  isReady() {\n    return isDocumentReady(this.document_);\n  }\n\n  /**\n   * Calls the callback when document is ready.\n   * @param {!Function} callback\n   */\n  onReady(callback) {\n    return onDocumentReady(this.document_, callback);\n  }\n\n  /**\n   * Returns the value of \"document.hidden\" property. The reasons why it may\n   * not be visible include document in a non-active tab or when the document\n   * is being pre-rendered via link with rel=\"prerender\".\n   * @return {boolean}\n   */\n  isHidden() {\n    if (!this.hiddenProp_) {\n      return false;\n    }\n    return this.document_[this.hiddenProp_];\n  }\n\n  /**\n   * Returns the value of \"document.visibilityState\" property. Possible values\n   * are: 'hidden', 'visible', 'prerender', and 'unloaded'.\n   * @return {string}\n   */\n  getVisibilityState() {\n    if (!this.visibilityStateProp_) {\n      return !this.isHidden() ? 'visible' : 'hidden';\n    }\n    return this.document_[this.visibilityStateProp_];\n  }\n\n  /**\n   * @param {function()} handler\n   * @return {!UnlistenDef}\n   */\n  onVisibilityChanged(handler) {\n    return this.visibilityObservable_.add(handler);\n  }\n\n  /** @private */\n  onVisibilityChanged_() {\n    this.visibilityObservable_.fire();\n  }\n}\n\n\n/**\n * @param {!Window} window\n * @return {!DocumentState}\n * @private\n */\nfunction createDocumentState_(window) {\n  return new DocumentState(window);\n}\n\n\n/**\n * @param {!Window} window\n * @return {!DocumentState}\n */\nexport function documentStateFor(window) {\n  return getService(window, 'documentState', () => {\n    return createDocumentState_(window);\n  });\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n/**\n * Removes the element.\n * @param {!Element} element\n */\nexport function removeElement(element) {\n  if (element.parentElement) {\n    element.parentElement.removeChild(element);\n  }\n}\n\n\n/**\n * Removes all child nodes of the specified element.\n * @param {!Element} parent\n */\nexport function removeChildren(parent) {\n  while (parent.firstChild) {\n    parent.removeChild(parent.firstChild);\n  }\n}\n\n\n/**\n * Copies all children nodes of element \"from\" to element \"to\". Child nodes\n * are deeply cloned. Notice, that this method should be used with care and\n * preferably on smaller subtrees.\n * @param {!Element} from\n * @param {!Element} to\n */\nexport function copyChildren(from, to) {\n  const frag = to.ownerDocument.createDocumentFragment();\n  for (let n = from.firstChild; n; n = n.nextSibling) {\n    frag.appendChild(n.cloneNode(true));\n  }\n  to.appendChild(frag);\n}\n\n\n/**\n * Finds the closest element that satisfies the callback from this element\n * up the DOM subtree.\n * @param {!Element} element\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function closest(element, callback) {\n  for (let el = element; el; el = el.parentElement) {\n    if (callback(el)) {\n      return el;\n    }\n  }\n  return null;\n}\n\n\n/**\n * Finds the closest element with the specified name from this element\n * up the DOM subtree.\n * @param {!Element} element\n * @param {string} tagName\n * @return {?Element}\n */\nexport function closestByTag(element, tagName) {\n  tagName = tagName.toUpperCase();\n  return closest(element, el => {\n    return el.tagName == tagName;\n  });\n}\n\n\n/**\n * Finds the first descendant element with the specified name.\n * @param {!Element} element\n * @param {string} tagName\n * @return {?Element}\n */\nexport function elementByTag(element, tagName) {\n  const elements = element.getElementsByTagName(tagName);\n  return elements.length > 0 ? elements[0] : null;\n}\n\n\n/**\n * Finds the first child element that satisfies the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function childElement(parent, callback) {\n  const children = parent.children;\n  for (let i = 0; i < children.length; i++) {\n    if (callback(children[i])) {\n      return children[i];\n    }\n  }\n  return null;\n}\n\n\n/**\n * Finds the first child element that has the specified attribute, optionally\n * with a value.\n * @param {!Element} parent\n * @param {string} attr\n * @param {string=} opt_value\n * @return {?Element}\n */\nexport function childElementByAttr(parent, attr, opt_value) {\n  return childElement(parent, el => {\n    if (!el.hasAttribute(attr)) {\n      return false;\n    }\n    if (opt_value !== undefined && el.getAttribute(attr) != opt_value) {\n      return false;\n    }\n    return true;\n  });\n}\n\n\n/**\n * Finds the first child element that has the specified tag name.\n * @param {!Element} parent\n * @param {string} tagName\n * @return {?Element}\n */\nexport function childElementByTag(parent, tagName) {\n  tagName = tagName.toUpperCase();\n  return childElement(parent, el => {\n    return el.tagName == tagName;\n  });\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from './base-element';\n\n\n/** @type {!Array} */\nexport const stubbedElements = [];\n\nexport class ElementStub extends BaseElement {\n  constructor(element) {\n    super(element);\n    stubbedElements.push(this);\n  }\n\n  /** @override */\n  isLayoutSupported(unusedLayout) {\n    // Always returns true and will eventually call this method on the actual\n    // element.\n    return true;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\nimport {getMode} from './mode';\nimport {exponentialBackoff} from './exponential-backoff';\nimport {makeBodyVisible} from './styles';\n\nconst globalExponentialBackoff = exponentialBackoff(1.5);\n\n\n/**\n * Reports an error. If the error has an \"associatedElement\" property\n * the element is marked with the -amp-element-error and displays\n * the message itself. The message is always send to the console.\n * If the error has a \"messageArray\" property, that array is logged.\n * This way one gets the native fidelity of the console for things like\n * elements instead of stringification.\n * @param {!Error} error\n * @param {!Element=} opt_associatedElement\n */\nexport function reportError(error, opt_associatedElement) {\n  if (!window.console) {\n    return;\n  }\n  if (error.reported) {\n    return;\n  }\n  error.reported = true;\n  const element = opt_associatedElement || error.associatedElement;\n  if (element) {\n    element.classList.add('-amp-error');\n    if (getMode().development) {\n      element.classList.add('-amp-element-error');\n      element.setAttribute('error-message', error.message);\n    }\n  }\n  if (error.messageArray) {\n    (console.error || console.log).apply(console,\n        error.messageArray);\n  } else {\n    if (element) {\n      (console.error || console.log).call(console,\n          element.tagName + '#' + element.id, error.message);\n    } else {\n      (console.error || console.log).call(console, error.message);\n    }\n    if (!(process.env.NODE_ENV == 'production')) {\n      (console.error || console.log).call(console, error.stack);\n    }\n  }\n  if (element && element.dispatchCustomEvent) {\n    element.dispatchCustomEvent('amp:error', error.message);\n  }\n  reportErrorToServer(undefined, undefined, undefined, undefined, error);\n}\n\n/**\n * Install handling of global unhandled exceptions.\n * @param {!Window} win\n */\nexport function installErrorReporting(win) {\n  win.onerror = reportErrorToServer;\n}\n\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {!Error|undefined} error\n */\nfunction reportErrorToServer(message, filename, line, col, error) {\n  // Make an attempt to unhide the body.\n  if (this && this.document) {\n    makeBodyVisible(this.document);\n  }\n  const mode = getMode();\n  if (mode.isLocalDev || mode.development || mode.test) {\n    return;\n  }\n  const url = getErrorReportUrl(message, filename, line, col, error);\n  globalExponentialBackoff(() => {\n    new Image().src = url;\n  });\n}\n\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {!Error|undefined} error\n * visibleForTesting\n */\nexport function getErrorReportUrl(message, filename, line, col, error) {\n  message = error && error.message ? error.message : message;\n  if (/_reported_/.test(message)) {\n    return;\n  }\n  if (!message) {\n    message = 'Unknown error';\n  }\n\n  // This is the App Engine app in\n  // ../tools/errortracker\n  // It stores error reports via https://cloud.google.com/error-reporting/\n  // for analyzing production issues.\n  let url = 'https://amp-error-reporting.appspot.com/r' +\n      '?v=' + encodeURIComponent('$internalRuntimeVersion$') +\n      '&m=' + encodeURIComponent(message);\n\n  if (error) {\n    const tagName = error && error.associatedElement\n      ? error.associatedElement.tagName\n      : 'u';  // Unknown\n    // We may want to consider not reporting asserts but for now\n    // this should be helpful.\n    url += '&a=' + (error.fromAssert ? 1 : 0) +\n        '&el=' + encodeURIComponent(tagName) +\n        '&s=' + encodeURIComponent(error.stack || '');\n    error.message += ' _reported_';\n  } else {\n    url += '&f=' + encodeURIComponent(filename) +\n        '&l=' + encodeURIComponent(line) +\n        '&c=' + encodeURIComponent(col || '');\n  }\n\n  // Shorten URLs to a value all browsers will send.\n  return url.substr(0, 2000);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {timer} from './timer';\n\n\n/**\n * Listens for the specified event on the element and removes the listener\n * as soon as event has been received.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(Event)} listener\n * @param {boolean=} opt_capture\n * @return {!UnlistenDef}\n */\nexport function listenOnce(element, eventType, listener, opt_capture) {\n  const capture = opt_capture || false;\n  let unlisten;\n  const proxy = event => {\n    listener(event);\n    unlisten();\n  };\n  unlisten = () => {\n    element.removeEventListener(eventType, proxy, capture);\n  };\n  element.addEventListener(eventType, proxy, capture);\n  return unlisten;\n}\n\n\n/**\n * Returns  a promise that will resolve as soon as the specified event has\n * fired on the element. Optionally, opt_timeout can be specified that will\n * reject the promise if the event has not fired by then.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {boolean=} opt_capture\n * @param {number=} opt_timeout\n * @return {!Promise<!Event>}\n */\nexport function listenOncePromise(element, eventType, opt_capture,\n    opt_timeout) {\n  let unlisten;\n  const eventPromise = new Promise((resolve, unusedReject) => {\n    unlisten = listenOnce(element, eventType, resolve, opt_capture);\n  });\n  return racePromise_(eventPromise, unlisten, opt_timeout);\n}\n\n\n/**\n * Whether the specified element has been loaded already.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isLoaded(element) {\n  return element.complete || element.readyState == 'complete';\n}\n\n\n/**\n * Returns a promise that will resolve or fail based on the element's 'load'\n * and 'error' events. Optionally this method takes a timeout, which will reject\n * the promise if the resource has not loaded by then.\n * @param {!Element} element\n * @param {number=} opt_timeout\n * @return {!Promise<!Element>}\n */\nexport function loadPromise(element, opt_timeout) {\n  let unlistenLoad;\n  let unlistenError;\n  const loadingPromise = new Promise((resolve, reject) => {\n    if (isLoaded(element)) {\n      resolve(element);\n    } else {\n      // Listen once since IE 5/6/7 fire the onload event continuously for\n      // animated GIFs.\n      if (element.tagName === 'AUDIO' || element.tagName === 'VIDEO') {\n        unlistenLoad = listenOnce(element, 'loadstart', () => resolve(element));\n      } else {\n        unlistenLoad = listenOnce(element, 'load', () => resolve(element));\n      }\n      unlistenError = listenOnce(element, 'error', reject);\n    }\n  });\n  return racePromise_(loadingPromise, () => {\n    // It's critical that all listeners are removed.\n    if (unlistenLoad) {\n      unlistenLoad();\n    }\n    if (unlistenError) {\n      unlistenError();\n    }\n  }, opt_timeout);\n}\n\n\n/**\n * @param {!Promise<TYPE>} promise\n * @param {Unlisten|undefined} unlisten\n * @param {number|undefined} timeout\n * @return {!Promise<TYPE>}\n * @template TYPE\n */\nfunction racePromise_(promise, unlisten, timeout) {\n  let racePromise;\n  if (timeout === undefined) {\n    // Timeout is not specified: return promise.\n    racePromise = promise;\n  } else {\n    // Timeout has been specified: add a timeout condition.\n    racePromise = timer.timeoutPromise(timeout || 0, promise);\n  }\n  if (!unlisten) {\n    return racePromise;\n  }\n  return racePromise.then(result => {\n    unlisten();\n    return result;\n  }, reason => {\n    unlisten();\n    throw reason;\n  });\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n/**\n * @param {opt_base} opt_base Exponential base. Defaults to 2.\n * @return {function(function())} Function that when invoked will\n *     call the passed in function. On every invocation the next\n *     invocation of the passed in function will be exponentially\n *     later.\n */\nexport function exponentialBackoff(opt_base) {\n  let count = 0;\n  return work => {\n    let wait = Math.pow(opt_base || 2, count++);\n    // Add jitter to avoid the thundering herd. This can e.g. happen when\n    // we poll a backend and it fails for everyone at the same time.\n    // We wait up to 30% longer or shorter than the time otherwise\n    // given for this cycle.\n    let jitter = wait * .3 * Math.random();\n    if (Math.random() > .5) {\n      jitter *= -1;\n    }\n    wait += jitter;\n    setTimeout(work, Math.round(wait * 1000));\n  };\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from './observable';\nimport {timer} from './timer';\n\n\n/**\n * FocusHistory keeps track of recent focused elements. This history can be\n * purged using `purgeBefore` method.\n */\nexport class FocusHistory {\n  /**\n   * @param {!Window} win\n   * @param {number} purgeTimeout\n   */\n  constructor(win, purgeTimeout) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {number} */\n    this.purgeTimeout_ = purgeTimeout;\n\n    /** @private @const {!Array<!{el: !Element, time: time}>} */\n    this.history_ = [];\n\n    /** @private @const {!Observable<!Element>} */\n    this.observeFocus_ = new Observable();\n\n    /** @private @const {function(!Event)} */\n    this.captureFocus_ = e => {\n      if (e.target) {\n        this.pushFocus_(e.target);\n      }\n    };\n    /** @private @const {function(!Event)} */\n    this.captureBlur_ = unusedE => {\n      // IFrame elements do not receive `focus` event. An alternative way is\n      // implemented here. We wait for a blur to arrive on the main window\n      // and after a short time check which element is active.\n      timer.delay(() => {\n        this.pushFocus_(this.win.document.activeElement);\n      }, 500);\n    };\n    this.win.document.addEventListener('focus', this.captureFocus_, true);\n    this.win.addEventListener('blur', this.captureBlur_);\n  }\n\n  /** @private For testing. */\n  cleanup_() {\n    this.win.document.removeEventListener('focus', this.captureFocus_, true);\n    this.win.removeEventListener('blur', this.captureBlur_);\n  }\n\n  /**\n   * Add a listener for focus events.\n   * @param {function(!Element)} handler\n   * @return {!UnlistenDef}\n   */\n  onFocus(handler) {\n    return this.observeFocus_.add(handler);\n  }\n\n  /**\n   * @param {!Element} element\n   * @private\n   */\n  pushFocus_(element) {\n    const now = timer.now();\n    if (this.history_.length == 0 ||\n            this.history_[this.history_.length - 1].el != element) {\n      this.history_.push({el: element, time: now});\n    } else {\n      this.history_[this.history_.length - 1].time = now;\n    }\n    this.purgeBefore(now - this.purgeTimeout_);\n    this.observeFocus_.fire(element);\n  }\n\n  /**\n   * Returns the element that was focused last.\n   * @return {!Element}\n   */\n  getLast() {\n    if (this.history_.length == 0) {\n      return null;\n    }\n    return this.history_[this.history_.length - 1].el;\n  }\n\n  /**\n   * Removes elements from the history older than the specified time.\n   * @param {time} time\n   */\n  purgeBefore(time) {\n    let index = this.history_.length - 1;\n    for (let i = 0; i < this.history_.length; i++) {\n      if (this.history_[i].time >= time) {\n        index = i - 1;\n        break;\n      }\n    }\n    if (index != -1) {\n      this.history_.splice(0, index + 1);\n    }\n  }\n\n  /**\n   * Returns `true` if the specified element contains any of the elements in\n   * the history.\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  hasDescendantsOf(element) {\n    if (this.win.document.activeElement) {\n      this.pushFocus_(this.win.document.activeElement);\n    }\n    for (let i = 0; i < this.history_.length; i++) {\n      if (element.contains(this.history_[i].el)) {\n        return true;\n      }\n    }\n    return false;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from './observable';\nimport {getService} from './service';\nimport {log} from './log';\nimport {listenOnce, listenOncePromise} from './event-helper';\n\n\nconst TAG_ = 'Input';\n\nconst MAX_MOUSE_CONFIRM_ATTEMPS_ = 3;\nconst CLICK_TIMEOUT_ = 300;\n\n\n/**\n * Detects and maintains different types of input such as touch, mouse or\n * keyboard.\n */\nexport class Input {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private {!Function} */\n    this.boundOnKeyDown_ = this.onKeyDown_.bind(this);\n\n    /** @private {!Function} */\n    this.boundOnMouseDown_ = this.onMouseDown_.bind(this);\n\n    /** @private {!Function} */\n    this.boundOnMouseMove_ = this.onMouseMove_.bind(this);\n\n    /** @private {!Function} */\n    this.boundMouseCanceled_ = this.mouseCanceled_.bind(this);\n\n    /** @private {!Function} */\n    this.boundMouseConfirmed_ = this.mouseConfirmed_.bind(this);\n\n    /** @private {boolean} */\n    this.hasTouch_ = ('ontouchstart' in win ||\n        (win.navigator['maxTouchPoints'] !== undefined &&\n            win.navigator['maxTouchPoints'] > 0) ||\n        win['DocumentTouch'] !== undefined);\n    log.fine(TAG_, 'touch detected:', this.hasTouch_);\n\n    /** @private {boolean} */\n    this.keyboardActive_ = false;\n    this.win.document.addEventListener('keydown', this.boundOnKeyDown_);\n    this.win.document.addEventListener('mousedown', this.boundOnMouseDown_);\n\n    /** @private {boolean} */\n    this.hasMouse_ = true;\n\n    /** @private {number} */\n    this.mouseConfirmAttemptCount_ = 0;\n\n    /** @private {!Observable<boolean>} */\n    this.touchDetectedObservable_ = new Observable();\n\n    /** @private {!Observable<boolean>} */\n    this.mouseDetectedObservable_ = new Observable();\n\n    /** @private {!Observable<boolean>} */\n    this.keyboardStateObservable_ = new Observable();\n\n    // If touch available, temporarily set hasMouse to false and wait for\n    // mouse events.\n    if (this.hasTouch_) {\n      this.hasMouse_ = !this.hasTouch_;\n      listenOnce(win.document, 'mousemove', this.boundOnMouseMove_);\n    }\n  }\n\n  /** @private */\n  cleanup_() {\n    this.win.document.removeEventListener('keydown', this.boundOnKeyDown_);\n    this.win.document.removeEventListener('mousedown', this.boundOnMouseDown_);\n  }\n\n  /**\n   * Whether the touch input has been detected.\n   * @return {boolean}\n   */\n  isTouchDetected() {\n    return this.hasTouch_;\n  }\n\n  /**\n   * Registers an event handle in case if the touch is detected.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  onTouchDetected(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isTouchDetected());\n    }\n    return this.touchDetectedObservable_.add(handler);\n  }\n\n  /**\n   * Whether the mouse input has been detected.\n   * @return {boolean}\n   */\n  isMouseDetected() {\n    return this.hasMouse_;\n  }\n\n  /**\n   * Registers an event handle in case if the mouse is detected.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  onMouseDetected(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isMouseDetected());\n    }\n    return this.mouseDetectedObservable_.add(handler);\n  }\n\n  /**\n   * Whether the keyboard input is currently active.\n   * @return {boolean}\n   */\n  isKeyboardActive() {\n    return this.keyboardActive_;\n  }\n\n  /**\n   * Registers an event handle for changes in the keyboard input.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  onKeyboardStateChanged(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isKeyboardActive());\n    }\n    return this.keyboardStateObservable_.add(handler);\n  }\n\n  /**\n   * @param {!Event} e\n   * @private\n   */\n  onKeyDown_(e) {\n    if (this.keyboardActive_) {\n      return;\n    }\n\n    if (e.defaultPrevented) {\n      return;\n    }\n\n    // Ignore inputs.\n    const target = e.target;\n    if (target && (target.tagName == 'INPUT' ||\n          target.tagName == 'TEXTAREA' ||\n          target.tagName == 'SELECT' ||\n          target.tagName == 'OPTION' ||\n          target.hasAttribute('contenteditable'))) {\n      return;\n    }\n\n    this.keyboardActive_ = true;\n    this.keyboardStateObservable_.fire(true);\n    log.fine(TAG_, 'keyboard activated');\n  }\n\n  /** @private */\n  onMouseDown_() {\n    if (!this.keyboardActive_) {\n      return;\n    }\n    this.keyboardActive_ = false;\n    this.keyboardStateObservable_.fire(false);\n    log.fine(TAG_, 'keyboard deactivated');\n  }\n\n  /** @private */\n  onMouseMove_() {\n    // If \"click\" arrives within a timeout time, this is most likely a\n    // touch/mouse emulation. Otherwise, if timeout exceeded, this looks\n    // like a legitimate mouse event.\n    return listenOncePromise(this.win.document, 'click', false, CLICK_TIMEOUT_)\n        .then(this.boundMouseCanceled_, this.boundMouseConfirmed_);\n  }\n\n  /** @private */\n  mouseConfirmed_() {\n    this.hasMouse_ = true;\n    this.mouseDetectedObservable_.fire(true);\n    log.fine(TAG_, 'mouse detected');\n  }\n\n  /** @private */\n  mouseCanceled_() {\n    // Repeat, if attempts allow.\n    this.mouseConfirmAttemptCount_++;\n    if (this.mouseConfirmAttemptCount_ <= MAX_MOUSE_CONFIRM_ATTEMPS_) {\n      listenOnce(this.win.document, 'mousemove', this.boundOnMouseMove_);\n    } else {\n      log.fine(TAG_, 'mouse detection failed');\n    }\n  }\n}\n\n\n/**\n * @param {!Window} window\n * @return {!Input}\n */\nexport function inputFor(window) {\n  return getService(window, 'input', () => {\n    return new Input(window);\n  });\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assert} from './asserts';\nimport {layoutRectLtwh, rectIntersection, moveLayoutRect} from\n    './layout-rect';\n\n/**\n * Produces a change entry for that should be compatible with\n * IntersectionObserverEntry.\n *\n * Mutates passed in rootBounds to have x and y according to spec.\n *\n * @param {number} time Time when values below were measured.\n * @param {!LayoutRect} rootBounds Equivalent to viewport.getRect()\n * @param {!LayoutRect} elementLayoutBox Layout box of the element\n *     that may intersect with the rootBounds.\n * @return {!IntersectionObserverEntry} A change entry.\n * @private\n */\nexport function getIntersectionChangeEntry(\n    measureTime, rootBounds, elementLayoutBox) {\n  // Building an IntersectionObserverEntry.\n  // http://rawgit.com/slightlyoff/IntersectionObserver/master/index.html#intersectionobserverentry\n  // These should always be equal assuming rootBounds cannot have negative\n  // dimension.\n  rootBounds.x = rootBounds.left;\n  rootBounds.y = rootBounds.top;\n\n  const boundingClientRect =\n      moveLayoutRect(elementLayoutBox, -1 * rootBounds.x, -1 * rootBounds.y);\n  assert(boundingClientRect.width >= 0 &&\n      boundingClientRect.height >= 0, 'Negative dimensions in ad.');\n  boundingClientRect.x = boundingClientRect.left;\n  boundingClientRect.y = boundingClientRect.top;\n\n  const intersectionRect =\n      rectIntersection(rootBounds, elementLayoutBox) ||\n      // No intersection.\n      layoutRectLtwh(0, 0, 0, 0);\n  intersectionRect.x = intersectionRect.left;\n  intersectionRect.y = intersectionRect.top;\n\n  return {\n    time: measureTime,\n    rootBounds,\n    boundingClientRect,\n    intersectionRect,\n  };\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n/**\n * The structure that combines position and size for an element. The exact\n * interpretation of position and size depends on the use case.\n *\n * @typedef {{\n *   top: number,\n *   bottom: number,\n *   left: number,\n *   right: number,\n *   width: number,\n *   height: number\n * }}\n */\nlet LayoutRectDef;\n\n\n/**\n * Creates a layout rect based on the left, top, width and height parameters\n * in that order.\n * @param {number} left\n * @param {number} top\n * @param {number} width\n * @param {number} height\n * @return {!LayoutRectDef}\n */\nexport function layoutRectLtwh(left, top, width, height) {\n  return {\n    left: left,\n    top: top,\n    width: width,\n    height: height,\n    bottom: top + height,\n    right: left + width\n  };\n}\n\n\n/**\n * Creates a layout rect based on the DOMRect, e.g. obtained from calling\n * getBoundingClientRect.\n * @param {!DOMRect} rect\n * @return {!LayoutRectDef}\n */\nexport function layoutRectFromDomRect(rect) {\n  return {\n    left: rect.left,\n    top: rect.top,\n    width: rect.width,\n    height: rect.height,\n    bottom: rect.top + rect.height,\n    right: rect.left + rect.width\n  };\n}\n\n\n/**\n * Returns true if the specified two rects overlap by a single pixel.\n * @param {!LayoutRectDef} r1\n * @param {!LayoutRectDef} r2\n * @return {boolean}\n */\nexport function layoutRectsOverlap(r1, r2) {\n  return (r1.top <= r2.bottom && r2.top <= r1.bottom &&\n      r1.left <= r2.right && r2.left <= r1.right);\n}\n\n\n/**\n * Returns the intersection between a, b or null if there is none.\n * @param {!LayoutRectDef} a\n * @param {!LayoutRectDef} b\n * @return {?LayoutRectDef}\n */\nexport function rectIntersection(a, b) {\n  const x0 = Math.max(a.left, b.left);\n  const x1 = Math.min(a.left + a.width, b.left + b.width);\n\n  if (x0 <= x1) {\n    const y0 = Math.max(a.top, b.top);\n    const y1 = Math.min(a.top + a.height, b.top + b.height);\n\n    if (y0 <= y1) {\n      return layoutRectLtwh(x0, y0, x1 - x0, y1 - y0);\n    }\n  }\n  return null;\n}\n\n\n/**\n * Expand the layout rect using multiples of width and height.\n * @param {!LayoutRectDef} rect Original rect.\n * @param {number} dw Expansion in width, specified as a multiple of width.\n * @param {number} dh Expansion in height, specified as a multiple of height.\n * @return {!LayoutRectDef}\n */\nexport function expandLayoutRect(rect, dw, dh) {\n  return {\n    top: rect.top - rect.height * dh,\n    bottom: rect.bottom + rect.height * dh,\n    left: rect.left - rect.width * dw,\n    right: rect.right + rect.width * dw,\n    width: rect.width * (1 + dw * 2),\n    height: rect.height * (1 + dh * 2)\n  };\n}\n\n\n/**\n * Moves the layout rect using dx and dy.\n * @param {!LayoutRectDef} rect Original rect.\n * @param {number} dx Move horizontally with this value.\n * @param {number} dy Move vertically with this value.\n * @return {!LayoutRectDef}\n */\nexport function moveLayoutRect(rect, dx, dy) {\n  if (dx == 0 && dy == 0) {\n    return rect;\n  }\n  return layoutRectLtwh(rect.left + dx, rect.top + dy,\n      rect.width, rect.height);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Implements element layout. See https://goo.gl/9avXuT for\n * details.\n */\n\nimport {assert} from './asserts';\n\n\n/**\n * @enum {string}\n */\nexport const Layout = {\n  NODISPLAY: 'nodisplay',\n  FIXED: 'fixed',\n  FIXED_HEIGHT: 'fixed-height',\n  RESPONSIVE: 'responsive',\n  CONTAINER: 'container',\n  FILL: 'fill'\n};\n\n\n/**\n * CSS Length type. E.g. \"1px\" or \"20vh\".\n * @typedef {string}\n */\nlet LengthDef;\n\n\n/**\n * @typedef {{\n *   width: string,\n *   height: string\n * }}\n */\nlet DimensionsDef;\n\n\n/**\n * The set of elements with natural dimensions, that is, elements\n * which have a known dimension either based on their value specified here,\n * or, if the value is null, a dimension specific to the browser.\n * `hasNaturalDimensions` checks for membership in this set.\n * `getNaturalDimensions` determines the dimensions for an element in the\n *    set and caches it.\n * @type {!Object<string, ?DimensionsDef>}\n * @private  Visible for testing only!\n */\nexport const naturalDimensions_ = {\n  'AMP-PIXEL': {width: '1px', height: '1px'},\n  'AMP-ANALYTICS': {width: '1px', height: '1px'},\n  // TODO(dvoytenko): audio should have width:auto.\n  'AMP-AUDIO': null\n};\n\n\n/**\n * Elements that the progess can be shown for. This set has to be externalized\n * since the element's implementation may not be downloaded yet.\n * @enum {boolean}\n * @private  Visible for testing only!\n */\nexport const LOADING_ELEMENTS_ = {\n  'AMP-ANIM': true,\n  'AMP-BRIGHTCOVE': true,\n  'AMP-IFRAME': true,\n  'AMP-IMG': true,\n  'AMP-INSTAGRAM': true,\n  'AMP-LIST': true,\n  'AMP-PINTEREST': true,\n  'AMP-VIDEO': true\n};\n\n\n/**\n * @param {string} s\n * @return {Layout|undefined} Returns undefined in case of failure to parse\n *   the layout string.\n */\nexport function parseLayout(s) {\n  for (const k in Layout) {\n    if (Layout[k] == s) {\n      return Layout[k];\n    }\n  }\n  return undefined;\n}\n\n\n/**\n * @param {!Layout} layout\n * @return {string}\n */\nexport function getLayoutClass(layout) {\n  return '-amp-layout-' + layout;\n}\n\n\n/**\n * Whether an element with this layout inherently defines the size.\n * @param {!Layout} layout\n * @return {boolean}\n */\nexport function isLayoutSizeDefined(layout) {\n  return (layout == Layout.FIXED ||\n      layout == Layout.FIXED_HEIGHT ||\n      layout == Layout.RESPONSIVE ||\n      layout == Layout.FILL);\n}\n\n\n/**\n * Whether the tag is an internal (service) AMP tag.\n * @param {!Node|string} tag\n * @return {boolean}\n */\nexport function isInternalElement(tag) {\n  const tagName = (typeof tag == 'string') ? tag : tag.tagName;\n  return tagName && tagName.toLowerCase().indexOf('i-') == 0;\n}\n\n\n/**\n * Parses the CSS length value. If no units specified, the assumed value is\n * \"px\". Returns undefined in case of parsing error.\n * @param {string|undefined} s\n * @return {!LengthDef|undefined}\n */\nexport function parseLength(s) {\n  if (typeof s == 'number') {\n    return s + 'px';\n  }\n  if (!s) {\n    return undefined;\n  }\n  if (!/^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax)?$/.test(s)) {\n    return undefined;\n  }\n  if (/^\\d+(\\.\\d+)?$/.test(s)) {\n    return s + 'px';\n  }\n  return s;\n}\n\n\n/**\n * Asserts that the supplied value is a CSS Length value.\n * @param {!LengthDef|string} length\n * @return {!LengthDef}\n */\nexport function assertLength(length) {\n  assert(/^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax)$/.test(length),\n      'Invalid length value: %s', length);\n  return length;\n}\n\n\n/**\n * Returns units from the CSS length value.\n * @param {!LengthDef} length\n * @return {string}\n */\nexport function getLengthUnits(length) {\n  assertLength(length);\n  const m = assert(length.match(/[a-z]+/i),\n      'Failed to read units from %s', length);\n  return m[0];\n}\n\n\n/**\n * Returns the numeric value of a CSS length value.\n * @param {!LengthDef|string} length\n * @return {number}\n */\nexport function getLengthNumeral(length) {\n  return parseFloat(length);\n}\n\n\n/**\n * Determines whether the tagName is a known element that has natural dimensions\n * in our runtime or the browser.\n * @param {string} tagName The element tag name.\n * @return {DimensionsDef}\n */\nexport function hasNaturalDimensions(tagName) {\n  tagName = tagName.toUpperCase();\n  return naturalDimensions_[tagName] !== undefined;\n}\n\n\n/**\n * Determines the default dimensions for an element which could vary across\n * different browser implementations, like <audio> for instance.\n * This operation can only be completed for an element whitelisted by\n * `hasNaturalDimensions`.\n * @param {string} tagName The element tag name.\n * @return {DimensionsDef}\n */\nexport function getNaturalDimensions(tagName) {\n  tagName = tagName.toUpperCase();\n  assert(naturalDimensions_[tagName] !== undefined);\n  if (!naturalDimensions_[tagName]) {\n    const naturalTagName = tagName.replace(/^AMP\\-/, '');\n    const temp = document.createElement(naturalTagName);\n    // For audio, should no-op elsewhere.\n    temp.controls = true;\n    temp.style.position = 'absolute';\n    temp.style.visibility = 'hidden';\n    document.body.appendChild(temp);\n    naturalDimensions_[tagName] = {\n      width: (temp./*OK*/offsetWidth || 1) + 'px',\n      height: (temp./*OK*/offsetHeight || 1) + 'px'\n    };\n    document.body.removeChild(temp);\n  }\n  return naturalDimensions_[tagName];\n}\n\n\n/**\n * Whether the loading can be shown for the specified elemeent. This set has\n * to be externalized since the element's implementation may not be\n * downloaded yet.\n * @param {string} tagName The element tag name.\n * @return {boolean}\n */\nexport function isLoadingAllowed(tagName) {\n  return LOADING_ELEMENTS_[tagName.toUpperCase()] || false;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n/**\n * Creates a default \"loading indicator\" element. This element accepts\n * `amp-active` class in which case it may choose to run an animation.\n * @return {!Element}\n */\nexport function createLoaderElement() {\n  const loader = document.createElement('div');\n  loader.classList.add('-amp-loader');\n  for (let i = 0; i < 3; i++) {\n    const dot = document.createElement('div');\n    dot.classList.add('-amp-loader-dot');\n    loader.appendChild(dot);\n  }\n  return loader;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from './mode';\n\n/** @const Time when this JS loaded.  */\nconst start = new Date().getTime();\n\n\n/**\n * Logging.\n * // TODO(@cramforce): Make this DCRable.\n * Add #log=1 to URL to turn on logging when in prod (providing a build with\n * logging is used and #log=0 to turn off logging in local dev.\n * @final\n */\nexport class Log {\n\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /**\n     * In tests we use the main test window instead of the iframe where\n     * the tests runs because only the former is relayed to the console.\n     * @const {!Window}\n     */\n    this.win = win.AMP_TEST ? win.parent : win;\n\n    /** @private {boolean} */\n    this.isEnabled_ = this.shouldBeEnabled_();\n  }\n\n  shouldBeEnabled_() {\n    if (!this.win.console || !this.win.console.log) {\n      return false;\n    }\n    // Search for #log=0 or log=1\n    const match = this.win.location.hash.match(/log=(\\d)/);\n    const shouldLog = match && match[1];\n    if (getMode().localDev && shouldLog != '0') {\n      return true;\n    }\n    if (this.win.location.hash && shouldLog == '1') {\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * @param {string} tag\n   * @param {string} level\n   * @param {!Array} messages\n   * @param {?} opt_error\n   */\n  msg_(tag, level, messages) {\n    if (this.isEnabled_) {\n      let fn = this.win.console.log;\n      if (level == 'ERROR') {\n        fn = this.win.console.error || fn;\n      } else if (level == 'INFO') {\n        fn = this.win.console.info || fn;\n      } else if (level == 'WARN') {\n        fn = this.win.console.warn || fn;\n      }\n      messages.unshift(new Date().getTime() - start, '[' + tag + ']');\n      fn.apply(this.win.console, messages);\n    }\n  }\n\n  /**\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  fine(tag, var_args) {\n    if (this.isEnabled_) {\n      this.msg_(tag, 'FINE', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n\n  /**\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  info(tag, var_args) {\n    if (this.isEnabled_) {\n      this.msg_(tag, 'INFO', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n\n  /**\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  warn(tag, var_args) {\n    if (this.isEnabled_) {\n      this.msg_(tag, 'WARN', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n\n  /**\n   * @param {string} tag\n   * @param {...*} var_args\n   * @param {?} opt_error\n   */\n  error(tag, var_args) {\n    if (this.isEnabled_) {\n      this.msg_(tag, 'ERROR', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n};\n\n\nexport const log = new Log(window);\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {parseQueryString} from './url';\n\n\n/**\n * @typedef {{\n *   localDev: boolean\n * }}\n */\nlet ModeDef;\n\n/** @typedef {?ModeDef} */\nlet mode = null;\n\n/**\n * Provides info about the current app.\n * @return {!ModeDef}\n */\nexport function getMode() {\n  if (mode) {\n    return mode;\n  }\n  return mode = getMode_();\n}\n\n/**\n * Set mode in a test. Pass null in afterEach function to reset.\n * @param {?ModeDef} m\n */\nexport function setModeForTesting(m) {\n  mode = m;\n}\n\n/**\n * Provides info about the current app.\n * @return {!ModeDef}\n */\nfunction getMode_() {\n  const isLocalDev = (location.hostname == 'localhost' ||\n      (location.ancestorOrigins && location.ancestorOrigins[0] &&\n          location.ancestorOrigins[0].indexOf('http://localhost:') == 0)) &&\n      // Filter out localhost running against a prod script.\n      // Because all allowed scripts are ours, we know that these can only\n      // occur during local dev.\n      !!document.querySelector('script[src*=\"/dist/\"],script[src*=\"/base/\"]');\n\n  const overrideDevelopment = parseQueryString(location.hash)['development'];\n  const development = overrideDevelopment != undefined\n      ? overrideDevelopment == '1'\n      : !!document.querySelector('script[development]');\n\n  return {\n    localDev: isLocalDev,\n    // Triggers validation\n    development: development,\n    minified: process.env.NODE_ENV == 'production',\n    test: window.AMP_TEST\n  };\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n/**\n * This type signifies a callback that can be called to remove the listener.\n * @typedef {function()}\n */\nclass UnlistenDef {}\n\n\n/**\n * This class helps to manage observers. Observers can be added, removed or\n * fired through and instance of this class.\n * @template TYPE\n */\nexport class Observable {\n\n  constructor() {\n    /** @const {!Array<function(TYPE)>} */\n    this.handlers_ = [];\n  }\n\n  /**\n   * Adds the observer to this instance.\n   * @param {function(TYPE)} handler Observer's handler.\n   * @return {!UnlistenDef}\n   */\n  add(handler) {\n    this.handlers_.push(handler);\n    return () => {\n      this.remove(handler);\n    };\n  }\n\n  /**\n   * Removes the observer from this instance.\n   * @param {function(TYPE)} handler Observer's instance.\n   */\n  remove(handler) {\n    for (let i = 0; i < this.handlers_.length; i++) {\n      if (handler == this.handlers_[i]) {\n        this.handlers_.splice(i, 1);\n        break;\n      }\n    }\n  }\n\n  /**\n   * Fires an event. All observers are called.\n   * @param {TYPE} event\n   */\n  fire(event) {\n    this.handlers_.forEach(handler => {\n      handler(event);\n    });\n  }\n\n  /**\n   * Returns number of handlers. Mostly needed for tests.\n   * @return {number}\n   */\n  getHandlerCount() {\n    return this.handlers_.length;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {timer} from './timer';\n\n\n/**\n * Pass class helps to manage single-pass process. A pass is scheduled using\n * delay method. Only one pass can be pending at a time. If no pass is pending\n * the process is considered to be \"idle\".\n */\nexport class Pass {\n\n  /**\n   * Creates a new Pass instance.\n   * @param {function()} handler Handler to be executed when pass is triggered.\n   * @param {number=} opt_defaultDelay Default delay to be used when schedule\n   *   is called without one.\n   */\n  constructor(handler, opt_defaultDelay) {\n    /** @private @const {function()} */\n    this.handler_ = handler;\n\n    /** @private @const {number|string} */\n    this.defaultDelay_ = opt_defaultDelay || 0;\n\n    /** @private {number|string} */\n    this.scheduled_ = -1;\n\n    /** @private {number} */\n    this.nextTime_ = 0;\n\n    /** @private {boolean} */\n    this.running_ = false;\n  }\n\n  /**\n   * Whether or not a pass is currently pending.\n   * @return {boolean}\n   */\n  isPending() {\n    return this.scheduled_ != -1;\n  }\n\n  /**\n   * Tries to schedule a new pass optionally with specified delay. If the new\n   * requested pass is requested before the pending pass, the pending pass is\n   * canceled. If the new pass is requested after the pending pass, the newly\n   * requested pass is ignored.\n   *\n   * Returns {@code true} if the pass has been scheduled and {@code false} if\n   * ignored.\n   *\n   * @param {number=} opt_delay Delay to schedule the pass. If not specified\n   *   the default delay is used, falling back to 0.\n   * @return {boolean}\n   */\n  schedule(opt_delay) {\n    let delay = opt_delay || this.defaultDelay_;\n    if (this.running_ && delay < 10) {\n      // If we get called recursively, wait at least 10ms for the next\n      // execution.\n      delay = 10;\n    }\n    const nextTime = timer.now() + delay;\n    // Schedule anew if nothing is scheduled currently of if the new time is\n    // sooner then previously requested.\n    if (this.scheduled_ == -1 || nextTime - this.nextTime_ < -10) {\n      if (this.scheduled_ != -1) {\n        timer.cancel(this.scheduled_);\n      }\n      this.nextTime_ = nextTime;\n      this.scheduled_ = timer.delay(() => {\n        this.scheduled_ = -1;\n        this.nextTime_ = 0;\n        this.running_ = true;\n        this.handler_();\n        this.running_ = false;\n      }, delay);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Cancels the pending pass if any.\n   */\n  cancel() {\n    if (this.scheduled_ != -1) {\n      timer.cancel(this.scheduled_);\n      this.scheduled_ = -1;\n    }\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getService} from './service';\n\n\n/**\n * A helper class that provides information about device/OS/browser currently\n * running.\n */\nexport class Platform {\n\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n  }\n\n  /**\n   * Whether the current platform an iOS device.\n   * @return {boolean}\n   */\n  isIos() {\n    return /iPhone|iPad|iPod/i.test(this.win.navigator.userAgent);\n  }\n\n  /**\n   * Whether the current browser is Safari.\n   * @return {boolean}\n   */\n  isSafari() {\n    return /Safari/i.test(this.win.navigator.userAgent) && !this.isChrome();\n  }\n\n  /**\n   * Whether the current browser a Chrome browser.\n   * @return {boolean}\n   */\n  isChrome() {\n    // Also true for MS Edge :)\n    return /Chrome|CriOS/i.test(this.win.navigator.userAgent);\n  }\n};\n\n\n/**\n * @param {!Window} window\n * @return {!Platform}\n */\nexport function platformFor(window) {\n  return getService(window, 'platform', () => {\n    return new Platform(window);\n  });\n};\n\nexport const platform = platformFor(window);\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Provides a services to preconnect to a url to warm up the\n * connection before the real request can be made.\n */\n\n\nimport {getService} from './service';\nimport {parseUrl} from './url';\nimport {timer} from './timer';\nimport {platformFor} from './platform';\n\nconst ACTIVE_CONNECTION_TIMEOUT_MS = 180 * 1000;\nconst PRECONNECT_TIMEOUT_MS = 10 * 1000;\n\nclass Preconnect {\n\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Element} */\n    this.head_ = win.document.head;\n    /**\n     * Origin we've preconnected to and when that connection\n     * expires as a timestamp in MS.\n     * @private @const {!Object<string, number>}\n     */\n    this.origins_ = {};\n    /**\n     * Urls we've prefetched.\n     * @private @const {!Object<string, boolean>}\n     */\n    this.urls_ = {};\n    /** @private @const {!Platform}  */\n    this.platform_ = platformFor(win);\n    // Mark current origin as preconnected.\n    this.origins_[parseUrl(win.location.href).origin] = true;\n  }\n\n  /**\n   * Preconnects to a URL. Always also does a dns-prefetch because\n   * browser support for that is better.\n   * @param {string} url\n   * @param {boolean=} opt_alsoConnecting Set this flag if you also just\n   *    did or are about to connect to this host. This is for the case\n   *    where preconnect is issued immediate before or after actual connect\n   *    and preconnect is used to flatten a deep HTTP request chain.\n   *    E.g. when you preconnect to a host that an embed will connect to\n   *    when it is more fully rendered, you already know that the connection\n   *    will be used very soon.\n   */\n  url(url, opt_alsoConnecting) {\n    if (!this.isInterestingUrl_(url)) {\n      return;\n    }\n    const origin = parseUrl(url).origin;\n    const now = timer.now();\n    const lastPreconnectTimeout = this.origins_[origin];\n    if (lastPreconnectTimeout && now < lastPreconnectTimeout) {\n      if (opt_alsoConnecting) {\n        this.origins_[origin] = now + ACTIVE_CONNECTION_TIMEOUT_MS ;\n      }\n      return;\n    }\n    // If we are about to use the connection, don't re-preconnect for\n    // 180 seconds.\n    const timeout = opt_alsoConnecting\n        ? ACTIVE_CONNECTION_TIMEOUT_MS\n        : PRECONNECT_TIMEOUT_MS;\n    this.origins_[origin] = now + timeout;\n    const dns = document.createElement('link');\n    dns.setAttribute('rel', 'dns-prefetch');\n    dns.setAttribute('href', origin);\n    const preconnect = document.createElement('link');\n    preconnect.setAttribute('rel', 'preconnect');\n    preconnect.setAttribute('href', origin);\n    this.head_.appendChild(dns);\n    this.head_.appendChild(preconnect);\n\n    // Remove the tags eventually to free up memory.\n    timer.delay(() => {\n      if (dns.parentNode) {\n        dns.parentNode.removeChild(dns);\n      }\n      if (preconnect.parentNode) {\n        preconnect.parentNode.removeChild(preconnect);\n      }\n    }, 10000);\n\n    this.preconnectPolyfill_(origin);\n  }\n\n  /**\n   * Asks the browser to prefetch a URL. Always also does a preconnect\n   * because browser support for that is better.\n   * @param {string} url\n   */\n  prefetch(url) {\n    if (!this.isInterestingUrl_(url)) {\n      return;\n    }\n    if (this.urls_[url]) {\n      return;\n    }\n    this.urls_[url] = true;\n    this.url(url, /* opt_alsoConnecting */ true);\n    const prefetch = document.createElement('link');\n    prefetch.setAttribute('rel', 'prefetch');\n    prefetch.setAttribute('href', url);\n    this.head_.appendChild(prefetch);\n    // As opposed to preconnect we do not clean this tag up, because there is\n    // no expectation as to it having an immediate effect.\n  }\n\n  isInterestingUrl_(url) {\n    if (url.indexOf('https:') == 0 || url.indexOf('http:') == 0) {\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Safari does not support preconnecting, but due to its significant\n   * performance benefits we implement this crude polyfill.\n   *\n   * We make an image connection to a \"well-known\" file on the origin adding\n   * a random query string to bust the cache (no caching because we do want to\n   * actually open the connection).\n   *\n   * This should get us an open SSL connection to these hosts and significantly\n   * speed up the next connections.\n   *\n   * The actual URL is expected to 404. If you see errors for\n   * amp_preconnect_polyfill in your DevTools console or server log:\n   * This is expected and fine to leave as is. Its fine to send a non 404\n   * response, but please make it small :)\n   */\n  preconnectPolyfill_(origin) {\n    // Unfortunately there is no way to feature detect whether preconnect is\n    // supported, so we do this only in Safari, which is the most important\n    // browser without support for it. This needs to be removed should it\n    // ever add support.\n    if (!this.platform_.isSafari()) {\n      return;\n    }\n    // Don't attempt to preconnect for ACTIVE_CONNECTION_TIMEOUT_MS since\n    // we effectively create an active connection.\n    // TODO(@cramforce): Confirm actual http2 timeout in Safari.\n    this.origins_[origin] = timer.now() + ACTIVE_CONNECTION_TIMEOUT_MS;\n    const url = origin + '/amp_preconnect_polyfill?' + Math.random();\n    // We use an XHR without withCredentials(true), so we do not send cookies\n    // to the host and the host cannot set cookies.\n    const xhr = new XMLHttpRequest();\n    xhr.open('HEAD', url, true);\n    xhr.send();\n  }\n}\n\n/**\n * @param {!Window} window\n * @return {!Preconnect}\n */\nexport function preconnectFor(window) {\n  return getService(window, 'preconnect', () => {\n    return new Preconnect(window);\n  });\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {FocusHistory} from './focus-history';\nimport {Pass} from './pass';\nimport {assert} from './asserts';\nimport {closest} from './dom';\nimport {documentStateFor} from './document-state';\nimport {expandLayoutRect, layoutRectLtwh, layoutRectsOverlap} from\n    './layout-rect';\nimport {getService} from './service';\nimport {inputFor} from './input';\nimport {log} from './log';\nimport {reportError} from './error';\nimport {timer} from './timer';\nimport {viewerFor} from './viewer';\nimport {viewportFor} from './viewport';\nimport {vsyncFor} from './vsync';\n\nconst TAG_ = 'Resources';\nconst RESOURCE_PROP_ = '__AMP__RESOURCE';\nconst OWNER_PROP_ = '__AMP__OWNER';\nconst LAYOUT_TASK_ID_ = 'L';\nconst LAYOUT_TASK_OFFSET_ = 0;\nconst PRELOAD_TASK_ID_ = 'P';\nconst PRELOAD_TASK_OFFSET_ = 2;\nconst PRIORITY_BASE_ = 10;\nconst PRIORITY_PENALTY_TIME_ = 1000;\nconst POST_TASK_PASS_DELAY_ = 1000;\nconst MUTATE_DEFER_DELAY_ = 500;\nconst FOCUS_HISTORY_TIMEOUT_ = 1000 * 60;  // 1min\n\n\n/**\n * Returns the element-based priority. A value from 0 to 10.\n * @param {string} tagName\n * @return {number}\n */\nexport function getElementPriority(tagName) {\n  tagName = tagName.toLowerCase();\n  if (tagName == 'amp-ad') {\n    return 2;\n  }\n  if (tagName == 'amp-pixel') {\n    return 1;\n  }\n  return 0;\n}\n\n\nexport class Resources {\n  constructor(window) {\n    /** @const {!Window} */\n    this.win = window;\n\n    /** @const {!Viewer} */\n    this.viewer_ = viewerFor(window);\n\n    /** @private {boolean} */\n    this.isRuntimeOn_ = this.viewer_.isRuntimeOn();\n\n    /** @private @const {number} */\n    this.maxDpr_ = this.win.devicePixelRatio || 1;\n\n    /** @private {number} */\n    this.resourceIdCounter_ = 0;\n\n    /** @private @const {!Array<!Resource>} */\n    this.resources_ = [];\n\n    /** @private {boolean} */\n    this.visible_ = this.viewer_.isVisible();\n\n    /** @private {number} */\n    this.prerenderSize_ = this.viewer_.getPrerenderSize();\n\n    /** @private {boolean} */\n    this.documentReady_ = false;\n\n    /**\n     * We want to do some work in the first pass after\n     * the document is ready.\n     * @private {boolean}\n     */\n    this.firstPassAfterDocumentReady_ = true;\n\n    /** @private {boolean} */\n    this.relayoutAll_ = true;\n\n    /** @private {number} */\n    this.relayoutTop_ = -1;\n\n    /** @private {boolean} */\n    this.forceBuild_ = false;\n\n    /** @private {time} */\n    this.lastScrollTime_ = 0;\n\n    /** @private {number} */\n    this.lastVelocity_ = 0;\n\n    /** @const {!Pass} */\n    this.pass_ = new Pass(() => this.doPass_());\n\n    /** @const {!TaskQueue_} */\n    this.exec_ = new TaskQueue_();\n\n    /** @const {!TaskQueue_} */\n    this.queue_ = new TaskQueue_();\n\n    /**\n     * @private {!Array<{resource: !Resource, newHeight: number,\n     *     force: boolean}>}\n     */\n    this.requestsChangeHeight_ = [];\n\n    /** @private {!Array<!Function>} */\n    this.deferredMutates_ = [];\n\n    /** @private {number} */\n    this.scrollHeight_ = 0;\n\n    /** @private @const {!Viewport} */\n    this.viewport_ = viewportFor(this.win);\n\n    /** @private @const {!Vsync} */\n    this.vsync_ = vsyncFor(this.win);\n\n    /** @private @const {!DocumentState} */\n    this.docState_ = documentStateFor(this.win);\n\n    /** @private @const {!FocusHistory} */\n    this.activeHistory_ = new FocusHistory(this.win, FOCUS_HISTORY_TIMEOUT_);\n\n    /** @private {boolean} */\n    this.vsyncScheduled_ = false;\n\n    // When viewport is resized, we have to re-measure all elements.\n    this.viewport_.onChanged(event => {\n      this.lastScrollTime_ = timer.now();\n      this.lastVelocity_ = event.velocity;\n      this.relayoutAll_ = this.relayoutAll_ || event.relayoutAll;\n      this.schedulePass();\n    });\n    this.viewport_.onScroll(() => {\n      this.lastScrollTime_ = timer.now();\n    });\n\n    // When document becomes visible, e.g. from \"prerender\" mode, do a\n    // simple pass.\n    this.viewer_.onVisibilityChanged(() => {\n      this.schedulePass();\n    });\n\n    this.viewer_.onRuntimeState(state => {\n      log.fine(TAG_, 'Runtime state:', state);\n      this.isRuntimeOn_ = state;\n      this.schedulePass(1);\n    });\n\n    this.activeHistory_.onFocus(element => {\n      this.checkPendingChangeHeight_(element);\n    });\n\n    // Ensure that we attempt to rebuild things when DOM is ready.\n    this.docState_.onReady(() => {\n      this.documentReady_ = true;\n      this.forceBuild_ = true;\n      this.relayoutAll_ = true;\n      this.schedulePass();\n      this.monitorInput_();\n    });\n\n    this.schedulePass();\n  }\n\n  /**\n   * Returns a list of resources.\n   * @return {!Array<!Resource>}\n   * @export\n   */\n  get() {\n    return this.resources_.slice(0);\n  }\n\n  /** @private */\n  monitorInput_() {\n    const input = inputFor(this.win);\n    input.onTouchDetected(detected => {\n      this.toggleInputClass_('amp-mode-touch', detected);\n    }, true);\n    input.onMouseDetected(detected => {\n      this.toggleInputClass_('amp-mode-mouse', detected);\n    }, true);\n    input.onKeyboardStateChanged(active => {\n      this.toggleInputClass_('amp-mode-keyboard-active', active);\n    }, true);\n  }\n\n  /**\n   * @param {string} clazz\n   * @param {boolean} on\n   * @private\n   */\n  toggleInputClass_(clazz, on) {\n    this.vsync_.mutate(() => {\n      this.win.document.body.classList.toggle(clazz, on);\n    });\n  }\n\n  /** @private */\n  updateScrollHeight_() {\n    if (!this.win.document.body) {\n      return;\n    }\n    const scrollHeight = this.win.document.body./*OK*/scrollHeight;\n    if (scrollHeight != this./*OK*/scrollHeight_) {\n      this./*OK*/scrollHeight_ = scrollHeight;\n      this.viewer_.postDocumentResized(this.viewport_.getSize().width,\n          scrollHeight);\n    }\n  }\n\n  /**\n   * Returns the maximum DPR available on this device.\n   * @return {number}\n   */\n  getMaxDpr() {\n    return this.maxDpr_;\n  }\n\n  /**\n   * Returns the most optimal DPR currently recommended.\n   * @return {number}\n   */\n  getDpr() {\n    // TODO(dvoytenko): return optimal DPR.\n    return this.maxDpr_;\n  }\n\n  /**\n   * Returns the {@link Resource} instance corresponding to the specified AMP\n   * Element. If no Resource is found, the exception is thrown.\n   * @param {!AmpElement} element\n   * @return {?Resource}\n   * @package\n   */\n  getResourceForElement(element) {\n    return assert(/** @type {!Resource} */ (element[RESOURCE_PROP_]),\n        'Missing resource prop on %s', element);\n  }\n\n  /**\n   * Signals that an element has been added to the DOM. Resources manager\n   * will start tracking it from this point on.\n   * @param {!AmpElement} element\n   * @package\n   */\n  add(element) {\n    const resource = new Resource((++this.resourceIdCounter_), element, this);\n    if (!element.id) {\n      element.id = 'AMP_' + resource.getId();\n    }\n    element[RESOURCE_PROP_] = resource;\n    this.resources_.push(resource);\n\n    if (this.isRuntimeOn_) {\n      // Try to immediately build element, it may already be ready.\n      resource.build(this.forceBuild_);\n      this.schedulePass();\n    }\n\n    log.fine(TAG_, 'element added:', resource.debugid);\n  }\n\n  /**\n   * Signals that an element has been removed to the DOM. Resources manager\n   * will stop tracking it from this point on.\n   * @param {!AmpElement} element\n   * @package\n   */\n  remove(element) {\n    const resource = this.getResourceForElement(element);\n    const index = resource ? this.resources_.indexOf(resource) : -1;\n    if (index != -1) {\n      this.resources_.splice(index, 1);\n    }\n    log.fine(TAG_, 'element removed:', resource.debugid);\n  }\n\n  /**\n   * Signals that an element has been upgraded to the DOM. Resources manager\n   * will perform build and enable layout/viewport signals for this element.\n   * @param {!AmpElement} element\n   * @package\n   */\n  upgraded(element) {\n    const resource = this.getResourceForElement(element);\n    if (this.isRuntimeOn_) {\n      resource.build(this.forceBuild_);\n      this.schedulePass();\n    } else if (resource.onUpgraded_) {\n      resource.onUpgraded_();\n    }\n    log.fine(TAG_, 'element upgraded:', resource.debugid);\n  }\n\n  /**\n   * Assigns an owner for the specified element. This means that the resources\n   * within this element will be managed by the owner and not Resources manager.\n   * @param {!Element} element\n   * @param {!AmpElement} owner\n   * @package\n   */\n  setOwner(element, owner) {\n    assert(owner.contains(element), 'Owner must contain the element');\n    element[OWNER_PROP_] = owner;\n  }\n\n  /**\n   * Schedules layout for the specified sub-elements that are children of the\n   * parent element. The parent element may choose to send this signal either\n   * because it's an owner (see {@link setOwner}) or because it wants the\n   * layouts to be done sooner. In either case, both parent's and children's\n   * priority is observed when scheduling this work.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  scheduleLayout(parentElement, subElements) {\n    this.scheduleLayoutOrPreloadForSubresources_(\n        this.getResourceForElement(parentElement),\n        /* layout */ true,\n        elements_(subElements));\n  }\n\n  /**\n   * Schedules preload for the specified sub-elements that are children of the\n   * parent element. The parent element may choose to send this signal either\n   * because it's an owner (see {@link setOwner}) or because it wants the\n   * preloads to be done sooner. In either case, both parent's and children's\n   * priority is observed when scheduling this work.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  schedulePreload(parentElement, subElements) {\n    this.scheduleLayoutOrPreloadForSubresources_(\n        this.getResourceForElement(parentElement),\n        /* layout */ false,\n        elements_(subElements));\n  }\n\n  /**\n   * A parent resource, especially in when it's an owner (see {@link setOwner}),\n   * may request the Resources manager to update children's inViewport state.\n   * A child's inViewport state is a logical AND between inLocalViewport\n   * specified here and parent's own inViewport state.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   * @param {boolean} inLocalViewport\n   */\n  updateInViewport(parentElement, subElements, inLocalViewport) {\n    this.updateInViewportForSubresources_(\n        this.getResourceForElement(parentElement),\n        elements_(subElements),\n        inLocalViewport);\n  }\n\n  /**\n   * Requests the runtime to change the element's height.\n   * @param {!Element} element\n   * @param {number} newHeight\n   */\n  changeHeight(element, newHeight) {\n    this.scheduleChangeHeight_(this.getResourceForElement(element), newHeight,\n        /* force */ true);\n  }\n\n  /**\n   * Requests the runtime to update the height of this element to the specified\n   * value. The runtime will schedule this request and attempt to process it\n   * as soon as possible. However, unlike in {@link changeHeight}, the runtime\n   * may refuse to make a change in which case it will call the\n   * `overflowCallback` method on the target resource with the height value.\n   * Overflow callback is expected to provide the reader with the user action\n   * to update the height manually.\n   * @param {!Element} element\n   * @param {number} newHeight\n   * @protected\n   */\n  requestChangeHeight(element, newHeight) {\n    this.scheduleChangeHeight_(this.getResourceForElement(element), newHeight,\n        /* force */ false);\n  }\n\n  /**\n   * Requests mutate callback to executed at the earliest possibility.\n   * @param {!Element} element\n   * @param {!Function} callback\n   */\n  deferMutate(element, callback) {\n    this.scheduleDeferredMutate_(this.getResourceForElement(element), callback);\n    this.schedulePassVsync();\n  }\n\n  /**\n   * Schedules the work pass at the latest with the specified delay.\n   * @param {number=} opt_delay\n   */\n  schedulePass(opt_delay) {\n    this.pass_.schedule(opt_delay);\n  }\n\n  /**\n   * Schedules the work pass at the latest with the specified delay.\n   */\n  schedulePassVsync() {\n    if (this.vsyncScheduled_) {\n      return;\n    }\n    this.vsyncScheduled_ = true;\n    this.vsync_.mutate(() => this.doPass_());\n  }\n\n  /**\n   * @private\n   */\n  doPass_() {\n    if (!this.isRuntimeOn_) {\n      log.fine(TAG_, 'runtime is off');\n      return;\n    }\n\n    const prevVisible = this.visible_;\n    this.visible_ = this.viewer_.isVisible();\n    this.prerenderSize_ = this.viewer_.getPrerenderSize();\n\n    if (this.documentReady_ && this.firstPassAfterDocumentReady_) {\n      this.firstPassAfterDocumentReady_ = false;\n      this.viewer_.postDocumentReady(this.viewport_.getSize().width,\n        this.win.document.body./*OK*/scrollHeight);\n      this.updateScrollHeight_();\n    }\n\n    const viewportSize = this.viewport_.getSize();\n    const now = timer.now();\n    log.fine(TAG_, 'PASS: at ' + now +\n        ', visible=', this.visible_,\n        ', forceBuild=', this.forceBuild_,\n        ', relayoutAll=', this.relayoutAll_,\n        ', relayoutTop=', this.relayoutTop_,\n        ', viewportSize=', viewportSize.width, viewportSize.height,\n        ', prerenderSize=', this.prerenderSize_);\n    this.pass_.cancel();\n    this.vsyncScheduled_ = false;\n\n    // If document becomes invisible, bring everything into inactive state.\n    if (prevVisible && !this.visible_) {\n      log.fine(TAG_, 'document become inactive');\n      this.documentBecameInactive_();\n      return;\n    }\n\n    // If viewport size is 0, the manager will wait for the resize event.\n    if (viewportSize.height > 0 && viewportSize.width > 0) {\n      if (this.hasMutateWork_()) {\n        this.mutateWork_();\n      }\n      this.discoverWork_();\n      let delay = this.work_();\n      if (this.hasMutateWork_()) {\n        // Overflow mutate work.\n        delay = Math.min(delay, MUTATE_DEFER_DELAY_);\n      }\n      if (this.visible_) {\n        log.fine(TAG_, 'next pass:', delay);\n        this.schedulePass(delay);\n        this.updateScrollHeight_();\n      } else {\n        log.fine(TAG_, 'document is not visible: no scheduling');\n      }\n    }\n  }\n\n  /**\n   * Returns `true` when there's mutate work currently batched.\n   * @return {boolean}\n   * @private\n   */\n  hasMutateWork_() {\n    return (this.deferredMutates_.length > 0 ||\n        this.requestsChangeHeight_.length > 0);\n  }\n\n  /**\n   * Performs pre-discovery mutates.\n   * @private\n   */\n  mutateWork_() {\n    // Read all necessary data before mutates.\n    // The height changing depends largely on the target element's position\n    // in the active viewport. We consider the active viewport the part of the\n    // visible viewport below 10% from the top and above 25% from the bottom.\n    // This is basically the portion of the viewport where the reader is most\n    // likely focused right now. The main goal is to avoid drastic UI changes\n    // in that part of the content. The elements below the active viewport are\n    // freely resized. The elements above the viewport are resized and request\n    // scroll adjustment to avoid active viewport changing without user's\n    // action. The elements in the active viewport are not resized and instead\n    // the overflow callbacks are called.\n    const now = timer.now();\n    const viewportRect = this.viewport_.getRect();\n    const topOffset = viewportRect.height / 10;\n    const bottomOffset = viewportRect.height / 4;\n    const isScrollingStopped = (Math.abs(this.lastVelocity_) < 1e-2 &&\n        now - this.lastScrollTime_ > MUTATE_DEFER_DELAY_ ||\n        now - this.lastScrollTime_ > MUTATE_DEFER_DELAY_ * 2);\n\n    if (this.deferredMutates_.length > 0) {\n      log.fine(TAG_, 'deferred mutates:', this.deferredMutates_.length);\n      const deferredMutates = this.deferredMutates_;\n      this.deferredMutates_ = [];\n      for (let i = 0; i < deferredMutates.length; i++) {\n        deferredMutates[i]();\n      }\n    }\n\n    if (this.requestsChangeHeight_.length > 0) {\n      log.fine(TAG_, 'change height requests:',\n          this.requestsChangeHeight_.length);\n      const requestsChangeHeight = this.requestsChangeHeight_;\n      this.requestsChangeHeight_ = [];\n\n      // Find minimum top position and run all mutates.\n      let minTop = -1;\n      const scrollAdjSet = [];\n      for (let i = 0; i < requestsChangeHeight.length; i++) {\n        const request = requestsChangeHeight[i];\n        const resource = request.resource;\n        const box = request.resource.getLayoutBox();\n        if (box.height == request.newHeight) {\n          // Nothing to do.\n          continue;\n        }\n\n        // Check resize rules. It will either resize element immediately, or\n        // wait until scrolling stops or will call the overflow callback.\n        let resize = false;\n        if (request.force || !this.visible_) {\n          // 1. An immediate execution requested or the document is hidden.\n          resize = true;\n        } else if (this.activeHistory_.hasDescendantsOf(resource.element)) {\n          // 2. Active elements are immediately resized. The assumption is that\n          // the resize is triggered by the user action or soon after.\n          resize = true;\n        } else if (box.bottom >= viewportRect.bottom - bottomOffset) {\n          // 3. Elements under viewport are resized immediately.\n          resize = true;\n        } else if (box.bottom <= viewportRect.top + topOffset) {\n          // 4. Elements above the viewport can only be resized when scrolling\n          // has stopped, otherwise defer util next cycle.\n          if (isScrollingStopped) {\n            // These requests will be executed in the next animation cycle and\n            // adjust the scroll position.\n            resize = false;\n            scrollAdjSet.push(request);\n          } else {\n            // Defer till next cycle.\n            this.requestsChangeHeight_.push(request);\n          }\n        } else if (request.newHeight < box.height) {\n          // 5. The new height is smaller than the current one.\n          // TODO(dvoytenko): Enable immediate resize in this case after\n          // potential abuse scenarios are considered.\n          resize = false;\n        } else {\n          // 6. Element is in viewport don't resize and try overflow callback\n          // instead.\n          request.resource.overflowCallback(/* overflown */ true,\n              request.newHeight);\n        }\n\n        if (resize) {\n          if (box.top >= 0) {\n            minTop = minTop == -1 ? box.top : Math.min(minTop, box.top);\n          }\n          request.resource./*OK*/changeHeight(request.newHeight);\n          request.resource.overflowCallback(/* overflown */ false,\n              request.newHeight);\n        }\n      }\n\n      if (minTop != -1) {\n        this.relayoutTop_ = minTop;\n      }\n\n      // Execute scroll-adjusting resize requests, if any.\n      if (scrollAdjSet.length > 0) {\n        this.vsync_.run({\n          measure: state => {\n            state./*OK*/scrollHeight = this.viewport_./*OK*/getScrollHeight();\n            state./*OK*/scrollTop = this.viewport_./*OK*/getScrollTop();\n          },\n          mutate: state => {\n            let minTop = -1;\n            scrollAdjSet.forEach(request => {\n              const box = request.resource.getLayoutBox();\n              minTop = minTop == -1 ? box.top : Math.min(minTop, box.top);\n              request.resource./*OK*/changeHeight(request.newHeight);\n            });\n            if (minTop != -1) {\n              this.relayoutTop_ = minTop;\n            }\n            // Sync is necessary here to avoid UI jump in the next frame.\n            const newScrollHeight = this.viewport_./*OK*/getScrollHeight();\n            if (newScrollHeight > state./*OK*/scrollHeight) {\n              this.viewport_.setScrollTop(state./*OK*/scrollTop +\n                  (newScrollHeight - state./*OK*/scrollHeight));\n            }\n          }\n        });\n      }\n    }\n  }\n\n  /**\n   * Reschedules change height request when an overflown element is activated.\n   * @param {!Element} element\n   * @private\n   */\n  checkPendingChangeHeight_(element) {\n    const resourceElement = closest(element, el => el[RESOURCE_PROP_]);\n    if (!resourceElement) {\n      return;\n    }\n    const resource = this.getResourceForElement(resourceElement);\n    const pendingChangeHeight = resource.getPendingChangeHeight();\n    if (pendingChangeHeight !== undefined) {\n      this.scheduleChangeHeight_(resource, pendingChangeHeight,\n          /* force */ true);\n    }\n  }\n\n  /**\n   * Discovers work that needs to be done since the last pass. If viewport\n   * has changed, it will try to build new elements, measure changed elements,\n   * and schedule layouts and preloads within a reasonable distance of the\n   * current viewport. Finally, this process also updates inViewport state\n   * of changed elements.\n   *\n   * Layouts and preloads are not executed immediately, but instead scheduled\n   * in the queue with different priorities.\n   *\n   * @private\n   */\n  discoverWork_() {\n\n    // TODO(dvoytenko): vsync separation may be needed for different phases\n\n    const now = timer.now();\n\n    // Ensure all resources layout phase complete; when relayoutAll is requested\n    // force re-layout.\n    const relayoutAll = this.relayoutAll_;\n    this.relayoutAll_ = false;\n    const relayoutTop = this.relayoutTop_;\n    this.relayoutTop_ = -1;\n\n    // Phase 1: Build and relayout as needed. All mutations happen here.\n    let relayoutCount = 0;\n    for (let i = 0; i < this.resources_.length; i++) {\n      const r = this.resources_[i];\n      if (r.getState() == ResourceState_.NOT_BUILT) {\n        r.build(this.forceBuild_);\n      }\n      if (r.getState() == ResourceState_.NOT_LAID_OUT || relayoutAll) {\n        r.applySizesAndMediaQuery();\n        relayoutCount++;\n      }\n    }\n\n    // Phase 2: Remeasure if there were any relayouts. Unfortunately, currently\n    // there's no way to optimize this. All reads happen here.\n    if (relayoutCount > 0 || relayoutAll || relayoutTop != -1) {\n      for (let i = 0; i < this.resources_.length; i++) {\n        const r = this.resources_[i];\n        if (r.getState() == ResourceState_.NOT_BUILT || r.hasOwner()) {\n          continue;\n        }\n        if (relayoutAll ||\n                r.getState() == ResourceState_.NOT_LAID_OUT ||\n                relayoutTop != -1 && r.getLayoutBox().bottom >= relayoutTop) {\n          r.measure();\n        }\n      }\n    }\n\n    const viewportRect = this.viewport_.getRect();\n    // Load viewport = viewport + 3x up/down when document is visible or\n    // depending on prerenderSize in pre-render mode.\n    let loadRect;\n    if (this.visible_) {\n      loadRect = expandLayoutRect(viewportRect, 0.25, 2);\n    } else if (this.prerenderSize_ > 0) {\n      loadRect = expandLayoutRect(viewportRect, 0.25,\n          this.prerenderSize_ - 1 + 0.25);\n    } else {\n      loadRect = null;\n    }\n\n    // Visible viewport = viewport + 25% up/down.\n    const visibleRect = expandLayoutRect(viewportRect, 0.25, 0.25);\n\n    // Phase 3: Schedule elements for layout within a reasonable distance from\n    // current viewport.\n    if (loadRect) {\n      for (let i = 0; i < this.resources_.length; i++) {\n        const r = this.resources_[i];\n        if (r.getState() != ResourceState_.READY_FOR_LAYOUT || r.hasOwner()) {\n          continue;\n        }\n        if (r.isDisplayed() && r.overlaps(loadRect)) {\n          this.scheduleLayoutOrPreload_(r, /* layout */ true);\n        }\n      }\n    }\n\n    // Phase 4: Trigger \"viewport enter/exit\" events.\n    for (let i = 0; i < this.resources_.length; i++) {\n      const r = this.resources_[i];\n      if (r.hasOwner()) {\n        continue;\n      }\n      // Note that when the document is not visible, neither are any of its\n      // elements to reduce CPU cycles.\n      const shouldBeInViewport = (this.visible_ && r.isDisplayed() &&\n          r.overlaps(visibleRect));\n      if (r.isInViewport() != shouldBeInViewport) {\n        r.setInViewport(shouldBeInViewport);\n      }\n    }\n\n    // Phase 5: Idle layout: layout more if we are otherwise not doing much.\n    // TODO(dvoytenko): document/estimate IDLE timeouts and other constants\n    if (this.visible_ &&\n          this.exec_.getSize() == 0 &&\n          this.queue_.getSize() == 0 &&\n          now > this.exec_.getLastDequeueTime() + 5000) {\n      let idleScheduledCount = 0;\n      for (let i = 0; i < this.resources_.length; i++) {\n        const r = this.resources_[i];\n        if (r.getState() == ResourceState_.READY_FOR_LAYOUT &&\n                !r.hasOwner() && r.isDisplayed()) {\n          log.fine(TAG_, 'idle layout:', r.debugid);\n          this.scheduleLayoutOrPreload_(r, /* layout */ false);\n          idleScheduledCount++;\n          if (idleScheduledCount >= 4) {\n            break;\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Brings all resources into inactive state. First it sets \"in viewport\"\n   * state to false and then it calls documentInactive callback.\n   * @private\n   */\n  documentBecameInactive_() {\n    for (let i = 0; i < this.resources_.length; i++) {\n      const r = this.resources_[i];\n      r.documentBecameInactive();\n    }\n  }\n\n  /**\n   * Dequeues layout and preload tasks from the queue and initiates their\n   * execution.\n   *\n   * There are two main drivers to dequeueing: a task's score and timeout. The\n   * score is built based on the resource's priority and viewport location\n   * (see {@link calcTaskScore_}). Timeout depends on the priority and age\n   * of tasks currently in the execution pool (see {@link calcTaskTimeout_}).\n   *\n   * @return {!time}\n   * @private\n   */\n  work_() {\n    const now = timer.now();\n\n    const scorer = this.calcTaskScore_.bind(this, this.viewport_.getRect(),\n        Math.sign(this.lastVelocity_));\n\n    let timeout = -1;\n    let task = this.queue_.peek(scorer);\n    if (task) {\n      do {\n        timeout = this.calcTaskTimeout_(task);\n        log.fine(TAG_, 'peek from queue:', task.id,\n            'sched at', task.scheduleTime,\n            'score', scorer(task),\n            'timeout', timeout);\n        if (timeout > 16) {\n          break;\n        }\n\n        this.queue_.dequeue(task);\n\n        // Do not override a task in execution. This task will have to wait\n        // until the current one finished the execution.\n        const executing = this.exec_.getTaskById(task.id);\n        if (!executing) {\n          // Ensure that task can prerender\n          task.promise = task.callback(this.visible_);\n          task.startTime = now;\n          log.fine(TAG_, 'exec:', task.id, 'at', task.startTime);\n          this.exec_.enqueue(task);\n          task.promise.then(this.taskComplete_.bind(this, task, true),\n              this.taskComplete_.bind(this, task, false))\n              .catch(reportError);\n        } else {\n          // Reschedule post execution.\n          executing.promise.then(this.reschedule_.bind(this, task),\n              this.reschedule_.bind(this, task));\n        }\n\n        task = this.queue_.peek(scorer);\n        timeout = -1;\n      } while (task);\n    }\n\n    log.fine(TAG_, 'queue size:', this.queue_.getSize());\n    log.fine(TAG_, 'exec size:', this.exec_.getSize());\n\n    if (timeout >= 0) {\n      // Work pass.\n      return timeout;\n    }\n\n    // Idle pass.\n    let nextPassDelay = (now - this.exec_.getLastDequeueTime()) * 2;\n    nextPassDelay = Math.max(Math.min(30000, nextPassDelay), 5000);\n    return nextPassDelay;\n  }\n\n  /**\n   * Calculates the task's score. A task with the lowest score will be dequeued\n   * from the queue the first.\n   *\n   * There are three components of the score: element's priority, operation or\n   * offset priority and viewport priority.\n   *\n   * Element's priority is constant of the element's name. E.g. amp-img has a\n   * priority of 0, while amp-ad has a priority of 2.\n   *\n   * The operation (offset) priority is the priority of the task. A layout is\n   * a high-priority task while preload is a lower-priority task.\n   *\n   * Viewport priority is a function of the distance of the element from the\n   * currently visible viewports. The elements in the visible viewport get\n   * higher priority and further away from the viewport get lower priority.\n   * This priority also depends on whether or not the user is scrolling towards\n   * this element or away from it.\n   *\n   * @param {!LayoutRect} viewportRect\n   * @param {number} dir\n   * @param {!TaskDef} task\n   * @private\n   */\n  calcTaskScore_(viewportRect, dir, task) {\n    const box = task.resource.getLayoutBox();\n    let posPriority = Math.floor((box.top - viewportRect.top) /\n        viewportRect.height);\n    if (posPriority != 0 && Math.sign(posPriority) != (dir || 1)) {\n      posPriority *= 2;\n    }\n    posPriority = Math.abs(posPriority);\n    return task.priority * PRIORITY_BASE_ + posPriority;\n  }\n\n  /**\n   * Calculates the timeout of a task. The timeout depends on two main factors:\n   * the priorities of the tasks currently in the execution pool and their age.\n   * The timeout is calculated against each task in the execution pool and the\n   * maximum value is returned.\n   *\n   * A task is penalized with higher timeout values when it's lower in priority\n   * than the task in the execution pool. However, this penalty is judged\n   * against the age of the executing task. If it has been in executing for\n   * some time, the penalty is reduced.\n   *\n   * @param {!TaskDef} task\n   * @private\n   */\n  calcTaskTimeout_(task) {\n    if (this.exec_.getSize() == 0) {\n      return 0;\n    }\n\n    const now = timer.now();\n    let timeout = 0;\n    this.exec_.forEach(other => {\n      // Higher priority tasks get the head start. Currently 500ms per a drop\n      // in priority (note that priority is 10-based).\n      const penalty = Math.max((task.priority - other.priority) *\n          PRIORITY_PENALTY_TIME_, 0);\n      // TODO(dvoytenko): Consider running total and not maximum.\n      timeout = Math.max(timeout, penalty - (now - other.startTime));\n    });\n\n    return timeout;\n  }\n\n  /**\n   * @param {!TaskDef} task\n   * @private\n   */\n  reschedule_(task) {\n    if (!this.queue_.getTaskById(task.id)) {\n      this.queue_.enqueue(task);\n    }\n  }\n\n  /**\n   * @param {!TaskDef} task\n   * @param {boolean} success\n   * @param {*=} opt_reason\n   * @return {!Promise|undefined}\n   * @private\n   */\n  taskComplete_(task, success, opt_reason) {\n    this.exec_.dequeue(task);\n    this.schedulePass(POST_TASK_PASS_DELAY_);\n    if (!success) {\n      log.error(TAG_, 'task failed:',\n          task.id, task.resource.debugid, opt_reason);\n      return Promise.reject(opt_reason);\n    }\n  }\n\n  /**\n   * Schedules change of the element's height.\n   * @param {!Resource} resource\n   * @param {number} newHeight\n   * @param {boolean} force\n   * @private\n   */\n  scheduleChangeHeight_(resource, newHeight, force) {\n    resource.resetPendingChangeHeight();\n    if (resource.getLayoutBox().height == newHeight) {\n      // Nothing to do.\n      return;\n    }\n\n    let request = null;\n    for (let i = 0; i < this.requestsChangeHeight_.length; i++) {\n      if (this.requestsChangeHeight_[i].resource == resource) {\n        request = this.requestsChangeHeight_[i];\n        break;\n      }\n    }\n    if (request) {\n      request.newHeight = newHeight;\n      request.force = force || request.force;\n    } else {\n      this.requestsChangeHeight_.push({\n        resource: resource,\n        newHeight: newHeight,\n        force: force\n      });\n    }\n    this.schedulePassVsync();\n  }\n\n  /**\n   * Schedules deferred mutate.\n   * @param {!Resource} resource\n   * @param {!Function} callback\n   * @private\n   */\n  scheduleDeferredMutate_(resource, callback) {\n    this.deferredMutates_.push(callback);\n  }\n\n  /**\n   * Schedules layout or preload for the specified resource.\n   * @param {!Resource} resource\n   * @param {boolean} layout\n   * @param {number=} opt_parentPriority\n   * @private\n   */\n  scheduleLayoutOrPreload_(resource, layout, opt_parentPriority) {\n    assert(resource.getState() != ResourceState_.NOT_BUILT &&\n        resource.isDisplayed(),\n        'Not ready for layout: %s (%s)',\n        resource.debugid, resource.getState());\n    // Don't schedule elements that can't prerender, they won't be allowed\n    // to execute anyway.\n    if (!this.visible_ && !resource.prerenderAllowed()) {\n      return;\n    }\n    if (!resource.isInViewport() && !resource.renderOutsideViewport()) {\n      return;\n    }\n    if (layout) {\n      this.schedule_(resource,\n          LAYOUT_TASK_ID_, LAYOUT_TASK_OFFSET_,\n          opt_parentPriority || 0,\n          resource.startLayout.bind(resource));\n    } else {\n      this.schedule_(resource,\n          PRELOAD_TASK_ID_, PRELOAD_TASK_OFFSET_,\n          opt_parentPriority || 0,\n          resource.startLayout.bind(resource));\n    }\n  }\n\n  /**\n   * Schedules layout or preload for the sub-resources of the specified\n   * resource.\n   * @param {!Resource} parentResource\n   * @param {boolean} layout\n   * @param {!Array<!Element>} subElements\n   * @private\n   */\n  scheduleLayoutOrPreloadForSubresources_(parentResource, layout, subElements) {\n    const resources = [];\n    this.discoverResourcesForArray_(parentResource, subElements, resource => {\n      if (resource.getState() != ResourceState_.NOT_BUILT) {\n        resources.push(resource);\n      }\n    });\n    if (resources.length > 0) {\n      resources.forEach(resource => {\n        resource.measure();\n        if (resource.getState() == ResourceState_.READY_FOR_LAYOUT &&\n                resource.isDisplayed()) {\n          this.scheduleLayoutOrPreload_(resource, layout,\n              parentResource.getPriority());\n        }\n      });\n    }\n  }\n\n  /**\n   * Schedules a task.\n   * @param {!Resource} resource\n   * @param {string} localId\n   * @param {number} priorityOffset\n   * @param {number} parentPriority\n   * @param {function():!Promise} callback\n   * @private\n   */\n  schedule_(resource, localId, priorityOffset, parentPriority, callback) {\n    const taskId = resource.debugid + '#' + localId;\n\n    const task = {\n      id: taskId,\n      resource: resource,\n      priority: Math.max(resource.getPriority(), parentPriority) +\n          priorityOffset,\n      callback: callback,\n      scheduleTime: timer.now()\n    };\n    log.fine(TAG_, 'schedule:', task.id, 'at', task.scheduleTime);\n\n    // Only schedule a new task if there's no one enqueued yet or if this task\n    // has a higher priority.\n    const queued = this.queue_.getTaskById(taskId);\n    if (!queued || task.priority < queued.priority) {\n      if (queued) {\n        this.queue_.dequeue(queued);\n      }\n      this.queue_.enqueue(task);\n      this.schedulePass(this.calcTaskTimeout_(task));\n    }\n    task.resource.layoutScheduled();\n  }\n\n  /**\n   * Updates inViewport state for the specified sub-resources of a resource.\n   * @param {!Resource} parentResource\n   * @param {!Array<!Element>} subElements\n   * @param {boolean} inLocalViewport\n   * @private\n   */\n  updateInViewportForSubresources_(parentResource, subElements,\n      inLocalViewport) {\n    const inViewport = parentResource.isInViewport() && inLocalViewport;\n    this.discoverResourcesForArray_(parentResource, subElements, resource => {\n      resource.setInViewport(inViewport);\n    });\n  }\n\n  /**\n   * Finds resources within the parent resource's shallow subtree.\n   * @param {!Resource} parentResource\n   * @param {!Array<!Element>} elements\n   * @param {function(!Resource)} callback\n   */\n  discoverResourcesForArray_(parentResource, elements, callback) {\n    elements.forEach(element => {\n      assert(parentResource.element.contains(element));\n      this.discoverResourcesForElement_(element, callback);\n    });\n  }\n\n  /**\n   * @param {!Element} element\n   * @param {function(!Resource)} callback\n   */\n  discoverResourcesForElement_(element, callback) {\n    // Breadth-first search.\n    if (element.classList.contains('-amp-element')) {\n      callback(this.getResourceForElement(element));\n    } else {\n      const ampElements = element.getElementsByClassName('-amp-element');\n      const seen = [];\n      for (let i = 0; i < ampElements.length; i++) {\n        const ampElement = ampElements[i];\n        let covered = false;\n        for (let j = 0; j < seen.length; j++) {\n          if (seen[j].contains(ampElement)) {\n            covered = true;\n            break;\n          }\n        }\n        if (!covered) {\n          seen.push(ampElement);\n          callback(this.getResourceForElement(ampElement));\n        }\n      }\n    }\n  }\n}\n\n\n/**\n * A Resource binding for an AmpElement.\n *\n * Visible for testing only!\n */\nexport class Resource {\n\n  /**\n   * @param {number} id\n   * @param {!AmpElement} element\n   * @param {!Resources} resources\n   */\n  constructor(id, element, resources) {\n    /** @private {number} */\n    this.id_ = id;\n\n    /** @export @const {!AmpElement} */\n    this.element = element;\n\n    /** @export @const {string} */\n    this.debugid = element.tagName.toLowerCase() + '#' + id;\n\n    /** @private {!Resources} */\n    this.resources_ = resources;\n\n    /** @private {boolean} */\n    this.blacklisted_ = false;\n\n    /** @const {!AmpElement|undefined|null} */\n    this.owner_ = undefined;\n\n    /** @const {number} */\n    this.priority_ = getElementPriority(element.tagName);\n\n    /** @private {!ResourceState_} */\n    this.state_ = element.isBuilt() ? ResourceState_.NOT_LAID_OUT :\n        ResourceState_.NOT_BUILT;\n\n    /** @private {number} */\n    this.layoutCount_ = 0;\n\n    /** @private {!LayoutRect} */\n    this.layoutBox_ = layoutRectLtwh(-10000, -10000, 0, 0);\n\n    /** @private {boolean} */\n    this.isInViewport_ = false;\n\n    /**\n     * Only used in the \"runtime off\" case when the monitoring code needs to\n     * known when the element is upgraded.\n     * @private {!Function|undefined}\n     */\n    this.onUpgraded_;\n\n    /**\n     * Pending change height that was requested but could not be satisfied.\n     * @private {number|undefined}\n     */\n    this.pendingChangeHeight_;\n  }\n\n  /**\n   * Returns resource's ID.\n   * @return {number}\n   */\n  getId() {\n    return this.id_;\n  }\n\n  /**\n   * Returns an owner element or null.\n   * @return {?AmpElement}\n   */\n  getOwner() {\n    if (this.owner_ === undefined) {\n      for (let n = this.element; n; n = n.parentElement) {\n        if (n[OWNER_PROP_]) {\n          this.owner_ = n[OWNER_PROP_];\n          break;\n        }\n      }\n      if (this.owner_ === undefined) {\n        this.owner_ = null;\n      }\n    }\n    return this.owner_;\n  }\n\n  /**\n   * Whether the resource has an owner.\n   * @return {boolean}\n   */\n  hasOwner() {\n    return !!this.getOwner();\n  }\n\n  /**\n   * Returns the resource's element priority.\n   * @return {number}\n   */\n  getPriority() {\n    return this.priority_;\n  }\n\n  /**\n   * Returns the resource's state. See {@link ResourceState_} for details.\n   * @return {!ResourceState_}\n   */\n  getState() {\n    return this.state_;\n  }\n\n  /**\n   * Requests the resource's element to be built. See {@link AmpElement.build}\n   * for details.\n   * @param {boolean} force\n   * @return {boolean}\n   */\n  build(force) {\n    if (this.blacklisted_ || !this.element.isUpgraded()) {\n      return false;\n    }\n    let built;\n    try {\n      built = this.element.build(force);\n    } catch (e) {\n      log.error(TAG_, 'failed to build:', this.debugid, e);\n      built = false;\n      this.blacklisted_ = true;\n    }\n    if (!built) {\n      return false;\n    }\n    this.state_ = ResourceState_.NOT_LAID_OUT;\n    return true;\n  }\n\n  /**\n   * Optionally hides or shows the element depending on the media query.\n   */\n  applySizesAndMediaQuery() {\n    this.element.applySizesAndMediaQuery();\n  }\n\n  /**\n   * Instructs the element to change its size and transitions to the state\n   * awaiting the measure and possibly layout.\n   * @param {number} newHeight\n   */\n  changeHeight(newHeight) {\n    this.element./*OK*/changeHeight(newHeight);\n    // Schedule for re-layout.\n    if (this.state_ != ResourceState_.NOT_BUILT) {\n      this.state_ = ResourceState_.NOT_LAID_OUT;\n    }\n  }\n\n  /**\n   * Informs the element that it's either overflown or not.\n   * @param {boolean} overflown\n   * @param {number} requestedHeight\n   */\n  overflowCallback(overflown, requestedHeight) {\n    if (overflown) {\n      this.pendingChangeHeight_ = requestedHeight;\n    }\n    this.element.overflowCallback(overflown, requestedHeight);\n  }\n\n  /** @private */\n  resetPendingChangeHeight() {\n    this.pendingChangeHeight_ = undefined;\n  }\n\n  /**\n   * @return {number|undefined}\n   */\n  getPendingChangeHeight() {\n    return this.pendingChangeHeight_;\n  }\n\n  /**\n   * Measures the resource's boundaries. Only allowed for upgraded elements.\n   */\n  measure() {\n    assert(this.element.isUpgraded(), 'Must be upgraded to measure: %s',\n        this.debugid);\n    if (this.state_ == ResourceState_.NOT_BUILT) {\n      // Can't measure unbuilt element.\n      return;\n    }\n    const box = this.resources_.viewport_.getLayoutRect(this.element);\n    // Note that \"left\" doesn't affect readiness for the layout.\n    if (this.state_ == ResourceState_.NOT_LAID_OUT ||\n          this.layoutBox_.top != box.top ||\n          this.layoutBox_.width != box.width ||\n          this.layoutBox_.height != box.height) {\n      if (this.state_ == ResourceState_.NOT_LAID_OUT ||\n              this.element.isRelayoutNeeded()) {\n        this.state_ = ResourceState_.READY_FOR_LAYOUT;\n      }\n    }\n    this.layoutBox_ = box;\n    this.element.updateLayoutBox(box);\n  }\n\n  /**\n   * Returns a previously measured layout box.\n   * @return {!LayoutRect}\n   */\n  getLayoutBox() {\n    return this.layoutBox_;\n  }\n\n  /**\n   * Whether the resource is displayed, i.e. if it has non-zero width and\n   * height.\n   * @return {boolean}\n   */\n  isDisplayed() {\n    return this.layoutBox_.height > 0 && this.layoutBox_.width > 0;\n  }\n\n  /**\n   * Whether the element's layout box overlaps with the specified rect.\n   * @param {!LayoutRect} rect\n   * @return {boolean}\n   */\n  overlaps(rect) {\n    return layoutRectsOverlap(this.layoutBox_, rect);\n  }\n\n  /**\n   * Whether this element can be pre-rendered.\n   * @return {boolean}\n   */\n  prerenderAllowed() {\n    return this.element.prerenderAllowed();\n  }\n\n  /**\n   * Whether this is allowed to render when not in viewport.\n   * @return {boolean}\n   */\n  renderOutsideViewport() {\n    return this.element.renderOutsideViewport();\n  }\n\n  /**\n   * Sets the resource's state to LAYOUT_SCHEDULED.\n   */\n  layoutScheduled() {\n    this.state_ = ResourceState_.LAYOUT_SCHEDULED;\n  }\n\n  /**\n   * Starts the layout of the resource. Returns the promise that will yield\n   * once layout is complete. Only allowed to be called on a upgraded, built\n   * and displayed element.\n   * @param {boolean} isDocumentVisible\n   * @return {!Promise}\n   */\n  startLayout(isDocumentVisible) {\n    if (this.layoutPromise_) {\n      return this.layoutPromise_;\n    }\n    if (this.state_ == ResourceState_.LAYOUT_COMPLETE) {\n      return Promise.resolve();\n    }\n    if (this.state_ == ResourceState_.LAYOUT_FAILED) {\n      return Promise.reject('already failed');\n    }\n\n    assert(this.state_ != ResourceState_.NOT_BUILT,\n        'Not ready to start layout: %s (%s)', this.debugid, this.state_);\n\n    if (!isDocumentVisible && !this.prerenderAllowed()) {\n      log.fine(TAG_, 'layout canceled due to non pre-renderable element:',\n          this.debugid, this.state_);\n      this.state_ = ResourceState_.READY_FOR_LAYOUT;\n      return Promise.resolve();\n    }\n\n    if (!this.renderOutsideViewport() && !this.isInViewport()) {\n      log.fine(TAG_, 'layout canceled due to element not being in viewport:',\n          this.debugid, this.state_);\n      this.state_ = ResourceState_.READY_FOR_LAYOUT;\n      return Promise.resolve();\n    }\n\n    // Double check that the element has not disappeared since scheduling\n    this.measure();\n    if (!this.isDisplayed()) {\n      log.fine(TAG_, 'layout canceled due to element loosing display:',\n          this.debugid, this.state_);\n      return Promise.resolve();\n    }\n\n    // Not-wanted re-layouts are ignored.\n    if (this.layoutCount_ > 0 && !this.element.isRelayoutNeeded()) {\n      log.fine(TAG_, 'layout canceled since it wasn\\'t requested:',\n          this.debugid, this.state_);\n      this.state_ = ResourceState_.LAYOUT_COMPLETE;\n      return Promise.resolve();\n    }\n\n    log.fine(TAG_, 'start layout:', this.debugid, 'count:', this.layoutCount_);\n    this.layoutCount_++;\n    this.state_ = ResourceState_.LAYOUT_SCHEDULED;\n\n    let promise;\n    try {\n      promise = this.element.layoutCallback();\n    } catch (e) {\n      return Promise.reject(e);\n    }\n    this.layoutPromise_ = promise.then(() => this.layoutComplete_(true),\n        reason => this.layoutComplete_(false, reason));\n    return this.layoutPromise_;\n  }\n\n  /**\n   * @param {boolean} success\n   * @param {*=} opt_reason\n   * @return {!Promise|undefined}\n   */\n  layoutComplete_(success, opt_reason) {\n    this.layoutPromise_ = null;\n    this.state_ = success ? ResourceState_.LAYOUT_COMPLETE :\n        ResourceState_.LAYOUT_FAILED;\n    if (success) {\n      log.fine(TAG_, 'layout complete:', this.debugid);\n    } else {\n      log.fine(TAG_, 'loading failed:', this.debugid, opt_reason);\n      return Promise.reject(opt_reason);\n    }\n  }\n\n  /**\n   * Whether the resource is currently visible in the viewport.\n   * @return {boolean}\n   */\n  isInViewport() {\n    return this.isInViewport_;\n  }\n\n  /**\n   * Updates the inViewport state of the element.\n   * @param {boolean} inViewport\n   */\n  setInViewport(inViewport) {\n    if (inViewport == this.isInViewport_) {\n      return;\n    }\n    log.fine(TAG_, 'inViewport:', this.debugid, inViewport);\n    this.isInViewport_ = inViewport;\n    this.element.viewportCallback(inViewport);\n  }\n\n  /**\n   * Calls element's documentInactiveCallback callback and resets state for\n   * relayout in case document becomes active again.\n   */\n  documentBecameInactive() {\n    if (this.state_ == ResourceState_.NOT_BUILT) {\n      return;\n    }\n    if (this.isInViewport()) {\n      this.setInViewport(false);\n    }\n    if (this.element.documentInactiveCallback()) {\n      this.state_ = ResourceState_.NOT_LAID_OUT;\n    }\n  }\n\n  /**\n   * Only allowed in dev mode when runtime is turned off. Performs all steps\n   * necessary to render an element.\n   * @return {!Promise}\n   * @export\n   */\n  forceAll() {\n    assert(!this.resources_.isRuntimeOn_);\n    let p = Promise.resolve();\n    if (this.state_ == ResourceState_.NOT_BUILT) {\n      if (!this.element.isUpgraded()) {\n        p = p.then(() => {\n          return new Promise(resolve => {\n            this.onUpgraded_ = resolve;\n          });\n        });\n      }\n      p = p.then(() => {\n        this.onUpgraded_ = undefined;\n        this.build(true);\n      });\n    }\n    return p.then(() => {\n      this.applySizesAndMediaQuery();\n      this.measure();\n      if (this.layoutPromise_) {\n        return this.layoutPromise_;\n      }\n      if (this.state_ == ResourceState_.LAYOUT_COMPLETE ||\n              this.state_ == ResourceState_.LAYOUT_FAILED ||\n              this.layoutCount_ > 0) {\n        return Promise.resolve();\n      }\n      if (!this.isDisplayed()) {\n        return Promise.resolve();\n      }\n      this.layoutCount_++;\n      try {\n        return this.element.layoutCallback();\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    });\n  }\n}\n\n\n/**\n * A scheduling queue for Resources.\n *\n * Visible only for testing!\n *\n * @private\n */\nexport class TaskQueue_ {\n\n  constructor() {\n    /** @private @const {!Array<!TaskDef>} */\n    this.tasks_ = [];\n\n    /** @private @const {!Object<string, !TaskDef>} */\n    this.taskIdMap_ = {};\n\n    /** @private {!time} */\n    this.lastEnqueueTime_ = 0;\n\n    /** @private {!time} */\n    this.lastDequeueTime_ = 0;\n  }\n\n  /**\n   * Size of the queue.\n   * @return {number}\n   */\n  getSize() {\n    return this.tasks_.length;\n  }\n\n  /**\n   * Last time a task was enqueued.\n   * @return {!time}\n   */\n  getLastEnqueueTime() {\n    return this.lastEnqueueTime_;\n  }\n\n  /**\n   * Last time a task was dequeued.\n   * @return {!time}\n   */\n  getLastDequeueTime() {\n    return this.lastDequeueTime_;\n  }\n\n  /**\n   * Returns the task with the specified ID or null.\n   * @param {string} taskId\n   * @return {?TaskDef}\n   */\n  getTaskById(taskId) {\n    return this.taskIdMap_[taskId] || null;\n  }\n\n  /**\n   * Enqueues the task. If the task is already in the queue, the error is\n   * thrown.\n   * @param {!TaskDef} task\n   */\n  enqueue(task) {\n    assert(!this.taskIdMap_[task.id], 'Task already enqueued: %s', task.id);\n    this.tasks_.push(task);\n    this.taskIdMap_[task.id] = task;\n    this.lastEnqueueTime_ = timer.now();\n  }\n\n  /**\n   * Dequeues the task and returns \"true\" if dequeueing is successful. Otherwise\n   * returns \"false\", e.g. when this task is not currently enqueued.\n   * @param {!TaskDef} task\n   * @return {boolean}\n   */\n  dequeue(task) {\n    const existing = this.taskIdMap_[task.id];\n    if (!existing) {\n      return false;\n    }\n    this.tasks_.splice(this.tasks_.indexOf(existing), 1);\n    delete this.taskIdMap_[task.id];\n    this.lastDequeueTime_ = timer.now();\n    return true;\n  }\n\n  /**\n   * Returns the task with the minimal score based on the provided scoring\n   * callback.\n   * @param {function(!TaskDef):number} scorer\n   * @return {?TaskDef}\n   */\n  peek(scorer) {\n    let minScore = 1e6;\n    let minTask = null;\n    for (let i = 0; i < this.tasks_.length; i++) {\n      const task = this.tasks_[i];\n      const score = scorer(task);\n      if (score < minScore) {\n        minScore = score;\n        minTask = task;\n      }\n    }\n    return minTask;\n  }\n\n  /**\n   * Iterates over all tasks in queue in the insertion order.\n   * @param {function(!TaskDef)} callback\n   */\n  forEach(callback) {\n    this.tasks_.forEach(callback);\n  }\n}\n\n\n/**\n * @param {!Element|!Array<!Element>} elements\n * @return {!Array<!Element>}\n */\nfunction elements_(elements) {\n  if (elements.length !== undefined) {\n    return elements;\n  }\n  return [elements];\n}\n\n\n/**\n * Resource state.\n *\n * Visible for testing only!\n *\n * @enum {number}\n * @private\n */\nexport const ResourceState_ = {\n  /**\n   * The resource has not been built yet. Measures, layouts, preloads or\n   * viewport signals are not allowed.\n   */\n  NOT_BUILT: 0,\n\n  /**\n   * The resource has been built, but not measured yet and not yet ready\n   * for layout.\n   */\n  NOT_LAID_OUT: 1,\n\n  /**\n   * The resource has been built and measured and ready for layout.\n   */\n  READY_FOR_LAYOUT: 2,\n\n  /**\n   * The resource is currently scheduled for layout.\n   */\n  LAYOUT_SCHEDULED: 3,\n\n  /**\n   * The resource has been laid out.\n   */\n  LAYOUT_COMPLETE: 4,\n\n  /**\n   * The latest resource's layout failed.\n   */\n  LAYOUT_FAILED: 5\n};\n\n\n/**\n * The internal structure for the task.\n * @typedef {{\n *   id: string,\n *   resource: !Resource,\n *   priority: number,\n *   callback: function(boolean),\n *   scheduleTime: time,\n *   startTime: time,\n *   promise: (!Promise|undefined)\n * }}\n * @private\n */\nlet TaskDef;\n\n/**\n * @param {!Window} window\n * @return {!Resources}\n */\nexport function resourcesFor(window) {\n  return getService(window, 'resources', () => {\n    return new Resources(window);\n  });\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assert} from './asserts';\n\n/**\n * Holds info about a service.\n * - obj: Actual service implementation when available.\n * - promise: Promise for the obj.\n * - resolve: Function to resolve the promise with the object.\n * @typedef {{\n *   obj: (?Object),\n *   promise: (?Promise|undefined),\n *   resolve: (?function(!Object)|undefined),\n * }}\n */\nlet ServiceHolderDef;\n\n/**\n * Returns a service for the given id and window (a per-window singleton).\n * If the service is not yet available the factory function is invoked and\n * expected to return the service.\n * Users should typically wrap this as a special purpose function (e.g.\n * viewportFor(win)) for type safety and because the factory should not be\n * passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {function(!Window):!Object=} opt_factory Should create the service\n *     if it does not exist yet. If the factory is not given, it is an error\n *     if the service does not exist yet.\n * @return {*}\n */\nexport function getService(win, id, opt_factory) {\n  const services = getServices(win);\n  let s = services[id];\n  if (!s) {\n    s = services[id] = {};\n  }\n  if (!s.obj) {\n    assert(opt_factory, 'Factory not given and service missing %s', id);\n    s.obj = opt_factory(win);\n    // The service may have been requested already, in which case we have a\n    // pending promise we need to fulfill.\n    if (s.resolve) {\n      s.resolve(s.obj);\n    }\n  }\n  return s.obj;\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects\n * an element that has the actual implementation. The promise resolves when\n * the implementation loaded.\n * Users should typically wrap this as a special purpose function (e.g.\n * viewportFor(win)) for type safety and because the factory should not be\n * passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} provideByElement Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<*>}\n */\nexport function getElementService(win, id, providedByElement) {\n  // Call `getElementService_` in a micro-task to ensure that `stubElements`\n  // has been called.\n  return Promise.resolve().then(() => {\n    return getElementService_(win, id, providedByElement);\n  });\n}\n\n/**\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} provideByElement Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<*>}\n * @private\n */\nfunction getElementService_(win, id, providedByElement) {\n  assert(isElementScheduled(win, providedByElement),\n      'Service %s was requested to be provided through %s, ' +\n      'but %s is not loaded in the current page. To fix this ' +\n      'problem load the JavaScript file for %s in this page.',\n      id, providedByElement, providedByElement, providedByElement);\n  const services = getServices(win);\n  const s = services[id];\n  if (s) {\n    // If a service was registered with getService, we make a promise from it\n    // which we will return in future invocations.\n    if (!s.promise) {\n      s.promise = Promise.resolve(s.obj);\n    }\n    return s.promise;\n  }\n  // TODO(@cramforce): Add a check that if the element is eventually registered\n  // that the service is actually provided and this promise resolves.\n  let resolve;\n  const p = new Promise(r => {\n    resolve = r;\n  });\n  services[id] = {\n    obj: null,\n    promise: p,\n    resolve: resolve,\n  };\n\n  return p;\n}\n\n/**\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @return {boolean} Whether this element is scheduled to be loaded.\n */\nfunction isElementScheduled(win, elementName) {\n  assert(win.ampExtendedElements, 'win.ampExtendedElements not created yet');\n  return !!win.ampExtendedElements[elementName];\n}\n\n/**\n * In order to provide better error messages we only allow to retrieve\n * services from other elements if those elements are loaded in the page.\n * This makes it possible to mark an element as loaded in a test.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n */\nexport function markElementScheduledForTesting(win, elementName) {\n  if (!win.ampExtendedElements) {\n    win.ampExtendedElements = {};\n  }\n  win.ampExtendedElements[elementName] = true;\n}\n\n/**\n * Returns the object that holds the services registered in a window.\n * @param {!Window} win\n * @return {!Object<string,!ServiceHolderDef>}\n */\nfunction getServices(win) {\n  let services = win.services;\n  if (!services) {\n    services = win.services = {};\n  }\n  return services;\n}\n\n/**\n * Resets a single service, so it gets recreated on next getService invocation.\n * @param {!Window} win\n * @param {string} id of the service.\n */\nexport function resetServiceForTesting(win, id) {\n  if (win.services) {\n    win.services[id] = null;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assert} from './asserts';\nimport {assertLength} from './layout';\n\n\n/**\n * A single option within a SizeList.\n * @typedef {{\n *   mediaQuery: (string|undefined),\n *   size: (!Length)\n * }}\n */\nlet SizeListOptionDef;\n\n\n/**\n * Parses the text representation of \"sizes\" into SizeList object.\n *\n * There could be any number of size options within the SizeList. They are tried\n * in the order they were defined. The final size option must not have \"media\"\n * condition specified. All other size options must have \"media\" condition\n * specified.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/img#Attributes\n * See http://www.w3.org/html/wg/drafts/html/master/semantics.html#attr-img-sizes\n * @param {string} s\n * @return {!SizeList}\n */\nexport function parseSizeList(s) {\n  const sSizes = s.split(',');\n  assert(sSizes.length > 0, 'sizes has to have at least one size');\n  const sizes = [];\n  sSizes.forEach(sSize => {\n    sSize = sSize.replace(/\\s+/g, ' ').trim();\n    if (sSize.length == 0) {\n      return;\n    }\n\n    let mediaStr;\n    let sizeStr;\n    const spaceIndex = sSize.lastIndexOf(' ');\n    if (spaceIndex != -1) {\n      mediaStr = sSize.substring(0, spaceIndex).trim();\n      sizeStr = sSize.substring(spaceIndex + 1).trim();\n    } else {\n      sizeStr = sSize;\n      mediaStr = undefined;\n    }\n    sizes.push({mediaQuery: mediaStr, size: assertLength(sizeStr)});\n  });\n  return new SizeList(sizes);\n};\n\n\n/**\n * A SizeList object contains one or more sizes as typically seen in \"sizes\"\n * attribute.\n *\n * See \"select\" method for details on how the size selection is performed.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/img#Attributes\n * See http://www.w3.org/html/wg/drafts/html/master/semantics.html#attr-img-sizes\n */\nexport class SizeList {\n  /**\n   * @param {!Array<!SizeListOptionDef>} sizes\n   */\n  constructor(sizes) {\n    assert(sizes.length > 0, 'SizeList must have at least one option');\n    /** @private @const {!Array<!SizeListOptionDef>} */\n    this.sizes_ = sizes;\n\n    // All sources except for last must have a media query. The last one must\n    // not.\n    for (let i = 0; i < sizes.length; i++) {\n      const option = sizes[i];\n      if (i < sizes.length - 1) {\n        assert(option.mediaQuery,\n            'All options except for the last must have a media condition');\n      } else {\n        assert(!option.mediaQuery,\n            'The last option must not have a media condition');\n      }\n    }\n  }\n\n  /**\n   * Selects the first size that matches media conditions. If no options match,\n   * the last option is returned.\n   *\n   * See http://www.w3.org/html/wg/drafts/html/master/semantics.html#attr-img-sizes\n   * @param {!Window} win\n   * @return {!Length}\n   */\n  select(win) {\n    for (let i = 0; i < this.sizes_.length - 1; i++) {\n      const option = this.sizes_[i];\n      if (win.matchMedia(option.mediaQuery).matches) {\n        return option.size;\n      }\n    }\n    return this.getLast();\n  }\n\n  /**\n   * Returns the last size in the SizeList, which is the default.\n   * @return {!Length}\n   */\n  getLast() {\n    return this.sizes_[this.sizes_.length - 1].size;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {string} name Attribute name with dashes\n * @return {string} Dashes removed and character after to upper case.\n * visibleForTesting\n */\nexport function dashToCamelCase(name) {\n  return name.replace(/-([a-z])/g, function(_all, character) {\n    return character.toUpperCase();\n  });\n}\n\n/**\n * Expands placeholders in a given template string with values.\n *\n * Placeholders use ${key-name} syntax and are replaced with the value\n * returned from the given getter function.\n *\n * @param {string} template The template string to expand.\n * @param {!function(string):*} getter Function used to retrieve a value for a\n *   placeholder. Returns values will be coerced into strings.\n * @param {number=1} optMaxIterations Number of times to expand the template.\n *   Defaults to 1, but should be set to a larger value your placeholder tokens\n *   can be expanded to other placeholder tokens. Take caution with large values\n *   as recursively expanding a string can be exponentially expensive.\n */\nexport function expandTemplate(template, getter, opt_maxIterations) {\n  const maxIterations = opt_maxIterations || 1;\n  for (let i = 0; i < maxIterations; i++) {\n    let matches = 0;\n    template = template.replace(/\\${([^}]*)}/g, (_a, b) => {\n      matches++;\n      return getter(b);\n    });\n    if (!matches) {\n      break;\n    }\n  }\n  return template;\n}\n\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n// Note: loaded by 3p system. Cannot rely on babel polyfills.\n\n/** @private @const {!Object<string>} */\nconst propertyNameCache_ = Object.create(null);\n\n/** @private @const {!Array<string>} */\nconst vendorPrefixes_ = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n\n\n/**\n * @export\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\nexport function camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n\n/**\n * Checks the object if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} object\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\nfunction getVendorJsPropertyName_(object, titleCase) {\n  for (let i = 0; i < vendorPrefixes_.length; i++) {\n    const propertyName = vendorPrefixes_[i] + titleCase;\n    if (object[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n  return '';\n}\n\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @export\n * @param {!Object} object\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} opt_bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\nexport function getVendorJsPropertyName(object, camelCase, opt_bypassCache) {\n  let propertyName = propertyNameCache_[camelCase];\n  if (!propertyName || opt_bypassCache) {\n    propertyName = camelCase;\n    if (object[camelCase] === undefined) {\n      const titleCase = camelCaseToTitleCase(camelCase);\n      const prefixedPropertyName = getVendorJsPropertyName_(object, titleCase);\n\n      if (object[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n    if (!opt_bypassCache) {\n      propertyNameCache_[camelCase] = propertyName;\n    }\n  }\n  return propertyName;\n}\n\n\n/**\n * Sets the CSS style of the specified element with optional units, e.g. \"px\".\n * @param {!Element} element\n * @param {string} property\n * @param {*} value\n * @param {string=} opt_units\n * @param {boolean=} opt_bypassCache\n */\nexport function setStyle(element, property, value, opt_units, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(element.style, property,\n      opt_bypassCache);\n  if (propertyName) {\n    element.style[propertyName] = opt_units ? value + opt_units : value;\n  }\n}\n\n\n/**\n * Returns the value of the CSS style of the specified element.\n * @param {!Element} element\n * @param {string} property\n * @param {boolean=} opt_bypassCache\n * @return {*}\n */\nexport function getStyle(element, property, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(element.style, property,\n      opt_bypassCache);\n  if (!propertyName) {\n    return undefined;\n  }\n  return element.style[propertyName];\n}\n\n\n/**\n * Sets the CSS styles of the specified element. The styles\n * a specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setStyles(element, styles) {\n  for (const k in styles) {\n    setStyle(element, k, styles[k]);\n  }\n}\n\n\n/**\n * Shows or hides the specified element.\n * @param {!Element} element\n * @param {boolean=} opt_display\n */\nexport function toggle(element, opt_display) {\n  if (opt_display === undefined) {\n    opt_display = !(element.style.display != 'none');\n  }\n  element.style.display = opt_display ? '' : 'none';\n}\n\n\n/**\n * Returns a pixel value.\n * @param {number} value\n * @return {string}\n */\nexport function px(value) {\n  return value + 'px';\n}\n\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function translateX(value) {\n  if (typeof value == 'string') {\n    return `translateX(${value})`;\n  }\n  return `translateX(${px(value)})`;\n}\n\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} x\n * @param {(number|string)=} opt_y\n * @return {string}\n */\nexport function translate(x, opt_y) {\n  if (typeof x == 'number') {\n    x = px(x);\n  }\n  if (opt_y === undefined) {\n    return `translate(${x})`;\n  }\n  if (typeof opt_y == 'number') {\n    opt_y = px(opt_y);\n  }\n  return `translate(${x},${opt_y})`;\n}\n\n\n/**\n * Returns a \"scale\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function scale(value) {\n  return `scale(${value})`;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {setStyles} from './style';\n\n/**\n * Adds the given css text to the given document.\n *\n * The style tags will be at the beginning of the head before all author\n * styles. One element can be the main runtime CSS. This is guaranteed\n * to always be the first stylesheet in the doc.\n *\n * @param {!Document} doc The document that should get the new styles.\n * @param {string} cssText\n * @param {function()} cb Called when the new styles are available.\n *     Not using a promise, because this is synchronous when possible.\n *     for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n */\nexport function installStyles(doc, cssText, cb, opt_isRuntimeCss) {\n  const style = doc.createElement('style');\n  style.textContent = cssText;\n  let afterElement = null;\n  // Make sure that we place style tags after the main runtime CSS. Otherwise\n  // the order is random.\n  if (opt_isRuntimeCss) {\n    style.setAttribute('amp-runtime', '');\n  } else {\n    afterElement = doc.querySelector('style[amp-runtime]');\n  }\n  insertAfterOrAtStart(doc.head, style, afterElement);\n  // Styles aren't always available synchronously. E.g. if there is a\n  // pending style download, it will have to finish before the new\n  // style is visible.\n  // For this reason we poll until the style becomes available.\n  const done = () => {\n    const sheets = doc.styleSheets;\n    for (let i = 0; i < sheets.length; i++) {\n      const sheet = sheets[i];\n      if (sheet.ownerNode == style) {\n        return true;\n      }\n    }\n    return false;\n  };\n  // Sync case.\n  if (done()) {\n    cb();\n    return;\n  }\n  // Poll until styles are available.\n  const interval = setInterval(() => {\n    if (done()) {\n      clearInterval(interval);\n      cb();\n    }\n  }, 4);\n}\n\n/**\n * Sets the document's body opacity to 1.\n * If the body is not yet available (because our script was loaded\n * synchronously), polls until it is.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisible(doc) {\n  let interval;\n  const set = () => {\n    if (doc.body) {\n      setStyles(doc.body, {\n        opacity: 1,\n        visibility: 'visible',\n        animation: 'none'\n      });\n      clearInterval(interval);\n    }\n  };\n  interval = setInterval(set, 4);\n  set();\n}\n\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element} root\n * @param {!Element} element\n * @param {?Element} after\n */\nfunction insertAfterOrAtStart(root, element, after) {\n  if (after) {\n    if (after.nextSibling) {\n      root.insertBefore(element, after.nextSibling);\n    } else {\n      root.appendChild(element);\n    }\n  } else {\n    // Add at the start.\n    root.insertBefore(element, root.firstChild);\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Helper with all things Timer.\n */\nexport class Timer {\n\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!Promise}  */\n    this.resolved_ = Promise.resolve();\n\n    this.taskCount_ = 0;\n\n    this.canceled_ = {};\n\n    /** @const {number} */\n    this.startTime_ = this.now();\n  }\n\n  /**\n   * Returns the current EPOC time in milliseconds.\n   * @return {number}\n   */\n  now() {\n    // TODO(dvoytenko): when can we use Date.now?\n    return Number(new Date());\n  }\n\n /**\n  * Returns time since start in milliseconds.\n  * @return {number}\n  */\n  timeSinceStart() {\n    return this.now() - this.startTime_;\n  }\n\n  /**\n   * Runs the provided callback after the specified delay. This uses a micro\n   * task for 0 or no specified time. This means that the delay will actually\n   * be close to 0 and this will NOT yield to the event queue.\n   *\n   * Returns the timer ID that can be used to cancel the timer (cancel method).\n   * @param {!function()} callback\n   * @param {number=} opt_delay\n   * @return {number|string}\n   */\n  delay(callback, opt_delay) {\n    if (!opt_delay) {\n      // For a delay of zero,  schedule a promise based micro task since\n      // they are predictably fast.\n      const id = 'p' + this.taskCount_++;\n      this.resolved_.then(() => {\n        if (this.canceled_[id]) {\n          delete this.canceled_[id];\n          return;\n        }\n        callback();\n      });\n      return id;\n    }\n    return this.win.setTimeout(callback, opt_delay);\n  }\n\n  /**\n   * Cancels the previously scheduled callback.\n   * @param {number|string} timeoutId\n   */\n  cancel(timeoutId) {\n    if (typeof timeoutId == 'string') {\n      this.canceled_[timeoutId] = true;\n      return;\n    }\n    this.win.clearTimeout(timeoutId);\n  }\n\n  /**\n   * Returns a promise that will resolve after the delay. Optionally, the\n   * resolved value can be provided as opt_result argument.\n   * @param {number=} opt_delay\n   * @param {RESULT=} opt_result\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   */\n  promise(opt_delay, opt_result) {\n    let timerKey = null;\n    return new Promise((resolve, reject) => {\n      timerKey = this.delay(() => {\n        timerKey = -1;\n        resolve(opt_result);\n      }, opt_delay);\n      if (timerKey == -1) {\n        reject(new Error('Failed to schedule timer.'));\n      }\n    }).catch(error => {\n      // Clear the timer. The most likely reason is \"cancel\" signal.\n      if (timerKey != -1) {\n        this.cancel(timerKey);\n      }\n      return Promise.reject(error);\n    });\n  }\n\n  /**\n   * Returns a promise that will fail after the specified delay. Optionally,\n   * this method can take opt_racePromise parameter. In this case, the\n   * resulting promise will either fail when the specified delay expires or\n   * will resolve based on the opt_racePromise, whichever happens first.\n   * @param {number} delay\n   * @param {!Promise<RESULT>|undefined} opt_racePromise\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   */\n  timeoutPromise(delay, opt_racePromise) {\n    let timerKey = null;\n    const delayPromise = new Promise((_resolve, reject) => {\n      timerKey = this.delay(() => {\n        timerKey = -1;\n        reject('timeout');\n      }, delay);\n      if (timerKey == -1) {\n        reject(new Error('Failed to schedule timer.'));\n      }\n    }).catch(error => {\n      // Clear the timer. The most likely reason is \"cancel\" signal.\n      if (timerKey != -1) {\n        this.cancel(timerKey);\n      }\n      return Promise.reject(error);\n    });\n    if (!opt_racePromise) {\n      return delayPromise;\n    }\n    // Avoids Promise->race due to presubmit check against it.\n    return new Promise((resolve, reject) => {\n      delayPromise.then(resolve, reject);\n      opt_racePromise.then(resolve, reject);\n    });\n  }\n}\n\n\nexport const timer = new Timer(window);\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assert} from './asserts';\n\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * @param {string} url\n * @return {!Location}\n */\nexport function parseUrl(url) {\n  const a = document.createElement('a');\n  a.href = url;\n  const info = {\n    href: a.href,\n    protocol: a.protocol,\n    host: a.host,\n    hostname: a.hostname,\n    port: a.port == '0' ? '' : a.port,\n    pathname: a.pathname,\n    search: a.search,\n    hash: a.hash\n  };\n  // For data URI a.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n  info.origin = (a.origin && a.origin != 'null') ? a.origin : getOrigin(info);\n  assert(info.origin, 'Origin must exist');\n  return info;\n}\n\n\n/**\n * Asserts that a given url is HTTPS or protocol relative.\n * Provides an exception for localhost.\n * @param {string} urlString\n * @param {!Element} elementContext Element where the url was found.\n * @return {string}\n */\nexport function assertHttpsUrl(urlString, elementContext) {\n  const url = parseUrl(urlString);\n  assert(\n      url.protocol == 'https:' || /^(\\/\\/)/.test(urlString) ||\n      url.hostname == 'localhost' ||\n          url.hostname.lastIndexOf('.localhost') ==\n          // Poor person's endsWith\n          url.hostname.length - '.localhost'.length,\n      '%s source must start with ' +\n      '\"https://\" or \"//\" or be relative and served from ' +\n      'either https or from localhost. Invalid value: %s',\n      elementContext, urlString);\n  return urlString;\n}\n\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n * @param {string} queryString\n * @return {!Object<string, string>}\n */\nexport function parseQueryString(queryString) {\n  const params = Object.create(null);\n  if (!queryString) {\n    return params;\n  }\n  if (queryString.indexOf('?') == 0 || queryString.indexOf('#') == 0) {\n    queryString = queryString.substr(1);\n  }\n  const pairs = queryString.split('&');\n  for (let i = 0; i < pairs.length; i++) {\n    const pair = pairs[i];\n    const eqIndex = pair.indexOf('=');\n    let name;\n    let value;\n    if (eqIndex != -1) {\n      name = decodeURIComponent(pair.substring(0, eqIndex)).trim();\n      value = decodeURIComponent(pair.substring(eqIndex + 1)).trim();\n    } else {\n      name = decodeURIComponent(pair).trim();\n      value = '';\n    }\n    if (name) {\n      params[name] = value;\n    }\n  }\n  return params;\n}\n\n\n/**\n * Don't use this directly, only exported for testing. The value\n * is available via the origin property of the object returned by\n * parseUrl.\n * @param {!Location} info\n * @return {string}\n * @visibleForTesting\n */\nexport function getOrigin(info) {\n  if (info.protocol == 'data:' || !info.host) {\n    return info.href;\n  }\n  return info.protocol + '//' + info.host;\n}\n\n\n/**\n * Returns the URL without fragment. If URL doesn't contain fragment, the same\n * string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function removeFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return url;\n  }\n  return url.substring(0, index);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getService} from './service';\n\n\n/**\n * @param {!Window} window\n * @return {!Viewer}\n */\nexport function viewerFor(window) {\n  return getService(window, 'viewer');\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getService} from './service';\n\n/**\n * @param {!Window} window\n * @return {!Viewport}\n */\nexport function viewportFor(window) {\n  return getService(window, 'viewport');\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getService} from './service';\n\n\n/**\n * @param {!Window} window\n * @return {!Vsync}\n */\nexport function vsyncFor(window) {\n  return getService(window, 'vsync');\n};\n"]}