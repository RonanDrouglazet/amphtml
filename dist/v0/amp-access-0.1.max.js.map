{"version":3,"sources":["node_modules/browserify/node_modules/browser-pack/_prelude.js","build/all/v0/access-expr.js","build/all/v0/amp-access-0.1.max.js","node_modules/browserify/node_modules/process/browser.js","src/action.js","src/asserts.js","src/cid.js","src/cookies.js","src/document-info.js","src/document-state.js","src/event-helper.js","src/experiments.js","src/log.js","src/mode.js","src/observable.js","src/service.js","src/style.js","src/styles.js","src/timer.js","src/url-replacements.js","src/url.js","src/user-notification.js","src/viewer.js","src/viewport.js","src/vsync.js","src/xhr.js"],"names":[],"mappings":"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","file":"amp-access-0.1.max.js","sourceRoot":"/source/","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n/**\n * Evaluates access expression.\n * @param {string} expr\n * @param {!JSONObjectDef} data\n * @return {boolean}\n */\nexport function evaluateAccessExpr(expr, data) {\n  // TODO(dvoytenko): the complete expression semantics\n  if (expr == 'access') {\n    return !!data.access;\n  }\n  if (expr == 'NOT access') {\n    return !data.access;\n  }\n  return false;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {actionServiceFor} from '../../../src/action';\nimport {assertHttpsUrl} from '../../../src/url';\nimport {cidFor} from '../../../src/cid';\nimport {documentStateFor} from '../../../src/document-state';\nimport {evaluateAccessExpr} from './access-expr';\nimport {getService} from '../../../src/service';\nimport {installStyles} from '../../../src/styles';\nimport {isExperimentOn} from '../../../src/experiments';\nimport {listenOnce} from '../../../src/event-helper';\nimport {log} from '../../../src/log';\nimport {onDocumentReady} from '../../../src/document-state';\nimport {timer} from '../../../src/timer';\nimport {urlReplacementsFor} from '../../../src/url-replacements';\nimport {viewerFor} from '../../../src/viewer';\nimport {viewportFor} from '../../../src/viewport';\nimport {vsyncFor} from '../../../src/vsync';\nimport {xhrFor} from '../../../src/xhr';\n\n\n/**\n * The configuration properties are:\n * - authorization: The URL of the Authorization endpoint.\n * - pingback: The URL of the Pingback endpoint.\n * - login: The URL of the Login Page.\n *\n * @typedef {{\n *   authorization: string,\n *   pingback: string,\n *   login: string\n * }}\n */\nlet AccessConfigDef;\n\n/** @const {!Function} */\nconst assert = AMP.assert;\n\n/** @const */\nconst EXPERIMENT = 'amp-access';\n\n/** @const */\nconst TAG = 'AmpAccess';\n\n/** @const {number} */\nconst VIEW_TIMEOUT = 2000;\n\n\n/**\n * AccessService implements the complete lifecycle of the AMP Access system.\n */\nexport class AccessService {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n    installStyles(this.win.document, \"\\n/*# sourceURL=/extensions/amp-access/0.1/amp-access.css*/\", () => {});\n\n    /** @const @private {boolean} */\n    this.isExperimentOn_ = isExperimentOn(this.win, EXPERIMENT);\n\n    const accessElement = document.getElementById('amp-access');\n\n    /** @const @private {boolean} */\n    this.enabled_ = !!accessElement;\n    if (!this.enabled_) {\n      return;\n    }\n\n    /** @const @private {!Element} */\n    this.accessElement_ = accessElement;\n\n    /** @const @private {!AccessConfigDef} */\n    this.config_ = this.buildConfig_();\n\n    /** @const @private {!Vsync} */\n    this.vsync_ = vsyncFor(this.win);\n\n    /** @const @private {!Xhr} */\n    this.xhr_ = xhrFor(this.win);\n\n    /** @const @private {!UrlReplacements} */\n    this.urlReplacements_ = urlReplacementsFor(this.win);\n\n    /** @private @const {!Cid} */\n    this.cid_ = cidFor(this.win);\n\n    /** @private @const {!Viewer} */\n    this.viewer_ = viewerFor(this.win);\n\n    /** @private @const {!DocumentState} */\n    this.docState_ = documentStateFor(this.win);\n\n    /** @private @const {!Viewport} */\n    this.viewport_ = viewportFor(this.win);\n\n    /** @private {?Promise<string>} */\n    this.readerIdPromise_ = null;\n\n    /** @private {?Promise} */\n    this.reportViewPromise_ = null;\n  }\n\n  /**\n   * @return {!AccessConfigDef}\n   * @private\n   */\n  buildConfig_() {\n    let config;\n    try {\n      config = JSON.parse(this.accessElement_.textContent);\n    } catch (e) {\n      throw new Error('Failed to parse \"amp-access\" JSON: ' + e);\n    }\n    return {\n      authorization: assertHttpsUrl(assert(config['authorization'],\n          '\"authorization\" URL must be specified')),\n      pingback: assertHttpsUrl(assert(config['pingback'],\n          '\"pingback\" URL must be specified')),\n      login: assertHttpsUrl(assert(config['login'],\n          '\"login\" URL must be specified')),\n    };\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isEnabled() {\n    return this.enabled_;\n  }\n\n  /**\n   * @return {!AccessService}\n   * @private\n   */\n  start_() {\n    if (!this.isExperimentOn_) {\n      log.info(TAG, 'Access experiment is off: ', EXPERIMENT);\n      return this;\n    }\n    if (!this.enabled_) {\n      log.info(TAG, 'Access is disabled - no \"id=amp-access\" element');\n      return this;\n    }\n    this.startInternal_();\n    return this;\n  }\n\n  /** @private */\n  startInternal_() {\n    actionServiceFor(this.win).installActionHandler(\n        this.accessElement_, this.handleAction_.bind(this));\n\n    // Start authorization XHR immediately.\n    this.runAuthorization_();\n\n    // Wait for the \"view\" signal.\n    this.scheduleView_();\n  }\n\n  /**\n   * @return {!Promise<string>}\n   * @private\n   */\n  getReaderId_() {\n    if (!this.readerIdPromise_) {\n      // No consent - an essential part of the access system.\n      const consent = Promise.resolve();\n      this.readerIdPromise_ = this.cid_.then(cid => {\n        return cid.get('amp-access', consent);\n      });\n    }\n    return this.readerIdPromise_;\n  }\n\n  /**\n   * @param {string} url\n   * @return {!Promise<string>}\n   * @private\n   */\n  buildUrl_(url) {\n    return this.getReaderId_().then(readerId => {\n      return this.urlReplacements_.expand(url, {\n        'READER_ID': readerId\n      });\n    });\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  runAuthorization_() {\n    log.fine(TAG, 'Start authorization via ', this.config_.authorization);\n    this.toggleTopClass_('amp-access-loading', true);\n    return this.buildUrl_(this.config_.authorization).then(url => {\n      log.fine(TAG, 'Authorization URL: ', url);\n      return this.xhr_.fetchJson(url, {credentials: 'include'});\n    }).then(response => {\n      log.fine(TAG, 'Authorization response: ', response);\n      this.toggleTopClass_('amp-access-loading', false);\n      onDocumentReady(this.win.document, () => {\n        this.applyAuthorization_(response);\n      });\n    }).catch(error => {\n      log.error(TAG, 'Authorization failed: ', error);\n      this.toggleTopClass_('amp-access-loading', false);\n    });\n  }\n\n  /**\n   * @param {!JSONObjectDef} response\n   * @private\n   */\n  applyAuthorization_(response) {\n    const elements = this.win.document.querySelectorAll('[amp-access]');\n    for (let i = 0; i < elements.length; i++) {\n      this.applyAuthorizationToElement_(elements[i], response);\n    }\n  }\n\n  /**\n   * @param {!Element} element\n   * @param {!JSONObjectDef} response\n   * @private\n   */\n  applyAuthorizationToElement_(element, response) {\n    const expr = element.getAttribute('amp-access');\n    const on = evaluateAccessExpr(expr, response);\n\n    // TODO(dvoytenko): support templates\n\n    this.vsync_.mutate(() => {\n      if (on) {\n        element.removeAttribute('amp-access-off');\n      } else {\n        element.setAttribute('amp-access-off', '');\n      }\n    });\n  }\n\n  /**\n   * @private\n   */\n  scheduleView_() {\n    this.docState_.onReady(() => {\n      if (this.viewer_.isVisible()) {\n        this.reportWhenViewed_();\n      }\n      this.viewer_.onVisibilityChanged(() => {\n        if (this.viewer_.isVisible()) {\n          this.reportWhenViewed_();\n        }\n      });\n    });\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  reportWhenViewed_() {\n    if (this.reportViewPromise_) {\n      return this.reportViewPromise_;\n    }\n    log.fine(TAG, 'start view monitoring');\n    this.reportViewPromise_ = this.whenViewed_().then(\n        this.reportViewToServer_.bind(this),\n        reason => {\n          // Ignore - view has been canceled.\n          log.fine(TAG, 'view cancelled:', reason);\n          this.reportViewPromise_ = null;\n          throw reason;\n        });\n    return this.reportViewPromise_;\n  }\n\n  /**\n   * The promise will be resolved when a view of this document has occurred. It\n   * will be rejected if the current impression should not be counted as a view.\n   * @return {!Promise}\n   * @private\n   */\n  whenViewed_() {\n    // Viewing kick off: document is visible.\n    const unlistenSet = [];\n    return new Promise((resolve, reject) => {\n      // 1. Document becomes invisible again: cancel.\n      unlistenSet.push(this.viewer_.onVisibilityChanged(() => {\n        if (!this.viewer_.isVisible()) {\n          reject();\n        }\n      }));\n\n      // 2. After a few seconds: register a view.\n      const timeoutId = timer.delay(resolve, VIEW_TIMEOUT);\n      unlistenSet.push(() => timer.cancel(timeoutId));\n\n      // 3. If scrolled: register a view.\n      unlistenSet.push(this.viewport_.onScroll(resolve));\n\n      // 4. Tap: register a view.\n      unlistenSet.push(listenOnce(this.win.document.documentElement,\n          'click', resolve));\n    }).then(() => {\n      unlistenSet.forEach(unlisten => unlisten());\n    }, reason => {\n      unlistenSet.forEach(unlisten => unlisten());\n      throw reason;\n    });\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  reportViewToServer_() {\n    return this.buildUrl_(this.config_.pingback).then(url => {\n      log.fine(TAG, 'Pingback URL: ', url);\n      return this.xhr_.sendSignal(url, {\n        method: 'POST',\n        credentials: 'include',\n        headers: {\n          'Content-Type': 'application/x-www-form-urlencoded'\n        },\n        body: ''\n      });\n    }).then(() => {\n      log.fine(TAG, 'Pingback complete');\n    }).catch(error => {\n      log.error(TAG, 'Pingback failed: ', error);\n      throw error;\n    });\n  }\n\n  /**\n   * @param {string} className\n   * @param {boolean} on\n   * @private\n   */\n  toggleTopClass_(className, on) {\n    this.vsync_.mutate(() => {\n      this.win.document.documentElement.classList.toggle(className, on);\n    });\n  }\n\n  /**\n   * @param {!ActionInvocation} invocation\n   * @private\n   */\n  handleAction_(invocation) {\n    log.fine(TAG, 'Invocation: ', invocation);\n  }\n}\n\n\n/**\n * @param {!Window} win\n * @return {!AccessService}\n */\nexport function installAccessService(win) {\n  return getService(win, 'access', () => {\n    return new AccessService(win).start_();\n  });\n};\n\ninstallAccessService(AMP.win);\n","// shim for using process in browser\n\nvar process = module.exports = {};\nvar queue = [];\nvar draining = false;\nvar currentQueue;\nvar queueIndex = -1;\n\nfunction cleanUpNextTick() {\n    draining = false;\n    if (currentQueue.length) {\n        queue = currentQueue.concat(queue);\n    } else {\n        queueIndex = -1;\n    }\n    if (queue.length) {\n        drainQueue();\n    }\n}\n\nfunction drainQueue() {\n    if (draining) {\n        return;\n    }\n    var timeout = setTimeout(cleanUpNextTick);\n    draining = true;\n\n    var len = queue.length;\n    while(len) {\n        currentQueue = queue;\n        queue = [];\n        while (++queueIndex < len) {\n            if (currentQueue) {\n                currentQueue[queueIndex].run();\n            }\n        }\n        queueIndex = -1;\n        len = queue.length;\n    }\n    currentQueue = null;\n    draining = false;\n    clearTimeout(timeout);\n}\n\nprocess.nextTick = function (fun) {\n    var args = new Array(arguments.length - 1);\n    if (arguments.length > 1) {\n        for (var i = 1; i < arguments.length; i++) {\n            args[i - 1] = arguments[i];\n        }\n    }\n    queue.push(new Item(fun, args));\n    if (queue.length === 1 && !draining) {\n        setTimeout(drainQueue, 0);\n    }\n};\n\n// v8 likes predictible objects\nfunction Item(fun, array) {\n    this.fun = fun;\n    this.array = array;\n}\nItem.prototype.run = function () {\n    this.fun.apply(null, this.array);\n};\nprocess.title = 'browser';\nprocess.browser = true;\nprocess.env = {};\nprocess.argv = [];\nprocess.version = ''; // empty string to avoid regexp issues\nprocess.versions = {};\n\nfunction noop() {}\n\nprocess.on = noop;\nprocess.addListener = noop;\nprocess.once = noop;\nprocess.off = noop;\nprocess.removeListener = noop;\nprocess.removeAllListeners = noop;\nprocess.emit = noop;\n\nprocess.binding = function (name) {\n    throw new Error('process.binding is not supported');\n};\n\nprocess.cwd = function () { return '/' };\nprocess.chdir = function (dir) {\n    throw new Error('process.chdir is not supported');\n};\nprocess.umask = function() { return 0; };\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getService} from './service';\n\n\n/**\n * @param {!Window} win\n * @return {!Action}\n */\nexport function actionServiceFor(win) {\n  return getService(win, 'action');\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {string} message The assertion message\n * @param {...*} var_args Arguments substituted into %s in the message.\n * @return {T} The value of shouldBeTrueish.\n * @template T\n */\n/*eslint \"google-camelcase/google-camelcase\": 0*/\nexport function assert(shouldBeTrueish, message, var_args) {\n  let firstElement;\n  if (!shouldBeTrueish) {\n    message = message || 'Assertion failed';\n    const splitMessage = message.split('%s');\n    const first = splitMessage.shift();\n    let formatted = first;\n    const messageArray = [];\n    pushIfNonEmpty(messageArray, first);\n    for (let i = 2; i < arguments.length; i++) {\n      const val = arguments[i];\n      if (val && val.tagName) {\n        firstElement = val;\n      }\n      const nextConstant = splitMessage.shift();\n      messageArray.push(val);\n      pushIfNonEmpty(messageArray, nextConstant.trim());\n      formatted += toString(val) + nextConstant;\n    }\n    const e = new Error(formatted);\n    e.fromAssert = true;\n    e.associatedElement = firstElement;\n    e.messageArray = messageArray;\n    throw e;\n  }\n  return shouldBeTrueish;\n}\n/*eslint \"google-camelcase/google-camelcase\": 2*/\n\n/**\n * @param {*} val\n * @return {string}\n */\nfunction toString(val) {\n  if (val instanceof Element) {\n    return val.tagName.toLowerCase() + (val.id ? '#' + val.id : '');\n  }\n  return val;\n}\n\n/**\n * @param {!Array} array\n * @param {*} val\n */\nfunction pushIfNonEmpty(array, val) {\n  if (val != '') {\n    array.push(val);\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Factory for ./service/cid-impl.js\n */\n\nimport {getElementService} from './service';\n\n/**\n * @param {!Window} window\n * @return {!Promise<!Cid>}\n */\nexport function cidFor(window) {\n  return getElementService(window, 'cid', 'amp-analytics');\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n/**\n * Returns the value of the cookie. The cookie access is restricted and must\n * go through the privacy review. Before using this method please file a\n * GitHub issue with \"Privacy Review\" label.\n *\n * Returns the cookie's value or `null`.\n *\n * @param {!Window} win\n * @param {string} name\n * @return {?string}\n */\nexport function getCookie(win, name) {\n  const cookieString = win.document.cookie;\n  if (!cookieString) {\n    return null;\n  }\n  const cookies = cookieString.split(';');\n  for (let i = 0; i < cookies.length; i++) {\n    const cookie = cookies[i].trim();\n    const eq = cookie.indexOf('=');\n    if (eq == -1) {\n      continue;\n    }\n    if (decodeURIComponent(cookie.substring(0, eq).trim()) == name) {\n      return decodeURIComponent(cookie.substring(eq + 1).trim());\n    }\n  }\n  return null;\n}\n\n/**\n * Sets the value of the cookie. The cookie access is restricted and must\n * go through the privacy review. Before using this method please file a\n * GitHub issue with \"Privacy Review\" label.\n *\n * @param {!Window} win\n * @param {string} name\n * @param {string} value\n * @param {time} expirationTime\n */\nexport function setCookie(win, name, value, expirationTime) {\n  win.document.cookie = encodeURIComponent(name) + '=' +\n      encodeURIComponent(value) +\n      '; path=/' +\n      '; expires=' + new Date(expirationTime).toUTCString();\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getService} from './service';\nimport {assert} from './asserts';\nimport {parseUrl} from './url';\n\n/**\n * @param {!Window} win\n * @return {{canonicalUrl: string, pageViewId: string}} Info about the doc\n *     - canonicalUrl: The doc's canonical.\n *     - pageViewId: Id for this page view. Low entropy but should be unique\n *       for concurrent page views of a user.\n */\nexport function documentInfoFor(win) {\n  return getService(win, 'documentInfo', () => {\n    return {\n      canonicalUrl: parseUrl(assert(\n          win.document.querySelector('link[rel=canonical]'),\n              'AMP files are required to have a <link rel=canonical> tag.')\n              .href).href,\n      pageViewId: getPageViewId(win),\n    };\n  });\n}\n\n/**\n * Returns a relatively low entropy random string.\n * This should be called once per window and then cached for subsequent\n * access to the same value to be persistent per page.\n * @param {!Window} win\n * @return {string}\n */\nfunction getPageViewId(win) {\n  return String(Math.floor(win.Math.random() * 10000));\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from './observable';\nimport {getService} from './service';\nimport {getVendorJsPropertyName} from './style';\n\n\n/**\n * Whether the document is ready.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isDocumentReady(doc) {\n  return doc.readyState != 'loading';\n}\n\n\n/**\n * Calls the callback when document is ready.\n * @param {!Document} doc\n * @param {!Function} callback\n */\nexport function onDocumentReady(doc, callback) {\n  let ready = isDocumentReady(doc);\n  if (ready) {\n    callback();\n  } else {\n    const readyListener = () => {\n      if (doc.readyState != 'loading') {\n        if (!ready) {\n          ready = true;\n          callback();\n        }\n        doc.removeEventListener('readystatechange', readyListener);\n      }\n    };\n    doc.addEventListener('readystatechange', readyListener);\n  }\n}\n\n/**\n * Returns a promise that is resolved when document is ready.\n * @param {!Document} doc\n * @return {!Promise}\n */\nexport function whenDocumentReady(doc) {\n  return new Promise(resolve => {\n    onDocumentReady(doc, resolve);\n  });\n}\n\n\n/**\n */\nexport class DocumentState {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!Document} */\n    this.document_ = win.document;\n\n    /** @private @const {string|null} */\n    this.hiddenProp_ = getVendorJsPropertyName(this.document_, 'hidden', true);\n    if (this.document_[this.hiddenProp_] === undefined) {\n      this.hiddenProp_ = null;\n    }\n\n    /** @private @const {string|null} */\n    this.visibilityStateProp_ = getVendorJsPropertyName(this.document_,\n        'visibilityState', true);\n    if (this.document_[this.visibilityStateProp_] === undefined) {\n      this.visibilityStateProp_ = null;\n    }\n\n    /** @private @const */\n    this.visibilityObservable_ = new Observable();\n\n    /** @private @const {string|null} */\n    this.visibilityChangeEvent_ = null;\n    if (this.hiddenProp_) {\n      this.visibilityChangeEvent_ = 'visibilitychange';\n      const vendorStop = this.hiddenProp_.indexOf('Hidden');\n      if (vendorStop != -1) {\n        this.visibilityChangeEvent_ =\n            this.hiddenProp_.substring(0, vendorStop) + 'Visibilitychange';\n      }\n    }\n\n    /** @private @const {!Function} */\n    this.boundOnVisibilityChanged_ = this.onVisibilityChanged_.bind(this);\n    if (this.visibilityChangeEvent_) {\n      this.document_.addEventListener(this.visibilityChangeEvent_,\n          this.boundOnVisibilityChanged_);\n    }\n  }\n\n  /** @private */\n  cleanup_() {\n    if (this.visibilityChangeEvent_) {\n      this.document_.removeEventListener(this.visibilityChangeEvent_,\n          this.boundOnVisibilityChanged_);\n    }\n  }\n\n  /**\n   * Whether the document is ready.\n   * @return {boolean}\n   */\n  isReady() {\n    return isDocumentReady(this.document_);\n  }\n\n  /**\n   * Calls the callback when document is ready.\n   * @param {!Function} callback\n   */\n  onReady(callback) {\n    return onDocumentReady(this.document_, callback);\n  }\n\n  /**\n   * Returns the value of \"document.hidden\" property. The reasons why it may\n   * not be visible include document in a non-active tab or when the document\n   * is being pre-rendered via link with rel=\"prerender\".\n   * @return {boolean}\n   */\n  isHidden() {\n    if (!this.hiddenProp_) {\n      return false;\n    }\n    return this.document_[this.hiddenProp_];\n  }\n\n  /**\n   * Returns the value of \"document.visibilityState\" property. Possible values\n   * are: 'hidden', 'visible', 'prerender', and 'unloaded'.\n   * @return {string}\n   */\n  getVisibilityState() {\n    if (!this.visibilityStateProp_) {\n      return !this.isHidden() ? 'visible' : 'hidden';\n    }\n    return this.document_[this.visibilityStateProp_];\n  }\n\n  /**\n   * @param {function()} handler\n   * @return {!UnlistenDef}\n   */\n  onVisibilityChanged(handler) {\n    return this.visibilityObservable_.add(handler);\n  }\n\n  /** @private */\n  onVisibilityChanged_() {\n    this.visibilityObservable_.fire();\n  }\n}\n\n\n/**\n * @param {!Window} window\n * @return {!DocumentState}\n * @private\n */\nfunction createDocumentState_(window) {\n  return new DocumentState(window);\n}\n\n\n/**\n * @param {!Window} window\n * @return {!DocumentState}\n */\nexport function documentStateFor(window) {\n  return getService(window, 'documentState', () => {\n    return createDocumentState_(window);\n  });\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {timer} from './timer';\n\n\n/**\n * Listens for the specified event on the element and removes the listener\n * as soon as event has been received.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(Event)} listener\n * @param {boolean=} opt_capture\n * @return {!UnlistenDef}\n */\nexport function listenOnce(element, eventType, listener, opt_capture) {\n  const capture = opt_capture || false;\n  let unlisten;\n  const proxy = event => {\n    listener(event);\n    unlisten();\n  };\n  unlisten = () => {\n    element.removeEventListener(eventType, proxy, capture);\n  };\n  element.addEventListener(eventType, proxy, capture);\n  return unlisten;\n}\n\n\n/**\n * Returns  a promise that will resolve as soon as the specified event has\n * fired on the element. Optionally, opt_timeout can be specified that will\n * reject the promise if the event has not fired by then.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {boolean=} opt_capture\n * @param {number=} opt_timeout\n * @return {!Promise<!Event>}\n */\nexport function listenOncePromise(element, eventType, opt_capture,\n    opt_timeout) {\n  let unlisten;\n  const eventPromise = new Promise((resolve, unusedReject) => {\n    unlisten = listenOnce(element, eventType, resolve, opt_capture);\n  });\n  return racePromise_(eventPromise, unlisten, opt_timeout);\n}\n\n\n/**\n * Whether the specified element has been loaded already.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isLoaded(element) {\n  return element.complete || element.readyState == 'complete';\n}\n\n\n/**\n * Returns a promise that will resolve or fail based on the element's 'load'\n * and 'error' events. Optionally this method takes a timeout, which will reject\n * the promise if the resource has not loaded by then.\n * @param {!Element} element\n * @param {number=} opt_timeout\n * @return {!Promise<!Element>}\n */\nexport function loadPromise(element, opt_timeout) {\n  let unlistenLoad;\n  let unlistenError;\n  const loadingPromise = new Promise((resolve, reject) => {\n    if (isLoaded(element)) {\n      resolve(element);\n    } else {\n      // Listen once since IE 5/6/7 fire the onload event continuously for\n      // animated GIFs.\n      if (element.tagName === 'AUDIO' || element.tagName === 'VIDEO') {\n        unlistenLoad = listenOnce(element, 'loadstart', () => resolve(element));\n      } else {\n        unlistenLoad = listenOnce(element, 'load', () => resolve(element));\n      }\n      unlistenError = listenOnce(element, 'error', reject);\n    }\n  });\n  return racePromise_(loadingPromise, () => {\n    // It's critical that all listeners are removed.\n    if (unlistenLoad) {\n      unlistenLoad();\n    }\n    if (unlistenError) {\n      unlistenError();\n    }\n  }, opt_timeout);\n}\n\n\n/**\n * @param {!Promise<TYPE>} promise\n * @param {Unlisten|undefined} unlisten\n * @param {number|undefined} timeout\n * @return {!Promise<TYPE>}\n * @template TYPE\n */\nfunction racePromise_(promise, unlisten, timeout) {\n  let racePromise;\n  if (timeout === undefined) {\n    // Timeout is not specified: return promise.\n    racePromise = promise;\n  } else {\n    // Timeout has been specified: add a timeout condition.\n    racePromise = timer.timeoutPromise(timeout || 0, promise);\n  }\n  if (!unlisten) {\n    return racePromise;\n  }\n  return racePromise.then(result => {\n    unlisten();\n    return result;\n  }, reason => {\n    unlisten();\n    throw reason;\n  });\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Experiments system allows a developer to opt-in to test\n * features that are not yet fully tested.\n *\n * Experiments page: https://cdn.ampproject.org/experiments.html *\n */\n\nimport {getCookie, setCookie} from './cookies';\nimport {timer} from './timer';\n\n\n/** @const {string} */\nconst COOKIE_NAME = 'AMP_EXP';\n\n/** @const {number} */\nconst COOKIE_MAX_AGE_DAYS = 180;  // 6 month\n\n/** @const {time} */\nconst COOKIE_EXPIRATION_INTERVAL = COOKIE_MAX_AGE_DAYS * 24 * 60 * 60 * 1000;\n\n\n/**\n * Whether the specified experiment is on or off.\n * @param {!Window} win\n * @param {string} experimentId\n * @return {boolean}\n */\nexport function isExperimentOn(win, experimentId) {\n  return getExperimentIds(win).indexOf(experimentId) != -1;\n}\n\n\n/**\n * Toggles the expriment on or off. Returns the actual value of the expriment\n * after toggling is done.\n * @param {!Window} win\n * @param {string} experimentId\n * @param {boolean=} opt_on\n * @return {boolean}\n */\nexport function toggleExperiment(win, experimentId, opt_on) {\n  const experimentIds = getExperimentIds(win);\n  const currentlyOn = experimentIds.indexOf(experimentId) != -1;\n  const on = opt_on !== undefined ? opt_on : !currentlyOn;\n  if (on != currentlyOn) {\n    if (on) {\n      experimentIds.push(experimentId);\n    } else {\n      experimentIds.splice(experimentIds.indexOf(experimentId), 1);\n    }\n    saveExperimentIds(win, experimentIds);\n  }\n  return on;\n}\n\n\n/**\n * Returns a set of experiment IDs currently on.\n * @param {!Window} win\n * @return {!Array<string>}\n */\nfunction getExperimentIds(win) {\n  const experimentCookie = getCookie(win, COOKIE_NAME);\n  return experimentCookie ? experimentCookie.split(/\\s*,\\s*/g) : [];\n}\n\n\n/**\n * Saves a set of experiment IDs currently on.\n * @param {!Window} win\n * @param {!Array<string>} experimentIds\n */\nfunction saveExperimentIds(win, experimentIds) {\n  setCookie(win, COOKIE_NAME, experimentIds.join(','),\n      timer.now() + COOKIE_EXPIRATION_INTERVAL);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from './mode';\n\n/** @const Time when this JS loaded.  */\nconst start = new Date().getTime();\n\n\n/**\n * Logging.\n * // TODO(@cramforce): Make this DCRable.\n * Add #log=1 to URL to turn on logging when in prod (providing a build with\n * logging is used and #log=0 to turn off logging in local dev.\n * @final\n */\nexport class Log {\n\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /**\n     * In tests we use the main test window instead of the iframe where\n     * the tests runs because only the former is relayed to the console.\n     * @const {!Window}\n     */\n    this.win = win.AMP_TEST ? win.parent : win;\n\n    /** @private {boolean} */\n    this.isEnabled_ = this.shouldBeEnabled_();\n  }\n\n  shouldBeEnabled_() {\n    if (!this.win.console || !this.win.console.log) {\n      return false;\n    }\n    // Search for #log=0 or log=1\n    const match = this.win.location.hash.match(/log=(\\d)/);\n    const shouldLog = match && match[1];\n    if (getMode().localDev && shouldLog != '0') {\n      return true;\n    }\n    if (this.win.location.hash && shouldLog == '1') {\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * @param {string} tag\n   * @param {string} level\n   * @param {!Array} messages\n   * @param {?} opt_error\n   */\n  msg_(tag, level, messages) {\n    if (this.isEnabled_) {\n      let fn = this.win.console.log;\n      if (level == 'ERROR') {\n        fn = this.win.console.error || fn;\n      } else if (level == 'INFO') {\n        fn = this.win.console.info || fn;\n      } else if (level == 'WARN') {\n        fn = this.win.console.warn || fn;\n      }\n      messages.unshift(new Date().getTime() - start, '[' + tag + ']');\n      fn.apply(this.win.console, messages);\n    }\n  }\n\n  /**\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  fine(tag, var_args) {\n    if (this.isEnabled_) {\n      this.msg_(tag, 'FINE', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n\n  /**\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  info(tag, var_args) {\n    if (this.isEnabled_) {\n      this.msg_(tag, 'INFO', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n\n  /**\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  warn(tag, var_args) {\n    if (this.isEnabled_) {\n      this.msg_(tag, 'WARN', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n\n  /**\n   * @param {string} tag\n   * @param {...*} var_args\n   * @param {?} opt_error\n   */\n  error(tag, var_args) {\n    if (this.isEnabled_) {\n      this.msg_(tag, 'ERROR', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n};\n\n\nexport const log = new Log(window);\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {parseQueryString} from './url';\n\n\n/**\n * @typedef {{\n *   localDev: boolean\n * }}\n */\nlet ModeDef;\n\n/** @typedef {?ModeDef} */\nlet mode = null;\n\n/**\n * Provides info about the current app.\n * @return {!ModeDef}\n */\nexport function getMode() {\n  if (mode) {\n    return mode;\n  }\n  return mode = getMode_();\n}\n\n/**\n * Set mode in a test. Pass null in afterEach function to reset.\n * @param {?ModeDef} m\n */\nexport function setModeForTesting(m) {\n  mode = m;\n}\n\n/**\n * Provides info about the current app.\n * @return {!ModeDef}\n */\nfunction getMode_() {\n  const isLocalDev = (location.hostname == 'localhost' ||\n      (location.ancestorOrigins && location.ancestorOrigins[0] &&\n          location.ancestorOrigins[0].indexOf('http://localhost:') == 0)) &&\n      // Filter out localhost running against a prod script.\n      // Because all allowed scripts are ours, we know that these can only\n      // occur during local dev.\n      !!document.querySelector('script[src*=\"/dist/\"],script[src*=\"/base/\"]');\n\n  const overrideDevelopment = parseQueryString(location.hash)['development'];\n  const development = overrideDevelopment != undefined\n      ? overrideDevelopment == '1'\n      : !!document.querySelector('script[development]');\n\n  return {\n    localDev: isLocalDev,\n    // Triggers validation\n    development: development,\n    minified: process.env.NODE_ENV == 'production',\n    test: window.AMP_TEST\n  };\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n/**\n * This type signifies a callback that can be called to remove the listener.\n * @typedef {function()}\n */\nclass UnlistenDef {}\n\n\n/**\n * This class helps to manage observers. Observers can be added, removed or\n * fired through and instance of this class.\n * @template TYPE\n */\nexport class Observable {\n\n  constructor() {\n    /** @const {!Array<function(TYPE)>} */\n    this.handlers_ = [];\n  }\n\n  /**\n   * Adds the observer to this instance.\n   * @param {function(TYPE)} handler Observer's handler.\n   * @return {!UnlistenDef}\n   */\n  add(handler) {\n    this.handlers_.push(handler);\n    return () => {\n      this.remove(handler);\n    };\n  }\n\n  /**\n   * Removes the observer from this instance.\n   * @param {function(TYPE)} handler Observer's instance.\n   */\n  remove(handler) {\n    for (let i = 0; i < this.handlers_.length; i++) {\n      if (handler == this.handlers_[i]) {\n        this.handlers_.splice(i, 1);\n        break;\n      }\n    }\n  }\n\n  /**\n   * Fires an event. All observers are called.\n   * @param {TYPE} event\n   */\n  fire(event) {\n    this.handlers_.forEach(handler => {\n      handler(event);\n    });\n  }\n\n  /**\n   * Returns number of handlers. Mostly needed for tests.\n   * @return {number}\n   */\n  getHandlerCount() {\n    return this.handlers_.length;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assert} from './asserts';\n\n/**\n * Holds info about a service.\n * - obj: Actual service implementation when available.\n * - promise: Promise for the obj.\n * - resolve: Function to resolve the promise with the object.\n * @typedef {{\n *   obj: (?Object),\n *   promise: (?Promise|undefined),\n *   resolve: (?function(!Object)|undefined),\n * }}\n */\nlet ServiceHolderDef;\n\n/**\n * Returns a service for the given id and window (a per-window singleton).\n * If the service is not yet available the factory function is invoked and\n * expected to return the service.\n * Users should typically wrap this as a special purpose function (e.g.\n * viewportFor(win)) for type safety and because the factory should not be\n * passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {function(!Window):!Object=} opt_factory Should create the service\n *     if it does not exist yet. If the factory is not given, it is an error\n *     if the service does not exist yet.\n * @return {*}\n */\nexport function getService(win, id, opt_factory) {\n  const services = getServices(win);\n  let s = services[id];\n  if (!s) {\n    s = services[id] = {};\n  }\n  if (!s.obj) {\n    assert(opt_factory, 'Factory not given and service missing %s', id);\n    s.obj = opt_factory(win);\n    // The service may have been requested already, in which case we have a\n    // pending promise we need to fulfill.\n    if (s.resolve) {\n      s.resolve(s.obj);\n    }\n  }\n  return s.obj;\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects\n * an element that has the actual implementation. The promise resolves when\n * the implementation loaded.\n * Users should typically wrap this as a special purpose function (e.g.\n * viewportFor(win)) for type safety and because the factory should not be\n * passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} provideByElement Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<*>}\n */\nexport function getElementService(win, id, providedByElement) {\n  // Call `getElementService_` in a micro-task to ensure that `stubElements`\n  // has been called.\n  return Promise.resolve().then(() => {\n    return getElementService_(win, id, providedByElement);\n  });\n}\n\n/**\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} provideByElement Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<*>}\n * @private\n */\nfunction getElementService_(win, id, providedByElement) {\n  assert(isElementScheduled(win, providedByElement),\n      'Service %s was requested to be provided through %s, ' +\n      'but %s is not loaded in the current page. To fix this ' +\n      'problem load the JavaScript file for %s in this page.',\n      id, providedByElement, providedByElement, providedByElement);\n  const services = getServices(win);\n  const s = services[id];\n  if (s) {\n    // If a service was registered with getService, we make a promise from it\n    // which we will return in future invocations.\n    if (!s.promise) {\n      s.promise = Promise.resolve(s.obj);\n    }\n    return s.promise;\n  }\n  // TODO(@cramforce): Add a check that if the element is eventually registered\n  // that the service is actually provided and this promise resolves.\n  let resolve;\n  const p = new Promise(r => {\n    resolve = r;\n  });\n  services[id] = {\n    obj: null,\n    promise: p,\n    resolve: resolve,\n  };\n\n  return p;\n}\n\n/**\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @return {boolean} Whether this element is scheduled to be loaded.\n */\nfunction isElementScheduled(win, elementName) {\n  assert(win.ampExtendedElements, 'win.ampExtendedElements not created yet');\n  return !!win.ampExtendedElements[elementName];\n}\n\n/**\n * In order to provide better error messages we only allow to retrieve\n * services from other elements if those elements are loaded in the page.\n * This makes it possible to mark an element as loaded in a test.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n */\nexport function markElementScheduledForTesting(win, elementName) {\n  if (!win.ampExtendedElements) {\n    win.ampExtendedElements = {};\n  }\n  win.ampExtendedElements[elementName] = true;\n}\n\n/**\n * Returns the object that holds the services registered in a window.\n * @param {!Window} win\n * @return {!Object<string,!ServiceHolderDef>}\n */\nfunction getServices(win) {\n  let services = win.services;\n  if (!services) {\n    services = win.services = {};\n  }\n  return services;\n}\n\n/**\n * Resets a single service, so it gets recreated on next getService invocation.\n * @param {!Window} win\n * @param {string} id of the service.\n */\nexport function resetServiceForTesting(win, id) {\n  if (win.services) {\n    win.services[id] = null;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n\n// Note: loaded by 3p system. Cannot rely on babel polyfills.\n\n/** @private @const {!Object<string>} */\nconst propertyNameCache_ = Object.create(null);\n\n/** @private @const {!Array<string>} */\nconst vendorPrefixes_ = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n\n\n/**\n * @export\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\nexport function camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n\n/**\n * Checks the object if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} object\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\nfunction getVendorJsPropertyName_(object, titleCase) {\n  for (let i = 0; i < vendorPrefixes_.length; i++) {\n    const propertyName = vendorPrefixes_[i] + titleCase;\n    if (object[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n  return '';\n}\n\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @export\n * @param {!Object} object\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} opt_bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\nexport function getVendorJsPropertyName(object, camelCase, opt_bypassCache) {\n  let propertyName = propertyNameCache_[camelCase];\n  if (!propertyName || opt_bypassCache) {\n    propertyName = camelCase;\n    if (object[camelCase] === undefined) {\n      const titleCase = camelCaseToTitleCase(camelCase);\n      const prefixedPropertyName = getVendorJsPropertyName_(object, titleCase);\n\n      if (object[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n    if (!opt_bypassCache) {\n      propertyNameCache_[camelCase] = propertyName;\n    }\n  }\n  return propertyName;\n}\n\n\n/**\n * Sets the CSS style of the specified element with optional units, e.g. \"px\".\n * @param {!Element} element\n * @param {string} property\n * @param {*} value\n * @param {string=} opt_units\n * @param {boolean=} opt_bypassCache\n */\nexport function setStyle(element, property, value, opt_units, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(element.style, property,\n      opt_bypassCache);\n  if (propertyName) {\n    element.style[propertyName] = opt_units ? value + opt_units : value;\n  }\n}\n\n\n/**\n * Returns the value of the CSS style of the specified element.\n * @param {!Element} element\n * @param {string} property\n * @param {boolean=} opt_bypassCache\n * @return {*}\n */\nexport function getStyle(element, property, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(element.style, property,\n      opt_bypassCache);\n  if (!propertyName) {\n    return undefined;\n  }\n  return element.style[propertyName];\n}\n\n\n/**\n * Sets the CSS styles of the specified element. The styles\n * a specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setStyles(element, styles) {\n  for (const k in styles) {\n    setStyle(element, k, styles[k]);\n  }\n}\n\n\n/**\n * Shows or hides the specified element.\n * @param {!Element} element\n * @param {boolean=} opt_display\n */\nexport function toggle(element, opt_display) {\n  if (opt_display === undefined) {\n    opt_display = !(element.style.display != 'none');\n  }\n  element.style.display = opt_display ? '' : 'none';\n}\n\n\n/**\n * Returns a pixel value.\n * @param {number} value\n * @return {string}\n */\nexport function px(value) {\n  return value + 'px';\n}\n\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function translateX(value) {\n  if (typeof value == 'string') {\n    return `translateX(${value})`;\n  }\n  return `translateX(${px(value)})`;\n}\n\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} x\n * @param {(number|string)=} opt_y\n * @return {string}\n */\nexport function translate(x, opt_y) {\n  if (typeof x == 'number') {\n    x = px(x);\n  }\n  if (opt_y === undefined) {\n    return `translate(${x})`;\n  }\n  if (typeof opt_y == 'number') {\n    opt_y = px(opt_y);\n  }\n  return `translate(${x},${opt_y})`;\n}\n\n\n/**\n * Returns a \"scale\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function scale(value) {\n  return `scale(${value})`;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {setStyles} from './style';\n\n/**\n * Adds the given css text to the given document.\n *\n * The style tags will be at the beginning of the head before all author\n * styles. One element can be the main runtime CSS. This is guaranteed\n * to always be the first stylesheet in the doc.\n *\n * @param {!Document} doc The document that should get the new styles.\n * @param {string} cssText\n * @param {function()} cb Called when the new styles are available.\n *     Not using a promise, because this is synchronous when possible.\n *     for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n */\nexport function installStyles(doc, cssText, cb, opt_isRuntimeCss) {\n  const style = doc.createElement('style');\n  style.textContent = cssText;\n  let afterElement = null;\n  // Make sure that we place style tags after the main runtime CSS. Otherwise\n  // the order is random.\n  if (opt_isRuntimeCss) {\n    style.setAttribute('amp-runtime', '');\n  } else {\n    afterElement = doc.querySelector('style[amp-runtime]');\n  }\n  insertAfterOrAtStart(doc.head, style, afterElement);\n  // Styles aren't always available synchronously. E.g. if there is a\n  // pending style download, it will have to finish before the new\n  // style is visible.\n  // For this reason we poll until the style becomes available.\n  const done = () => {\n    const sheets = doc.styleSheets;\n    for (let i = 0; i < sheets.length; i++) {\n      const sheet = sheets[i];\n      if (sheet.ownerNode == style) {\n        return true;\n      }\n    }\n    return false;\n  };\n  // Sync case.\n  if (done()) {\n    cb();\n    return;\n  }\n  // Poll until styles are available.\n  const interval = setInterval(() => {\n    if (done()) {\n      clearInterval(interval);\n      cb();\n    }\n  }, 4);\n}\n\n/**\n * Sets the document's body opacity to 1.\n * If the body is not yet available (because our script was loaded\n * synchronously), polls until it is.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisible(doc) {\n  let interval;\n  const set = () => {\n    if (doc.body) {\n      setStyles(doc.body, {\n        opacity: 1,\n        visibility: 'visible',\n        animation: 'none'\n      });\n      clearInterval(interval);\n    }\n  };\n  interval = setInterval(set, 4);\n  set();\n}\n\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element} root\n * @param {!Element} element\n * @param {?Element} after\n */\nfunction insertAfterOrAtStart(root, element, after) {\n  if (after) {\n    if (after.nextSibling) {\n      root.insertBefore(element, after.nextSibling);\n    } else {\n      root.appendChild(element);\n    }\n  } else {\n    // Add at the start.\n    root.insertBefore(element, root.firstChild);\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Helper with all things Timer.\n */\nexport class Timer {\n\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!Promise}  */\n    this.resolved_ = Promise.resolve();\n\n    this.taskCount_ = 0;\n\n    this.canceled_ = {};\n\n    /** @const {number} */\n    this.startTime_ = this.now();\n  }\n\n  /**\n   * Returns the current EPOC time in milliseconds.\n   * @return {number}\n   */\n  now() {\n    // TODO(dvoytenko): when can we use Date.now?\n    return Number(new Date());\n  }\n\n /**\n  * Returns time since start in milliseconds.\n  * @return {number}\n  */\n  timeSinceStart() {\n    return this.now() - this.startTime_;\n  }\n\n  /**\n   * Runs the provided callback after the specified delay. This uses a micro\n   * task for 0 or no specified time. This means that the delay will actually\n   * be close to 0 and this will NOT yield to the event queue.\n   *\n   * Returns the timer ID that can be used to cancel the timer (cancel method).\n   * @param {!function()} callback\n   * @param {number=} opt_delay\n   * @return {number|string}\n   */\n  delay(callback, opt_delay) {\n    if (!opt_delay) {\n      // For a delay of zero,  schedule a promise based micro task since\n      // they are predictably fast.\n      const id = 'p' + this.taskCount_++;\n      this.resolved_.then(() => {\n        if (this.canceled_[id]) {\n          delete this.canceled_[id];\n          return;\n        }\n        callback();\n      });\n      return id;\n    }\n    return this.win.setTimeout(callback, opt_delay);\n  }\n\n  /**\n   * Cancels the previously scheduled callback.\n   * @param {number|string} timeoutId\n   */\n  cancel(timeoutId) {\n    if (typeof timeoutId == 'string') {\n      this.canceled_[timeoutId] = true;\n      return;\n    }\n    this.win.clearTimeout(timeoutId);\n  }\n\n  /**\n   * Returns a promise that will resolve after the delay. Optionally, the\n   * resolved value can be provided as opt_result argument.\n   * @param {number=} opt_delay\n   * @param {RESULT=} opt_result\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   */\n  promise(opt_delay, opt_result) {\n    let timerKey = null;\n    return new Promise((resolve, reject) => {\n      timerKey = this.delay(() => {\n        timerKey = -1;\n        resolve(opt_result);\n      }, opt_delay);\n      if (timerKey == -1) {\n        reject(new Error('Failed to schedule timer.'));\n      }\n    }).catch(error => {\n      // Clear the timer. The most likely reason is \"cancel\" signal.\n      if (timerKey != -1) {\n        this.cancel(timerKey);\n      }\n      return Promise.reject(error);\n    });\n  }\n\n  /**\n   * Returns a promise that will fail after the specified delay. Optionally,\n   * this method can take opt_racePromise parameter. In this case, the\n   * resulting promise will either fail when the specified delay expires or\n   * will resolve based on the opt_racePromise, whichever happens first.\n   * @param {number} delay\n   * @param {!Promise<RESULT>|undefined} opt_racePromise\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   */\n  timeoutPromise(delay, opt_racePromise) {\n    let timerKey = null;\n    const delayPromise = new Promise((_resolve, reject) => {\n      timerKey = this.delay(() => {\n        timerKey = -1;\n        reject('timeout');\n      }, delay);\n      if (timerKey == -1) {\n        reject(new Error('Failed to schedule timer.'));\n      }\n    }).catch(error => {\n      // Clear the timer. The most likely reason is \"cancel\" signal.\n      if (timerKey != -1) {\n        this.cancel(timerKey);\n      }\n      return Promise.reject(error);\n    });\n    if (!opt_racePromise) {\n      return delayPromise;\n    }\n    // Avoids Promise->race due to presubmit check against it.\n    return new Promise((resolve, reject) => {\n      delayPromise.then(resolve, reject);\n      opt_racePromise.then(resolve, reject);\n    });\n  }\n}\n\n\nexport const timer = new Timer(window);\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {cidFor} from './cid';\nimport {documentInfoFor} from './document-info';\nimport {getService} from './service';\nimport {userNotificationManagerFor} from './user-notification';\nimport {log} from './log';\nimport {parseUrl, removeFragment} from './url';\nimport {viewportFor} from './viewport';\nimport {vsyncFor} from './vsync';\n\n/** @private {string} */\nconst TAG_ = 'UrlReplacements';\n\n/**\n * This class replaces substitution variables with their values.\n */\nclass UrlReplacements {\n  /** @param {!Window} win */\n  constructor(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private {!RegExp|undefined} */\n    this.replacementExpr_;\n\n    /** @private @const {!Object<string, function(*):*>} */\n    this.replacements_ = this.win_.Object.create(null);\n\n    // Returns a random value for cache busters.\n    this.set_('RANDOM', () => {\n      return Math.random();\n    });\n\n    // Returns the canonical URL for this AMP document.\n    this.set_('CANONICAL_URL', () => {\n      return documentInfoFor(this.win_).canonicalUrl;\n    });\n\n    // Returns the host of the canonical URL for this AMP document.\n    this.set_('CANONICAL_HOST', () => {\n      const url = parseUrl(documentInfoFor(this.win_).canonicalUrl);\n      return url && url.hostname;\n    });\n\n    // Returns the path of the canonical URL for this AMP document.\n    this.set_('CANONICAL_PATH', () => {\n      const url = parseUrl(documentInfoFor(this.win_).canonicalUrl);\n      return url && url.pathname;\n    });\n\n    // Returns the referrer URL.\n    this.set_('DOCUMENT_REFERRER', () => {\n      return this.win_.document.referrer;\n    });\n\n    // Returns the title of this AMP document.\n    this.set_('TITLE', () => {\n      return this.win_.document.title;\n    });\n\n    // Returns the URL for this AMP document.\n    this.set_('AMPDOC_URL', () => {\n      return removeFragment(this.win_.location.href);\n    });\n\n    // Returns the host of the URL for this AMP document.\n    this.set_('AMPDOC_HOST', () => {\n      const url = parseUrl(this.win_.location.href);\n      return url && url.hostname;\n    });\n\n    // Returns a random string that will be the constant for the duration of\n    // single page view. It should have sufficient entropy to be unique for\n    // all the page views a single user is making at a time.\n    this.set_('PAGE_VIEW_ID', () => {\n      return documentInfoFor(this.win_).pageViewId;\n    });\n\n    this.set_('CLIENT_ID', (opt_name, opt_userNotificationId) => {\n      let consent = Promise.resolve();\n\n      // If no `opt_userNotificationId` argument is provided then\n      // assume consent is given by default.\n      if (opt_userNotificationId) {\n        consent = userNotificationManagerFor(this.win_).then(service => {\n          return service.get(opt_userNotificationId);\n        });\n      }\n\n      return cidFor(this.win_).then(cid => {\n        return cid.get(opt_name, consent);\n      });\n    });\n\n    // Returns the number of milliseconds since 1 Jan 1970 00:00:00 UTC.\n    this.set_('TIMESTAMP', () => {\n      return new Date().getTime();\n    });\n\n    // Returns the user's time-zone offset from UTC, in minutes.\n    this.set_('TIMEZONE', () => {\n      return new Date().getTimezoneOffset();\n    });\n\n    // Returns a promise resolving to viewport.getScrollTop.\n    this.set_('SCROLL_TOP', () => {\n      return vsyncFor(this.win_).measurePromise(\n        () => viewportFor(this.win_).getScrollTop());\n    });\n\n    // Returns a promise resolving to viewport.getScrollLeft.\n    this.set_('SCROLL_LEFT', () => {\n      return vsyncFor(this.win_).measurePromise(\n        () => viewportFor(this.win_).getScrollLeft());\n    });\n\n    // Returns a promise resolving to viewport.getScrollHeight.\n    this.set_('SCROLL_HEIGHT', () => {\n      return vsyncFor(this.win_).measurePromise(\n        () => viewportFor(this.win_).getScrollHeight());\n    });\n\n    // Returns screen.width.\n    this.set_('SCREEN_WIDTH', () => {\n      return this.win_.screen.width;\n    });\n\n    // Returns screen.height.\n    this.set_('SCREEN_HEIGHT', () => {\n      return this.win_.screen.height;\n    });\n  }\n\n  /**\n   * Sets the value resolver for the variable with the specified name. The\n   * value resolver may optionally take an extra parameter.\n   * @param {string} varName\n   * @param {function(*):*} resolver\n   * @return {!UrlReplacements}\n   * @private\n   */\n  set_(varName, resolver) {\n    this.replacements_[varName] = resolver;\n    this.replacementExpr_ = undefined;\n    return this;\n  }\n\n  /**\n   * Expands the provided URL by replacing all known variables with their\n   * resolved values. Optional `opt_bindings` can be used to add new variables\n   * or override existing ones.\n   * @param {string} url\n   * @param {!Object<string, *>=} opt_bindings\n   * @return {!Promise<string>}\n   */\n  expand(url, opt_bindings) {\n    const expr = this.getExpr_(opt_bindings);\n    let replacementPromise;\n    const encodeValue = val => {\n      // Value 0 is specialcased because the numeric 0 is a valid substitution\n      // value.\n      if (!val && val !== 0) {\n        val = '';\n      }\n      return encodeURIComponent(val);\n    };\n    url = url.replace(expr, (match, name, opt_strargs) => {\n      let args = [];\n      if (typeof opt_strargs == 'string') {\n        args = opt_strargs.split(',');\n      }\n      const val =\n          (args.length == 0 && opt_bindings && (name in opt_bindings)) ?\n          opt_bindings[name] :\n          this.replacements_[name].apply(this.replacements_, args);\n      // In case the produced value is a promise, we don't actually\n      // replace anything here, but do it again when the promise resolves.\n      if (val && val.then) {\n        const p = val.then(v => {\n          url = url.replace(match, encodeValue(v));\n        }, err => {\n          log.error(TAG_, 'Failed to expand: ' + name, err);\n        });\n        if (replacementPromise) {\n          replacementPromise = replacementPromise.then(() => p);\n        } else {\n          replacementPromise = p;\n        }\n        return match;\n      }\n      return encodeValue(val);\n    });\n\n    if (replacementPromise) {\n      replacementPromise = replacementPromise.then(() => url);\n    }\n\n    return replacementPromise || Promise.resolve(url);\n  }\n\n  /**\n   * @param {!Object<string, *>=} opt_bindings\n   * @return {!RegExp}\n   * @private\n   */\n  getExpr_(opt_bindings) {\n    const additionalKeys = opt_bindings ? Object.keys(opt_bindings) : null;\n    if (additionalKeys && additionalKeys.length > 0) {\n      const allKeys = Object.keys(this.replacements_);\n      additionalKeys.forEach(key => {\n        if (allKeys[key] === undefined) {\n          allKeys.push(key);\n        }\n      });\n      return this.buildExpr_(allKeys);\n    }\n    if (!this.replacementExpr_) {\n      this.replacementExpr_ = this.buildExpr_(Object.keys(this.replacements_));\n    }\n    return this.replacementExpr_;\n  }\n\n  /**\n   * @param {!Array<string>} keys\n   * @return {!RegExp}\n   * @private\n   */\n  buildExpr_(keys) {\n    const all = keys.join('|');\n    // Match the given replacement patterns, as well as optionally\n    // arguments to the replacement behind it in parantheses.\n    // Example string that match\n    // FOO_BAR\n    // FOO_BAR(arg1)\n    // FOO_BAR(arg1,arg2)\n    return new RegExp('\\\\$?(' + all + ')(?:\\\\(([0-9a-zA-Z-_,]+)\\\\))?', 'g');\n  }\n}\n\n/**\n * @param {!Window} window\n * @return {!UrlReplacements}\n */\nexport function urlReplacementsFor(window) {\n  return getService(window, 'url-replace', () => {\n    return new UrlReplacements(window);\n  });\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assert} from './asserts';\n\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * @param {string} url\n * @return {!Location}\n */\nexport function parseUrl(url) {\n  const a = document.createElement('a');\n  a.href = url;\n  const info = {\n    href: a.href,\n    protocol: a.protocol,\n    host: a.host,\n    hostname: a.hostname,\n    port: a.port == '0' ? '' : a.port,\n    pathname: a.pathname,\n    search: a.search,\n    hash: a.hash\n  };\n  // For data URI a.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n  info.origin = (a.origin && a.origin != 'null') ? a.origin : getOrigin(info);\n  assert(info.origin, 'Origin must exist');\n  return info;\n}\n\n\n/**\n * Asserts that a given url is HTTPS or protocol relative.\n * Provides an exception for localhost.\n * @param {string} urlString\n * @param {!Element} elementContext Element where the url was found.\n * @return {string}\n */\nexport function assertHttpsUrl(urlString, elementContext) {\n  const url = parseUrl(urlString);\n  assert(\n      url.protocol == 'https:' || /^(\\/\\/)/.test(urlString) ||\n      url.hostname == 'localhost' ||\n          url.hostname.lastIndexOf('.localhost') ==\n          // Poor person's endsWith\n          url.hostname.length - '.localhost'.length,\n      '%s source must start with ' +\n      '\"https://\" or \"//\" or be relative and served from ' +\n      'either https or from localhost. Invalid value: %s',\n      elementContext, urlString);\n  return urlString;\n}\n\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n * @param {string} queryString\n * @return {!Object<string, string>}\n */\nexport function parseQueryString(queryString) {\n  const params = Object.create(null);\n  if (!queryString) {\n    return params;\n  }\n  if (queryString.indexOf('?') == 0 || queryString.indexOf('#') == 0) {\n    queryString = queryString.substr(1);\n  }\n  const pairs = queryString.split('&');\n  for (let i = 0; i < pairs.length; i++) {\n    const pair = pairs[i];\n    const eqIndex = pair.indexOf('=');\n    let name;\n    let value;\n    if (eqIndex != -1) {\n      name = decodeURIComponent(pair.substring(0, eqIndex)).trim();\n      value = decodeURIComponent(pair.substring(eqIndex + 1)).trim();\n    } else {\n      name = decodeURIComponent(pair).trim();\n      value = '';\n    }\n    if (name) {\n      params[name] = value;\n    }\n  }\n  return params;\n}\n\n\n/**\n * Don't use this directly, only exported for testing. The value\n * is available via the origin property of the object returned by\n * parseUrl.\n * @param {!Location} info\n * @return {string}\n * @visibleForTesting\n */\nexport function getOrigin(info) {\n  if (info.protocol == 'data:' || !info.host) {\n    return info.href;\n  }\n  return info.protocol + '//' + info.host;\n}\n\n\n/**\n * Returns the URL without fragment. If URL doesn't contain fragment, the same\n * string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function removeFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return url;\n  }\n  return url.substring(0, index);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Factory for amp-user-notification\n */\n\nimport {getElementService} from './service';\n\n\n/**\n * @param {!Window} window\n * @return {!Promise<!UserNotification>}\n */\nexport function userNotificationManagerFor(window) {\n  return getElementService(window, 'userNotificationManager',\n      'amp-user-notification');\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getService} from './service';\n\n\n/**\n * @param {!Window} window\n * @return {!Viewer}\n */\nexport function viewerFor(window) {\n  return getService(window, 'viewer');\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getService} from './service';\n\n/**\n * @param {!Window} window\n * @return {!Viewport}\n */\nexport function viewportFor(window) {\n  return getService(window, 'viewport');\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getService} from './service';\n\n\n/**\n * @param {!Window} window\n * @return {!Vsync}\n */\nexport function vsyncFor(window) {\n  return getService(window, 'vsync');\n};\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assert} from './asserts';\nimport {getService} from './service';\n\n\n/**\n * The \"init\" argument of the Fetch API. Currently, only \"credentials: include\"\n * is implemented.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n *\n * @typedef {{\n *   body: (!Object|!Array|undefined),\n *   credentials: (string|undefined),\n *   headers: (!Object|undefined),\n *   method: (string|undefined)\n * }}\n */\nlet FetchInitDef;\n\n/** @private @const {!Array<string>} */\nconst allowedMethods_ = ['GET', 'POST'];\n\n/** @private @const {!Array<string>} */\nconst allowedBodyTypes_ = ['[object Object]', '[object Array]'];\n\n\n/**\n * A service that polyfills Fetch API for use within AMP.\n */\nclass Xhr {\n\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /**\n     * We want to call `fetch_` unbound from any context since it could\n     * be either the native fetch or our polyfill.\n     * @private @const {function(string, ?FetchInitDef=):!Promise<!FetchResponse>}\n     */\n    this.fetch_ = (win.fetch || fetchPolyfill).bind(null);\n  }\n\n  /**\n   * Fetches and constructs JSON object based on the fetch polyfill.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * @param {string} input\n   * @param {?FetchInitDef=} opt_init\n   * @return {!Promise<!JSONValue>}\n   */\n  fetchJson(input, opt_init) {\n    const init = opt_init || {};\n    init.method = normalizeMethod_(init.method);\n    setupJson_(init);\n\n    return this.fetch_(input, init).then(response => {\n      return assertSuccess(response).json();\n    });\n  }\n\n  /**\n   * Sends the request, awaits result and confirms that it was successful.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * @param {string} input\n   * @param {?FetchInitDef=} opt_init\n   * @return {!Promise}\n   */\n  sendSignal(input, opt_init) {\n    return this.fetch_(input, opt_init).then(response => {\n      assertSuccess(response);\n    });\n  }\n}\n\n\n/**\n * Normalized method name by uppercasing.\n * @param {string|undefined} method\n * @return {string}\n * @private\n */\nexport function normalizeMethod_(method) {\n  if (method === undefined) {\n    return 'GET';\n  }\n  return method.toUpperCase();\n}\n\n/**\n* Initialize init object with headers and stringifies the body.\n * @param {!FetchInitDef} init\n * @private\n */\nfunction setupJson_(init) {\n  assert(allowedMethods_.indexOf(init.method) != -1, 'Only one of ' +\n      allowedMethods_.join(', ') + ' is currently allowed. Got %s',\n      init.method);\n\n  init.headers = {\n    'Accept': 'application/json'\n  };\n\n  if (init.method == 'POST') {\n    const bodyType = Object.prototype.toString.call(init.body);\n\n    // Assume JSON strict mode where only objects or arrays are allowed\n    // as body.\n    assert(allowedBodyTypes_.indexOf(bodyType) > -1,\n        'body must be of type object or array. %s',\n        init.body);\n\n    init.headers['Content-Type'] = 'application/json;charset=utf-8';\n    init.body = JSON.stringify(init.body);\n  }\n}\n\n\n/**\n * A minimal polyfill of Fetch API. It only polyfills what we currently use.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n *\n * Notice that the \"fetch\" method itself is not exported as that would require\n * us to immediately support a much wide API.\n *\n * @param {string} input\n * @param {!FetchInitDef=} opt_init\n * @return {!Promise<!FetchResponse>}\n * @private Visible for testing\n */\nexport function fetchPolyfill(input, opt_init) {\n  assert(typeof input == 'string', 'Only URL supported: %s', input);\n  const init = opt_init || {};\n  assert(!init.credentials || init.credentials == 'include',\n      'Only credentials=include support: %s', init.credentials);\n\n  return new Promise(function(resolve, reject) {\n    const xhr = createXhrRequest(init.method || 'GET', input, init);\n\n    if (init.credentials == 'include') {\n      xhr.withCredentials = true;\n    }\n\n    xhr.onreadystatechange = () => {\n      if (xhr.readyState < /* STATUS_RECEIVED */ 2) {\n        return;\n      }\n      if (xhr.status < 100 || xhr.status > 599) {\n        xhr.onreadystatechange = null;\n        reject(new Error(`Unknown HTTP status ${xhr.status}`));\n        return;\n      }\n\n      // TODO(dvoytenko): This is currently simplified: we will wait for the\n      // whole document loading to complete. This is fine for the use cases\n      // we have now, but may need to be reimplemented later.\n      if (xhr.readyState == /* COMPLETE */ 4) {\n        resolve(new FetchResponse(xhr));\n      }\n    };\n    xhr.onerror = () => {\n      reject(new Error('Network failure'));\n    };\n    xhr.onabort = () => {\n      reject(new Error('Request aborted'));\n    };\n\n    if (init.method == 'POST') {\n      xhr.send(init.body);\n    } else {\n      xhr.send();\n    }\n  });\n}\n\n\n/**\n * @param {string} method\n * @param {string} url\n * @param {!FetchInitDef} init\n * @return {!XMLHttpRequest}\n * @private\n */\nfunction createXhrRequest(method, url, init) {\n  let xhr = new XMLHttpRequest();\n  if ('withCredentials' in xhr) {\n    xhr.open(method, url, true);\n  } else if (typeof XDomainRequest != 'undefined') {\n    // IE-specific object.\n    xhr = new XDomainRequest();\n    xhr.open(method, url);\n  } else {\n    throw new Error('CORS is not supported');\n  }\n\n  if (init.headers) {\n    Object.keys(init.headers).forEach(function(header) {\n      xhr.setRequestHeader(header, init.headers[header]);\n    });\n  }\n  return xhr;\n}\n\n\n/**\n * Returns the response if successful or otherwise throws an error.\n * @paran {!FetchResponse} response\n * @return {!FetchResponse}\n */\nfunction assertSuccess(response) {\n  if (response.status < 200 || response.status > 299) {\n    throw new Error(`HTTP error ${response.status}`);\n  }\n  return response;\n}\n\n\n/**\n * Response object in the Fetch API.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n */\nclass FetchResponse {\n  /**\n   * @param {!XMLHttpRequest} xhr\n   */\n  constructor(xhr) {\n    /** @private @const {!XMLHttpRequest} */\n    this.xhr_ = xhr;\n\n    /** @type {number} */\n    this.status = this.xhr_.status;\n\n    /** @type {boolean} */\n    this.bodyUsed = false;\n  }\n\n  /**\n   * Drains the response and returns the text.\n   * @return {!Promise<string>}\n   * @private\n   */\n  drainText_() {\n    assert(!this.bodyUsed, 'Body already used');\n    this.bodyUsed = true;\n    return Promise.resolve(this.xhr_.responseText);\n  }\n\n  /**\n   * Drains the response and returns the JSON object.\n   * @return {!Promise<!JSONValue>}\n   */\n  json() {\n    return this.drainText_().then(JSON.parse);\n  }\n}\n\n\n/**\n * @param {!Window} window\n * @return {!Xhr}\n */\nexport function xhrFor(window) {\n  return getService(window, 'xhr', () => {\n    return new Xhr(window);\n  });\n};\n"]}